define("jira/ajs/select/suggestion-collection-model",["jira/ajs/control","jira/ajs/list/group-descriptor","jira/ajs/list/item-descriptor","jquery","underscore"],function(e,t,s,i,r){"use strict";return e.extend({init:function(e){e.element?e.element=i(e.element):e.element=i(e),this._setOptions(e),this.$element=this.options.element.hide(),this.type=this.$element.attr("data-multiple")?"multiple":"single",this.id=this.$element.attr("id")||this.$element.attr("name"),this.$optionsContainer=this.$element.siblings("#"+this.id+"-options"),this.selectedDescriptors=[],this.groupFilter=!1,this._parseDescriptors()},_getDefaultOptions:function(){return{}},_setValue:function(){var e=this.selectedDescriptors.map(function(e){return e.value()});this.$element.val(e.join(","))},getSelectedValues:function(){for(var e=[],t=0;t<this.selectedDescriptors.length;t++)e.push(this.selectedDescriptors[t].value());return e},setSelected:function(e,t){t=void 0===t||t,e=this._descriptor(e);var s=r.filter(this.getAllDescriptors(!1),function(t){return t.value()===e.value()});if(0===s.length)return!1;if("single"===this.type){if(e.value()===this.getValue())return!0;this.setAllUnSelected(),s=s.slice(0,1)}else s=r.filter(s,function(e){return!0!==e.selected()});return Array.prototype.push.apply(this.selectedDescriptors,s),r.each(s,function(e){e.selected(!0)}),this._setValue(),e.highlighted(!1),t&&this.$element.trigger("change",e),!0},setAllSelected:function(){var e=this;i(this.getDisplayableUnSelectedDescriptors()).each(function(){e.setSelected(this)})},setAllUnSelected:function(){r.each(this.selectedDescriptors,function(e){e.selected(!1)}),this.selectedDescriptors=[],this._setValue()},setUnSelected:function(e){e=this._descriptor(e);for(var t=0;t<this.selectedDescriptors.length;t++)this.selectedDescriptors[t].value()===e.value()&&(this.selectedDescriptors[t].selected(!1),this.selectedDescriptors.splice(t,1),t--);this._setValue()},remove:function(e){e=this._descriptor(e);for(var s=0;s<this.descriptors.length;s++)if(this.descriptors[s]instanceof t)for(var i=0;i<this.descriptors[s].items().length;i++)this.descriptors[s].items()[i].value()===e.value()&&(this.descriptors[s].items().splice(i,1),i--);else this.descriptors[s].value()===e.value()&&(this.descriptors.splice(s,1),s--)},getDescriptor:function(e){var t;return e=i.trim(e.toLowerCase()),i.each(this.getAllDescriptors(!1),function(s,r){if(e===i.trim(r.label().toLowerCase())||e===i.trim(r.value().toLowerCase()))return t=r,!1}),t},_buildItemDescriptor:function(e){var t=new s(e);return!0===t.selected()&&("single"===this.type&&this.selectedDescriptors.length>0?t.selected(!1):this.selectedDescriptors.push(t)),t},_parseDescriptors:function(){var e,s,i=this.$optionsContainer.data("suggestions")||[];if(this.descriptors=[],"string"==typeof i)try{i=JSON.parse(i),this.$optionsContainer.data("suggestions",i)}catch(e){i=[]}for(var r=0;r<i.length;r++)if(void 0!==i[r].items){e=new t({label:i[r].label}),s=i[r].items;for(var n=0;n<s.length;n++)e.addItem(this._buildItemDescriptor(s[n]));this.descriptors.push(e)}else this.descriptors.push(this._buildItemDescriptor(i[r]));this._setValue()},getPlaceholder:function(){return this.placeholder},getValue:function(){return this.$element.val()},getDisplayableSelectedDescriptors:function(){return this.selectedDescriptors.slice()},getDisplayableUnSelectedDescriptors:function(){return r.filter(this.getAllDescriptors(!1),function(e){return-1===this.selectedDescriptors.indexOf(e)}.bind(this))},getAllDescriptors:function(e){var s,i=[];if(!1!==this.groupFilter)for(s in this.descriptors)this.descriptors[s]instanceof t&&this.descriptors[s].label()==this.groupFilter&&(i=this.descriptors[s].items().slice());else if(!1===e)for(s in this.descriptors)this.descriptors[s]instanceof t?i=i.concat(this.descriptors[s].items()):this.descriptors.hasOwnProperty(s)&&i.push(this.descriptors[s]);else i=this.descriptors.slice();return i},clearUnSelected:function(){var e=this;this.descriptors=r.filter(this.descriptors,function(s){return s instanceof t?(s.items(r.filter(s.items(),function(t){return-1!==e.selectedDescriptors.indexOf(t)})),!0):-1!==e.selectedDescriptors.indexOf(s)})},getUnSelectedDescriptors:function(){for(var e=this,s=[],i={},n={},l=function(e){var t=e.value().toLowerCase();return!(n[t]&&(!i[t]||!1!==e.allowDuplicate()))&&(i[t]=!0,!0)},o=0;o<this.selectedDescriptors.length;o++)n[this.selectedDescriptors[o].value().toLowerCase()]=!0;return r.each(this.descriptors,function(i){var n;i instanceof t?!1===e.groupFilter?(n=r.clone(i.allProperties()),n.items=r.filter(i.items(),l),s.push(new t(n))):e.groupFilter===i.label()&&(s=s.concat(r.filter(i.items(),l))):!1===e.groupFilter&&l(i)&&s.push(i)}),s},setFilterGroup:function(e){for(var s=0;s<this.descriptors.length;s++)if(this.descriptors[s]instanceof t&&this.descriptors[s].label()===e)return this.groupFilter=e,!0;return!1},clearFilterGroup:function(){this.groupFilter=!1},_descriptor:function(e){return"string"==typeof e&&(e=new s({value:e,label:e})),e}})});