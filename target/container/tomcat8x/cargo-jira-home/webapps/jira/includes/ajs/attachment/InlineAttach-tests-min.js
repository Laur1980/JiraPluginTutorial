AJS.test.require(["jira.webresources:inline-attach"],function(){var e=require("jquery"),t=require("jira/lib/class"),r=require("jira/attachment/inline-attach"),a=require("jira/util/formatter"),o=function(t){for(var r=e(t).find("*").toArray(),a=1;a<arguments.length;a++){var o=arguments[a];if(o&&o.get&&(o=o.get(0)||o),!e.inArray(o,r)<0)return!1}return!0},l=function(e,t){this.name=e,this.size=t,this.toSimple=function(){return{name:e,size:t,file:this}}},n=function(){return 0===arguments.length?void 0:1===arguments.length?arguments[0]:Array.prototype.slice.call(arguments).join(",")},u={tr:function(){if(0!==arguments.length){if(1===arguments.length)return arguments[0];for(var e=Array.prototype.slice.call(arguments),t=0;t<e.length;t++)"number"==typeof e[t]&&(e[t]=e[t].toFixed(4));return e.join(",")}},currentOutOfTotalSize:function(e,t){return e+"/"+t},time:function(e){return e},rate:function(e){return e},fileSize:function(){return 0===arguments.length?void 0:1===arguments.length?arguments[0]:Array.prototype.slice.call(arguments)}},s=function(){this.hidden=!0,this.started=!1,this.removed=!1,this.onCancel=function(e){return this.cancel=e,this},this.triggerCancel=function(){return this.cancel.call(this),this},this.toString=function(){return"MockStaticProgress["+JSON.stringify(this)+"]"},this.show=function(){return this.hidden=!1,this},this.start=function(){return this.started=!0,this},this.remove=function(){return this.removed=!0,this}},i=function(e){this.file=e,this.hidden=!0,this.value=1/0,this.started=!1,this.finished=!1,this.removed=!1,this.hide=function(){return this.hidden=!0,this},this.show=function(){return this.hidden=!1,this},this.start=function(){return this.started=!0,this},this.update=function(e){return this.value=e,this},this.onCancel=function(e){return this.cancel=e,this},this.triggerCancel=function(){return this.cancel.call(this),this},this.finish=function(){return this.finished=!0,this},this.remove=function(){return this.removed=!0,this},this.toString=function(){return"MockProgress["+JSON.stringify(this)+"]"}},c=function(e,t){this.$element=this.element=e,this.multiple=t,this.onChange=function(e){this.change=e},this.focus=h(this),this.clear=h(this),this.cloneInput=h(function(){return{count:this.cloneInput.count,cloneInput:!0}})},d=function(e){this.nextToken=33737,this.formToken="form-token",this.errors=[],this.fileNames=[],this.fileSelector=e,this.maxSize=1e3,this.disabled=!1,this.progress=[],this.lastReplace=null,this.lastInput=null,this.onCancel=function(e){return this.cancel=e,this},this.addError=function(e,t){return this.errors.push(e),this.lastReplace=t,this},this.addErrorWithFileName=function(e,t,r){this.errors.push(e+"|"+t),this.lastReplace=r},this.clearErrors=h(function(){return this.errors=[],this}),this.getAtlToken=function(){return this.nextToken++},this.setAtlToken=function(e){return this.lastToken=e,this},this.getFormToken=function(){return this.formToken},this.disable=function(){return this.disabled=!0,this},this.enable=function(){return this.disabled=!1,this},this.addProgress=function(e){var t=new i(e);return this.progress.push(t),t},this.addStaticProgress=function(e){var t=new s(e);return this.progress.push(t),t},this.addTemporaryFileCheckbox=h(this),this.cloneFileInput=function(){return this.fileSelector.cloneInput()}},p=function(e){return function(){ok(!1,"Should not be calling "+e+".")}},h=function(e){var t=function(){var t=arguments.callee;return t.lastScope=this,t.lastArgs=Array.prototype.slice.call(arguments),t.count++,e&&e.apply?e.apply(this,arguments):e};return t.count=0,t},f=1024,m=1048576,q=1024*m;module("Text",{setup:function(){this.tr=r.Text.tr},teardown:function(){r.Text.tr=this.tr}}),test("Test Translate No Key",function(){equal(r.Text.tr(),void 0,"Return undefined on no key.")}),test("Test Translate No Args",function(){equal(r.Text.tr("upload.cancel"),"common.words.cancel","Return the translation."),equal(r.Text.tr("doesnotexist.12627"),"doesnotexist.12627","Return the key.")}),test("Test Translate Args",function(){this.stub(a,"format"),r.Text.tr("upload.bytes.per.second",5),sinon.assert.calledWith(a.format,"upload.bytes.per.second",5),equal(r.Text.tr("doesnotexist.12627",5),"doesnotexist.12627","Return the key.")}),test("Test for fileSize No args",function(){equal(r.Text.fileSize(),void 0,"Return undefined on no arguments.")}),test("Test for fileSize Single Arg",function(){r.Text.tr=n;var t=e.proxy(r.Text.fileSize,r.Text);equal(t(0),n("upload.kilobyte",0),"0 should return as kB with no decimal places."),equal(t(512),n("upload.kilobyte","0.50"),"Return a 1/2 kB"),equal(t(1024),n("upload.kilobyte","1.00"),"Return a 1 kB"),equal(t(10496),n("upload.kilobyte","10.25"),"Return a 10.25 kB"),equal(t(Math.floor(.995*m)),n("upload.kilobyte","1018.88"),"Return a 1018.88 kB"),equal(t(Math.ceil(.995*m)),n("upload.megabyte","1.00"),"Return a 1 MB because of rounding."),equal(t(2.5*m),n("upload.megabyte","2.50"),"Return a 2.5 MB."),equal(t(Math.floor(.995*q)),n("upload.megabyte","1018.88"),"Return a 1018.88 MB."),equal(t(Math.ceil(.995*q)),n("upload.gigabyte","1.00"),"Return a 1.0 GB."),equal(t(3.5*q),n("upload.gigabyte","3.50"),"Return a 3.5 GB."),equal(t(1024*q),n("upload.gigabyte","1024.00"),"Return a 1024 GB.")}),test("Test for fileSize Multiple Arg",function(){r.Text.tr=n;var t=e.proxy(r.Text.fileSize,r.Text);deepEqual(t(0,m),[n("upload.kilobyte","0"),n("upload.kilobyte","1024.00")],"[0, 1024kb] should be returned."),deepEqual(t(512,2*m),[n("upload.kilobyte","0.50"),n("upload.kilobyte","2048.00")],"[0.50kB, 2048.00kB]"),deepEqual(t(1024,2.5*m),[n("upload.kilobyte","1.00"),n("upload.kilobyte","2560.00")],"[1kB, 2560kB]"),deepEqual(t(10496,10240,5120),[n("upload.kilobyte","10.25"),n("upload.kilobyte","10.00"),n("upload.kilobyte","5.00")],"[10.25kB, 10.00kB, 5.00kB]"),deepEqual(t(Math.floor(.995*m),686080,56*m),[n("upload.kilobyte","1018.88"),n("upload.kilobyte","670.00"),n("upload.kilobyte","57344.00")],"[1018.88kB, 670kB, 57344kB]"),deepEqual(t(Math.ceil(.995*m),524288,1),[n("upload.megabyte","1.00"),n("upload.megabyte","0.50"),n("upload.megabyte","0")],"[1.00 MB, 0.50 MB, 0]"),deepEqual(t(2.5*m,q,10240),[n("upload.megabyte","2.50"),n("upload.megabyte","1024.00"),n("upload.megabyte","0.01")],"[2.50MB, 1024.00MB, 0.01MB]"),deepEqual(t(Math.floor(.995*q),q,0),[n("upload.megabyte","1018.88"),n("upload.megabyte","1024.00"),n("upload.megabyte","0")],"[1018.88 MB, 1024MB, 0]"),deepEqual(t(Math.ceil(.995*q),.5*q,.25*q),[n("upload.gigabyte","1.00"),n("upload.gigabyte","0.50"),n("upload.gigabyte","0.25")],"[1GB, 0.5GB, 0.25GB]"),deepEqual(t(3.5*q,5*m,6*m),[n("upload.gigabyte","3.50"),n("upload.gigabyte","0"),n("upload.gigabyte","0.01")],"[3.5GB, 0GB, 0.01GB]"),deepEqual(t(1024*q,50*m,57578*q,57578*m),[n("upload.gigabyte","1024.00"),n("upload.gigabyte","0.05"),n("upload.gigabyte","57578.00"),n("upload.gigabyte","56.23")],"[1024GB, 0.05GB, 57578.00GB, 56.23GB]")}),test("Test for currentOutOfTotalSize",function(){r.Text.tr=n;var t=e.proxy(r.Text.currentOutOfTotalSize,r.Text);equal(t(0,0),n("upload.kilobyte.part","0","0"),"0/0 kb."),equal(t(5,.5*m),n("upload.kilobyte.part","0","512.00"),"0/512.00 kb."),equal(t(6,.5*m),n("upload.kilobyte.part","0.01","512.00"),"0.01/512.00 kb."),equal(t(f,Math.floor(.995*m)),n("upload.kilobyte.part","1.00","1018.88"),"0.01/1018.88 kb."),equal(t(5120,Math.ceil(.995*m)),"upload.megabyte.part,0,1.00","0/1.00 MB."),equal(t(6144,Math.ceil(.995*m)),n("upload.megabyte.part","0.01","1.00"),"0.01/1.00 MB."),equal(t(.5*m,Math.floor(.995*q)),n("upload.megabyte.part","0.50","1018.88"),"0.5/1018.88 MB."),equal(t(5*m,Math.ceil(.995*q)),"upload.gigabyte.part,0,1.00","0/1GB."),equal(t(6*m,Math.ceil(.995*q)),n("upload.gigabyte.part","0.01","1.00"),"0.01/1GB."),equal(t(8.5*q,9*q),n("upload.gigabyte.part","8.50","9.00"),"8.5/9GB."),equal(t(8.5*q,1055*q),n("upload.gigabyte.part","8.50","1055.00"),"8.5/1055GB.")}),test("Test for Text.rate",function(){r.Text.tr=n;var t=e.proxy(r.Text.rate,r.Text);equal(t(0),n("upload.bytes.per.second","0"),"0 B/sec"),equal(t(512),n("upload.bytes.per.second","512.00"),"512 B/sec"),equal(t(Math.floor(1018.88)),n("upload.bytes.per.second","1018.00"),"1018.00 B/sec"),equal(t(Math.ceil(1018.88)),n("upload.kilobytes.per.second","1.00"),"1.00 kB/sec"),equal(t(3840),n("upload.kilobytes.per.second","3.75"),"3.75 kB/sec"),equal(t(Math.floor(.995*m)),n("upload.kilobytes.per.second","1018.88"),"1018.88 kB/sec"),equal(t(Math.ceil(.995*m)),n("upload.megabytes.per.second","1.00"),"1.00 MB/sec"),equal(t(5505024),n("upload.megabytes.per.second","5.25"),"5.25 MB/sec"),equal(t(1025*m),n("upload.megabytes.per.second","1025.00"),"1025.00 MB/sec")}),test("Test for Text.time",function(){r.Text.tr=n;var t=e.proxy(r.Text.time,r.Text);equal(t(0),n("upload.seconds","0"),"0 sec"),equal(t(45),n("upload.seconds","45"),"45 sec"),equal(t(59),n("upload.seconds","59"),"59 sec"),equal(t(60),n("upload.minutes","1"),"1 min"),equal(t(1800),n("upload.minutes","30"),"30 min"),equal(t(3540),n("upload.minutes","59"),"59 min"),equal(t(3600),n("upload.hours","1"),"1hr"),equal(t(3660),n("upload.hours.minutes","1","1"),"1hr 1 min"),equal(t(3615),n("upload.hours","1"),"1.0004hr"),equal(t(3900),n("upload.hours.minutes","1","5"),"1hr 5 min"),equal(t(7140),n("upload.hours.minutes","1","59"),"1hr 59 min"),equal(t(7200),n("upload.hours","2"),"2hr"),equal(t(7260),n("upload.hours.minutes","2","1"),"2hr 1 min"),equal(t(60*(60+70.234)),n("upload.hours.minutes","2","10"),"2hr 10min")}),module("Timer"),test("Test for Timer.schedule no scope",function(){var e,t,a,o=0,l=!1,n=!1,u=function(r,a){return e=r,t=a,++o},s=function(){n=!0},i=function(){l=!0,a=this},c=new r.Timer(i);c._startTimeout=u,c.cancel=s,ok(!c.timeoutId,"No Timeout"),equal(c.schedule(16),c,"Return the timer"),equal(16,t,"Correct Timeout"),equal(c.timeoutId,1,"Correct Id"),e.call(window),ok(!c.timeoutId,"Timer destroyed"),ok(l,"Callback should be called."),ok(n,"Cancel was called."),equal(c,a,"Is the scope correctly set.")}),test("Test for Timer.schedule scope",function(){var e,t,a,o=0,l=!1,n={},u=function(r,a){return e=r,t=a,++o},s=function(){l=!0,a=this},i=new r.Timer(s,n);i._startTimeout=u,ok(!i.timeoutId,"No Timeout"),equal(i.schedule(678),i,"Return the timer"),equal(678,t,"Correct Timeout"),equal(i.timeoutId,1,"Correct Id"),e.call(window),ok(!i.timeoutId,"Timer destroyed"),ok(l,"Callback should be called."),equal(n,a,"Is the scope correctly set.")}),test("Test for Timer.schedule double schedule",function(){var e=0,t=function(){return++e},a=function(e){equal(1,e,"Cancel called with the correct id.")},o=new r.Timer;o._startTimeout=t,o._endTimeout=a,ok(!o.timeoutId,"No Timeout"),equal(o.schedule(678),o,"Return the timer"),equal(o.timeoutId,1,"Correct Id"),equal(o.schedule(56),o,"This should cancel the timer."),equal(o.timeoutId,2,"Correct Id")}),module("AjaxUpload",{setup:function(){this.rescope=r.rescope,this.xhr=r.AjaxUpload.xhr,this._xhrJquery=r.AjaxUpload._xhrJquery,this._xhrDirect=r.AjaxUpload._xhrDirect,this.apisupport=r.AjaxUpload._fileApiSupport,this.xhrsupport=r.AjaxUpload._xhrSupport,this.text=r.Text,r.Text=u},teardown:function(){r.rescope=this.rescope,r.AjaxUpload.xhr=this.xhr,r.AjaxUpload._xhrJquery=this._xhrJquery,r.AjaxUpload._xhrDirect=this._xhrDirect,r.AjaxUpload._fileApiSupport=this.apisupport,r.AjaxUpload._xhrSupport=this.xhrsupport,r.Text=this.text}});var g=t.extend({init:function(e){this.throwdata=e||null,this.headers={},this.upload={},this.aborted=!1},open:function(e,t,r){this.method=e,this.url=t,this.async=r},setRequestHeader:function(e,t){this.headers[e]=t},send:function(e){if(this.data=e,this.throwdata)throw this.throwdata},abort:function(){this.aborted=!0}});test("xhr constructor",function(){var e=r.AjaxUpload.xhr;r.AjaxUpload._xhrJquery=function(){return null},r.AjaxUpload._xhrDirect=function(){return 1},equal(1,e(),"Should used direct"),equal(r.AjaxUpload._xhrDirect,r.AjaxUpload.xhr,"Updated the function.");var t=function(){return 2};r.AjaxUpload._xhrJquery=function(){return t},equal(2,e(),"Should use jQuery"),equal(t,r.AjaxUpload.xhr,"Updated the function.")}),test("isSupported",function(){var e=r.AjaxUpload.isSupported;r.AjaxUpload._fileApiSupport=h(!1),r.AjaxUpload._xhrSupport=p("_xhrSupport"),equal(!1,e(),"No File Api Support"),r.AjaxUpload._fileApiSupport=h(!0),r.AjaxUpload._xhrSupport=h(!1),equal(!1,e(),"No xhr.upload."),r.AjaxUpload._xhrSupport=h(!0),equal(!0,e(),"Has support")}),test("_xhrSupport",function(){var e=r.AjaxUpload._xhrSupport;r.AjaxUpload.xhr=function(){return null},equal(!1,e(),"No xhr."),r.AjaxUpload.xhr=function(){return{}},equal(!1,e(),"No xhr.upload."),r.AjaxUpload.xhr=function(){throw"Exception"},equal(!1,e(),"No xhr error is not supported."),r.AjaxUpload.xhr=function(){return{upload:!0}},equal(!0,e(),"No xhr with xhr.upload is supported.")}),test("test constructor",function(){var e=r.AjaxUpload,t={test:!0},a={scope:!0};r.rescope=function(e,t){return deepEqual(a,t,"Correct scope?"),e+1};var o=new e({scope:a,file:"file",url:"url",params:t,progress:"progress",error:"error",success:"success",abort:"abort",after:"after",before:"before"});equal("file",o.file,"File correctly set."),equal("url",o.url,"URL correctly set."),deepEqual(t,o.params,"Params correctly set."),equal("progress1",o.progresscb,"Progress correctly set."),equal("error1",o.errorcb,"Error correctly set."),equal("success1",o.successcb,"Success correctly set."),equal("abort1",o.abortcb,"Abort correctly set."),equal("after1",o.finalcb,"Final correctly set."),equal("before1",o.beforecb,"Before correctly set."),equal(!1,o.aborted,"Aborted correctly set."),r.rescope=function(e,t){return equal(null,t,"Correct scope for "+e+"?"),e+2},o=new e({file:"file",url:"url",progress:"progress",error:"error",success:"success",abort:"abort",after:"after",before:"before"}),equal("file",o.file,"File correctly set."),equal("url",o.url,"URL correctly set."),deepEqual({},o.params,"Params correctly set."),equal("progress2",o.progresscb,"Progress correctly set."),equal("error2",o.errorcb,"Error correctly set."),equal("success2",o.successcb,"Success correctly set."),equal("abort2",o.abortcb,"Abort correctly set."),equal("after2",o.finalcb,"Final correctly set."),equal("before2",o.beforecb,"Before correctly set."),equal(!1,o.aborted,"Aborted correctly set.")}),test("upload not aborted",function(){var e=r.AjaxUpload,t=new g;r.AjaxUpload.xhr=function(){return t};var a=0,o={type:"type"},l=new e({url:"url",params:{test:!0},file:o,before:function(){a++}}),n=0,u=l._statechange=function(){++n,equal(l,this,"Correct scope for on state change?")},s=0,i=l._upload=function(){s++,equal(l,this,"Correct scope for upload?")};l.upload(),equal(1,a,"Before should have been called."),equal("POST",t.method,"Posting?"),equal("url?test=true",t.url,"Correct url?"),equal(!0,t.async,"Asynchronous?"),deepEqual({"Content-Type":"type"},t.headers,"Content type set?"),equal(o,t.data,"File being sent?"),equal(0,n,"statechange not called yet."),t.onreadystatechange(),equal(1,n,"statechange not called."),equal(0,s,"upload not called yet."),t.upload.onprogress(),equal(1,s,"upload not called."),t=new g,r.AjaxUpload.xhr=function(){return t},o={blarg:"type"},l=new e({url:"url",file:o}),l._statechange=u,l._upload=i,l.upload(),equal("POST",t.method,"Posting?"),equal("url",t.url,"Correct url?"),equal(!0,t.async,"Asynchronous?"),deepEqual({"Content-Type":"application/octet-stream"},t.headers,"Content type set?"),equal(o,t.data,"File being sent?"),equal(1,n,"statechange not called yet."),t.onreadystatechange(),equal(2,n,"statechange not called."),equal(1,s,"upload not called yet."),t.upload.onprogress(),equal(2,s,"upload not called.")}),test("abort not uploading",function(){var e=r.AjaxUpload;r.AjaxUpload.xhr=function(){ok(!1,"Should not be creating the XHR if its aborted.")};var t=!1,a=!1,o=new e({url:"url",file:"file",abort:function(){ok(!t,"First call in abort?."),ok(!a,"Abort called before final."),t=!0},after:function(){ok(!a,"Final call in after?."),ok(t,"Abort not called before final."),a=!0},progress:p("progess"),error:p("error"),success:p("success"),before:p("before")});ok(!o.aborted,"Not aborted initially."),o.abort(),ok(o.aborted,"Aborted?."),ok(t&&a,"Correct callbacks called."),o.abort(),ok(o.aborted,"Still Aborted?.")}),test("progess",function(){var e=r.AjaxUpload,t=new g;r.AjaxUpload.xhr=function(){return t};var a=0,o=0,l=new e({url:"url",file:"file",abort:p("abort"),after:p("after"),progress:function(e){a++,o=e},error:p("error"),success:p("success"),before:p("before")});equal(0,a,"Callback not called."),l._upload({}),equal(0,a,"Callback still not called."),l._upload({lengthComputable:!0,loaded:1}),equal(1,a,"Callback called."),equal(1,o,"Loaded correctly passed?"),l._upload({loaded:2}),equal(1,a,"Callback not called again."),l._upload({lengthComputable:!0,loaded:78}),equal(2,a,"Callback called."),equal(78,o,"Loaded correctly passed?")}),test("statechange aborted",function(){var t=r.AjaxUpload,a=new g;r.AjaxUpload.xhr=function(){return a};var o=0,l=0,n=0,u=new t({url:"url",file:"file",abort:function(){o++},after:function(){l++,equal(o,l,"After called after the abort.")},before:function(){n++},progress:p("progress"),error:p("error"),success:p("success")});t=e.proxy(u._statechange,u),u.upload(),u.aborted=!0,equal(1,n,"Before called."),equal(0,o,"Abort not called."),t(),equal(0,o,"Abort still not called."),a.readyState=4,t(),equal(1,o,"Abort is called."),equal(1,l,"After is called.")}),test("statechange errors",function(){var t=r.AjaxUpload,a=new g;r.AjaxUpload.xhr=function(){return a};var o=h("after"),l=h("error"),n=new t({url:"url",file:{name:"thisIsAFileName"},abort:p("abort"),after:o,progress:p("progress"),error:l,success:p("success")});t=e.proxy(n._statechange,n),n.upload(),equal(l.count,0,"Error not called."),t(),equal(l.count,0,"Error still not called."),a.readyState=4,a.responseText="Not JSON",a.status=400012,t(),equal(l.count,1,"Error is called."),equal(o.count,1,"After is called."),deepEqual(l.lastArgs,[a.responseText,a.status,a],"Error passed the correct arguments?")}),test("client errors",function(){var e,t=r.AjaxUpload,a="thisIsAFileName",o=h("after"),l=h("error"),u=function(n){return e=new g(n),r.AjaxUpload.xhr=function(){return e},new t({url:"url",file:{name:a},abort:p("abort"),after:o,progress:p("progress"),error:l,success:p("success")})},s=u({name:"NS_ERROR_FILE_ACCESS_DENIED"});s.upload(),equal(l.count,1,"Error is called."),equal(o.count,1,"After is called."),deepEqual(l.lastArgs,[n("upload.error.no.access",a),-1,e],"Error passed the correct arguments?"),s=u({name:"NS_ERROR_FILE_NOT_FOUND"}),s.upload(),equal(l.count,2,"Error is called."),equal(o.count,2,"After is called."),deepEqual(l.lastArgs,[n("upload.error.does.not.exist",a),-1,e],"Error passed the correct arguments?");s=u("Some kind of error"),s.upload(),equal(l.count,3,"Error is called."),equal(o.count,3,"After is called."),deepEqual(l.lastArgs,[n("upload.error.client.unknown",a,"Some kind of error"),-1,e],"Error passed the correct arguments?")}),test("statechange success",function(){var t=r.AjaxUpload,a=new g;r.AjaxUpload.xhr=function(){return a};var o={bad:"fase",caount:574758},l=h("before"),n=h("after"),u=h("success"),s=new t({url:"url",file:{name:name},abort:p("abort"),progress:p("progress"),error:p("error"),after:n,success:u,before:l});t=e.proxy(s._statechange,s),s.upload(),equal(l.count,1,"Before was called."),equal(u.count,0,"Succcess not called."),t(),equal(u.count,0,"Success still not called."),a.readyState=4,a.responseText=JSON.stringify(o),a.status=201,t(),equal(u.count,1,"Success called."),equal(n.count,1,"After called after success"),deepEqual(u.lastArgs,[o,a.status,a],"Is the correct result passed?")}),test("getClientErrorMessage",function(){var e=r.AjaxUpload.getClientErrorMessage,t={name:"name"},a="error";equal(e(a,t),r.Text.tr("upload.error.client.unknown",t.name,a)),a={message:"Don't know"},equal(e(a,t),r.Text.tr("upload.error.client.unknown",t.name,a.message)),a.name="NS_ERROR_FILE_ACCESS_DENIED",equal(e(a,t),r.Text.tr("upload.error.no.access",t.name)),a.name="NS_ERROR_FILE_NOT_FOUND",equal(e(a,t),r.Text.tr("upload.error.does.not.exist",t.name)),a.name="NS_ERROR_FILE_TARGET_DOES_NOT_EXIST",equal(e(a,t),r.Text.tr("upload.error.does.not.exist",t.name))}),module("FormUpload",{setup:function(){this.rescope=r.rescope},teardown:function(){r.rescope=this.rescope}}),test("test constructor",function(){var e=r.FormUpload,t={test:!0},a={scope:!0};r.rescope=function(e,t){return deepEqual(a,t,"Correct for "+e+" scope?"),e+1};var o=new e({scope:a,$input:"input",url:"url",params:t,before:"before",error:"error",success:"success",after:"after",abort:"abort"});equal("input",o.$input,"$input correctly set."),equal("url",o.url,"URL correctly set."),deepEqual(t,o.params,"Params correctly set."),equal("error1",o.errorcb,"Error correctly set."),equal("success1",o.successcb,"Success correctly set."),equal("before1",o.before,"Before correctly set."),equal("after1",o.after,"Final correctly set."),equal("abort1",o.abortcb,"Abort correctly set."),equal(o.aborted,!1,"Aborted set correctly?"),equal(o.$form,null,"No form should have been set."),equal(o.xhr,null,"XHR not set?"),r.rescope=function(e,t){return equal(null,t,"Correct scope for "+e+"?"),e+2},o=new e({$input:"input",url:"url",before:"before",error:"error",success:"success",after:"after",abort:"abort"}),equal("input",o.$input,"$input correctly set."),equal("url",o.url,"URL correctly set."),deepEqual({},o.params,"Params correctly set."),equal("error2",o.errorcb,"Error correctly set."),equal("success2",o.successcb,"Success correctly set."),equal("before2",o.before,"Before correctly set."),equal("after2",o.after,"Final correctly set."),equal("abort2",o.abortcb,"Abort correctly set."),equal(o.aborted,!1,"Aborted set correctly?"),equal(o.$form,null,"No form should have been set."),equal(o.xhr,null,"XHR not set?")}),test("test upload",function(){var t,a,o,l,n=r.FormUpload,u={test:!0},s=!1,i=0,c={ajaxForm:function(e){return t=e,c},submit:function(){return s=!0,c},append:function(e){return a=e,c},remove:function(){return i++,c}},d=0,p=0,h=0,f=0,m=new n({$input:"<input type='file'>",url:"url",params:u,before:function(){d++},error:function(e){p++,o=e},success:function(e){l=e,h++},after:function(){f++}});m._renders={form:function(t){var r=e.param(u),a="url";return r&&(a="url?"+r),equal(a,t,"Is the post url correctly set with parameters added to querystring?"),c}},m._addToBody=function(e){equal(e,c,"Appending form to the body?")},m.upload(),equal("json",t.dataType,"Is data correct?"),deepEqual(u,t.data,"Are the parameters correct?"),equal(0,t.timeout,"Is AJAX timeout zero?"),equal(!0,s,"Is the form submitted?");var q={};t.beforeSend(q),equal(m.xhr,q,"XHR correctly set?"),equal(0,d,"Before not called."),t.beforeSubmit(),equal(1,d,"Before called."),equal(0,h,"Success not called."),equal(0,f,"After not called."),equal(0,i,"Removed not called.");var g={data:"data"};t.success(g),equal(1,h,"Before called."),t.error(),equal(1,p,"Before called."),equal("",o,"Correct errror passed."),t.error({}),equal(2,p,"Before called."),equal("",o,"Correct errror passed."),t.error({responseText:"error"}),equal(3,p,"Before called."),equal("error",o,"Correct errror passed."),t.success(),equal(2,h,"Before called."),deepEqual(l,{},"Correct data passed."),equal(i,0,"Initial remove count correct?"),equal(m.$form,c,"Initial form correct?"),t.complete(),equal(1,i,"Removed called."),equal(m.$form,null,"Form removed?"),equal(1,f,"After called."),t.complete(),equal(1,i,"Removed called."),equal(2,f,"After called.")}),test("test abort",function(){var e=r.FormUpload,t="<input type='file'>",a={test:!0},o=h("abort"),l=h("after"),n=new e({$input:t,url:"url",params:a,abort:o,after:l});equal(n.aborted,!1,"Initially not aborted"),n.abort(),equal(o.count,1,"Abort called"),equal(l.count,1,"After called"),equal(n.aborted,!0,"Aborted after?"),o=h("abort");var u={abort:o};n=new e({$input:t,url:"url",params:a,abort:p("abort"),after:p("after")}),n.xhr=u,equal(n.aborted,!1,"Initially not aborted"),n.abort(),equal(o.count,1,"XHR abort called?"),equal(n.aborted,!0,"Aborted after?")}),module("Form",{setup:function(){this.progress=r.UploadProgress,this.staticprogress=r.UnknownProgress,this.tr=r.Text.tr,r.Text.tr=n;var t=this.$body=e("#qunit-fixture"),a=this.$form=e("<form>"),o=this.$input=e("<input type='file'>");this.$id=e("<input name='id' value='10'>").appendTo(a),this.$pid=e("<input name='pid' value='20'>").appendTo(a),this.$maxSize=e("<div id='attach-max-size'>30</div>").appendTo(t),t.append(a.append(o))},teardown:function(){r.Text.tr=this.tr,r.UploadProgress=this.progress,r.UnknownProgress=this.staticprogress}}),test("Form init",function(){this.$body.append("<input name='id' value='2272782'>"),this.$body.append("<input name='pid' value='2828282'>");var e=new r.Form({$element:this.$input});equal(this.$form.get(0),e.$form.get(0),"Correct form found?"),equal(e.maxSize,30,"Correct max size."),equal(e.issueId,10,"Correct issue id."),equal(e.projectId,20,"Correct issue pid."),this.$pid.remove(),e=new r.Form({$element:this.$input}),equal(this.$form.get(0),e.$form.get(0),"Correct form found?"),equal(e.maxSize,30,"Correct max size."),equal(e.issueId,10,"Correct issue id."),equal(e.projectId,void 0,"Correct issue pid."),this.$pid.appendTo(this.$form),this.$id.remove(),e=new r.Form({$element:this.$input}),equal(this.$form.get(0),e.$form.get(0),"Correct form found?"),equal(e.maxSize,30,"Correct max size."),equal(e.issueId,void 0,"Correct issue id."),equal(e.projectId,20,"Correct issue pid."),this.$maxSize.remove();try{e=new r.Form({$element:this.$input}),ok(!1,"Should not be able to create form wihtout maxSize")}catch(e){}this.$maxSize.appendTo(this.$body),this.$pid.remove();try{e=new r.Form({$element:this.$input}),ok(!1,"Should not be able to create form wihtout pid or id.")}catch(e){}}),test("Form getAtlToken",function(){this.$form.append("<input name='atl_token' value='78'>");var e=new r.Form({$element:this.$input});equal("78",e.getAtlToken(),"Do it get the current token.")}),test("Form setAtlToken",function(){var t=e("<input name='atl_token' value='78'>");this.$form.append(t);var a=new r.Form({$element:this.$input});ok(a.setAtlToken("someTokenValue;")===a,"Returning itself?"),equal(t.val(),"someTokenValue;","Is token value set correctly?")}),test("Form disable/enable",function(){var t=e("<input type='submit' name='atl_token' value='78'>"),a=e("<input name='atl_token' value='78'>");this.$form.append(t).append(a);var o=new r.Form({$element:this.$input});o.disable(),equal(t.prop("disabled"),!0,"Submit 1 disabled?"),equal(a.prop("disabled"),!1,"Submit 2 enabled?"),a.attr("disabled","disabled"),o.enable(),equal(t.prop("disabled"),!1,"Submit 1 enabled?"),equal(a.prop("disabled"),!0,"Submit 2 disabled?")}),test("Add Progress",function(){var e,t=new r.Form({$element:this.$input});t._addElement=function(t){e=t},r.UploadProgress=function(e){equal(e,327373.333,"Input file is correct?"),this.$element=e};var a=t.addProgress(327373.333);ok(a,"Progress actuall returned?"),equal(e,327373.333,"Element correct?")}),test("Add Static Progress",function(){var e,t=new r.Form({$element:this.$input});t._addElement=function(t){e=t},r.UnknownProgress=function(e){equal(e,327373.333,"Input file is correct?"),this.$element=e};var a=t.addStaticProgress(327373.333);ok(a,"Progress actuall returned?"),equal(e,327373.333,"Element correct?")}),test("Add Temporary Checkbox",function(){var e,t,a={},o=new r.Form({$element:this.$input});o._replaceElement=function(r,a){e=r,t=a},o.addTemporaryFileCheckbox(327373,"name",a),ok(e,"The checkox was actually created?"),equal(t,a,"The replacement object was correct");var l=e.children("label");equal(l.text(),"name","Label created with name.");var u=e.children("input[type=checkbox]");equal(u.attr("value"),String(327373),"Checkbox value correct."),equal(u.attr("title"),n("upload.checkbox.title"),"Checkbox value correct.")}),test("Add Error",function(){var e,t,a={},o=new r.Form({$element:this.$input});o._replaceElement=function(r,a){e=r,t=a};o.addError("name",a);ok(e,"The checkox was actually created?"),equal(t,a,"The replacement object was correct");var l=e.find("div");equal(l.text(),"name","Error created.")}),test("Clear Error",function(){var t=new r.Form({$element:this.$input});this.$form.append(e("<div>").addClass("error").text("bad")),this.$form.append(e("<div>").text("good")),this.$form.append(e("<div>").addClass("error").text("bad"));var a=t.clearErrors();equal(a,t,"Returned self?"),equal(this.$form.find("div.error").size(),0,"All Errors removed."),equal(this.$form.find("div").size(),1,"Left around non-errors")}),test("Clone File Input",function(){var e=new r.Form({$element:this.$input}),t={};e.fileSelector={cloneInput:function(){return t}};var a=e.cloneFileInput();equal(a,t,"Old selector returned?")}),test("On Cancel",function(){var t=e("<a>").addClass("cancel"),a=e("<a>").addClass("notCancel");this.$form.append(t,a);var o,l=new r.Form({$element:this.$input}),n=0,u=l.onCancel(function(){o=this,n++});equal(u,l,"Returned self?"),a.click(),equal(n,0,"Cancel not called."),t.click(),equal(n,1,"Cancel called."),equal(o,l,"Is scope correct for callback.")}),test("Replace Element",function(){var e,t,a=new r.Form({$element:this.$input}),o=0,l=0,n={$element:{replaceWith:function(t){l++,e=t}}},u=function(e){return{id:e,fadeIn:function(){}}};a._addElement=function(e){o++,t=e};var s=u(0);a._replaceElement(s),equal(l,0,"Replace should not have been called."),equal(o,1,"Add should have been called."),equal(t,s,"Added right element?"),s=u(1),a._replaceElement(s,{}),equal(l,0,"Replace should not have been called."),equal(o,2,"Add should have been called."),equal(t,s,"Added right element?"),s=u(2),a._replaceElement(s,n),equal(l,1,"Replace should not have been called."),equal(o,2,"Add should have been called."),equal(e,s,"Replaced right element?")}),module("UnknownProgress",{setup:function(){this.tr=r.Text.tr,r.Text.tr=n},teardown:function(){r.Text.tr=this.tr}}),test("Constructor",function(){var e=new r.UnknownProgress("fileName");equal(e.$element.attr("title"),n("upload.progress.title.waiting"),"Title is set to waiting."),equal(e.$content.text(),n("upload.file.waiting","fileName"),"Content set correctly to file name."),ok(o(e.$element,e.$cancel),"Cancel added to element."),e.start(),equal(e.$element.attr("title"),n("upload.progress.title.running"),"Title is set to running.")}),test("onCancel",function(){var e=new r.UnknownProgress("Name"),t=0,a=function(){t++,equal(this,e,"Callback called with correct scope?")};e.onCancel(a),e.$cancel.click(),equal(t,1,"Callback should have been called.")}),test("start",function(){var e=new r.UnknownProgress("fileName");e.start(),equal(e.$element.attr("title"),n("upload.progress.title.running"),"Title set to running."),equal(e.$content.text(),"fileName","Title set to the name.")}),module("UploadProgress",{setup:function(){this.text=r.Text,this.pb=r.ProgressBar,this.timer=r.Timer,r.Text=u},teardown:function(){r.Text=this.text,r.ProgressBar=this.pb,r.Timer=this.timer}}),test("Constructor",function(){var e,t,a={name:"Name",size:500};r.Timer=function(r,a){e=r,t=a};var l=new r.UploadProgress(a);equal(e,l._update,"Timer function correctly set?"),equal(t,l,"Timer scope correctly set?"),equal(l.total,500,"Total Size set correctly?"),equal(l.current,0,"Current Size set correctly?"),equal(l.rateNumerator,0,"Rate setup?"),equal(l.rateDenominator,0,"Rate setup?"),equal(l.name,"Name","File name correctly set?"),equal(l.$element.attr("title"),n("upload.progress.title.waiting"),"Correct Waiting title."),equal(l.$cancel.text(),n("upload.cancel"),"Cancel Link Name."),equal(l.$content.text(),n("upload.file.waiting","Name"),"Element text."),ok(o(l.$element,l.$cancel),"Cancel added to element."),ok(o(l.$element,l.$content),"Content added to element."),ok(o(l.$element,l.progress.$element,"Progress added to element."))}),test("Start",function(){var e,t,a={name:"Name",size:500};r.Timer=function(r,a){e=r,t=a}
;var o,l=new r.UploadProgress(a);l._now=function(){return o=(new Date).getTime()},equal(l.started,void 0,"Satrted should not be defined until started."),equal(l.startedSize,void 0,"SatrtedSize should not be defined until started."),equal(l.start(),l,"Returning self?"),equal(l.started,o,"Started was not set correctly."),equal(l.startedSize,0,"StartedSize was not set to zero.")}),test("Update",function(){var e,t={name:"Name",size:500},a=0,o=new r.UploadProgress(t);o._update=function(t){return e=t,o},o.timer={cancel:function(){a++}},equal(o.update(15),o,"Returning self?"),equal(e,15,"_update called with value of 15?"),equal(a,1,"Timer.cancel called?")}),test("finish",function(){var e={name:"Name",size:500},t=new r.UploadProgress(e),a=0;t.timer={cancel:function(){a++}};var o;t.progress={value:function(e){o=e}},equal(t.finish(),t,"Returning self?"),equal(a,1,"Timer cancelled?"),equal(o,100,"Progress bar set to 100?")}),test("onCancel",function(){var e={name:"Name",size:500},t=new r.UploadProgress(e),a=0,o=function(){a++,equal(this,t,"Callback called with correct scope?")};t.onCancel(o),t.$cancel.click(),equal(a,1,"Callback should have been called.")}),test("_addRate",function(){for(var e={name:"Name",size:500},t=new r.UploadProgress(e),a=r.UploadProgress.WEIGHT,o=[0,0,0,5,6,7,8,9,10,11,0,0,68689],l=0,n=0,u=0;u<o.length;u++)l=l*a+o[u],n=n*a+1,t._addRate(o[u]),ok(Math.abs(t.rateNumerator-l)<1e-4,"Numerator is the same? ("+t.rateNumerator+", "+l+")."),ok(Math.abs(t.rateDenominator-n)<1e-4,"Denominator is the same? ("+t.rateDenominator+", "+n+").")}),test("_calcRate",function(){var e={name:"Name",size:500},t=new r.UploadProgress(e);equal(t._calcRate(),0,"Return zero with no data?"),t.rateNumerator=5,equal(t._calcRate(),0,"Return zero with no denominator?"),t.rateDenominator=1e3,equal(t._calcRate(),.005,"Return the fraction?"),t.rateNumerator=4,equal(t._calcRate(),0,"Return zero with small fraction?")}),test("_update",function(){var e,t,a,o,l={name:"Name",size:1048576},s=new r.UploadProgress(l),i=0,c=0,d=0;s._now=function(){return i},s._calcRate=function(){return c},s._addRate=p("_addRate"),s._title=function(e){a=e},s._content=function(e){o=e},s.progress.value=function(e){t=e},s.timer.schedule=function(e){equal(e,r.UploadProgress.UPLOAD_REFRESH,"Timer reset?"),d++};var h=0,f=0,m=Math.floor(.005*l.size);equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is zero?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?"),equal(o,l.name,"Content set correctly?"),s.start(),h=1,m=Math.ceil(.005*l.size),equal(s._update(m),s,"Returned self?"),equal(t,1,"Percentage is 1?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?"),equal(o,l.name,"Content set correctly?"),equal(s.lastUpdate,i,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,i,"Started correct?"),equal(s.startedSize,0,"Started size?");var q=i;i+=1e3,equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?"),equal(o,l.name,"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,0,"Started correct?"),equal(s.startedSize,0,"Started size?"),i+=1e3;var g=i,b=m;equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?"),equal(o,l.name,"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),i+=2e3,m=r.UploadProgress.DATA_MIN-1,h=Math.round(m/l.size*100);var x=1e3*(m-b)/(i-g);g=i,b=m,q=i,s._addRate=function(t){e=t},equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.currentOutOfTotalSize(m,l.size),"Title set correctly?"),equal(o,l.name,"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),ok(Math.abs(e-x)<.005,"Rate correctly added?"),i+=r.UploadProgress.STALLED_TIMEOUT,x=1e3*(m-b)/(i-g),g=i,b=m,c=0,equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.tr("upload.progress.title.unknown.stalled",u.currentOutOfTotalSize(m,l.size)),"Title set correctly?"),equal(o,u.tr("upload.file.stalled",l.name),"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),ok(Math.abs(e-x)<.005,"Rate correctly added?"),i+=1e3,m=r.UploadProgress.DATA_MIN,c=25784.3,h=Math.round(m/l.size*100),q=i;var y=(l.size-m)/c;equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.tr("upload.progress.title.known",c,u.currentOutOfTotalSize(m,l.size),y),"Title set correctly?"),equal(o,u.tr("upload.file.remaining",l.name,y),"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),i+=500,c=48484.25,y=(l.size-m)/c,equal(s._update(),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.tr("upload.progress.title.known",c,u.currentOutOfTotalSize(m,l.size),y),"Title set correctly?"),equal(o,u.tr("upload.file.remaining",l.name,y),"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),i+=r.UploadProgress.STALLED_TIMEOUT,c=33738739.74748,x=1e3*(m-b)/(i-g),g=i,b=m,equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,++f,"Timer reset correctly?"),equal(a,u.tr("upload.progress.title.known.stalled",c,u.currentOutOfTotalSize(m,l.size)),"Title set correctly?"),equal(o,n("upload.file.stalled",l.name),"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),ok(Math.abs(e-x)<.005,"Rate correctly added?"),i+=6e4,c=473482743823.3384,m=l.size,h=100,x=1e3*(m-b)/(i-g),g=i,b=m,y=1,q=i,equal(s._update(m),s,"Returned self?"),equal(t,h,"Percentage is correct?"),equal(d,f,"Timer not reset correctly?"),equal(a,u.tr("upload.progress.title.known",c,u.currentOutOfTotalSize(m,l.size),y),"Title set correctly?"),equal(o,u.tr("upload.file.remaining",l.name,y),"Content set correctly?"),equal(s.lastUpdate,q,"Last update correct?"),equal(s.current,m,"Current set?"),equal(s.started,g,"Started correct?"),equal(s.startedSize,b,"Started size?"),ok(Math.abs(e-x)<.005,"Rate correctly added?")}),module("ProgressBar"),test("Constructor",function(){var e=/upload-progress-(\d+)/,t=new r.ProgressBar;equal(t.old,0,"Old value is zero."),ok(t.hidden,"The progress state is hidden?"),ok(o(t.$element,t.$progress),"The progress bar is in the element");var a=t.$progress.attr("id");ok(e.test(a),"Id Element set"),t=new r.ProgressBar,equal(t.old,0,"Old value is zero."),ok(t.hidden,"The progress state is hidden?"),ok(o(t.$element,t.$progress),"The progress bar is in the element");var l=t.$progress.attr("id");ok(e.test(l),"Id Element set"),notEqual(l,a,"Ids should not have matched.")}),test("Value",function(){var e,t,a=new r.ProgressBar,o=0,l=0,n=0,u={showPercentage:!1,height:"2px"};a.$progress={show:function(){o++},progressBar:function(r,a){e=r,t=a,l++},fadeOut:function(){n++}},a.value(-1),equal(o,1,"Show was called."),equal(l,0,"Progress should not have been called."),equal(n,0,"Fade out should not have been called."),a.value(0),equal(o,1,"Should only be called once."),equal(l,0,"Progress should not have been called."),equal(n,0,"Fade out should not have been called."),a.value(1),equal(o,1,"Should only be called once."),equal(l,1,"Progress called?."),deepEqual(t,u,"Correct options?"),equal(e,1,"Last value correctly updated?"),equal(n,0,"Fade out should not have been called."),a.value(1),equal(o,1,"Should only be called once."),equal(l,1,"Progress not called?."),equal(n,0,"Fade out should not have been called."),a.value(101),equal(o,1,"Should only be called once."),equal(l,2,"Progress not called?."),deepEqual(t,u,"Correct options?"),equal(e,100,"Last value correctly updated?"),equal(n,1,"Fade should be called at 100%.")}),module("FileInput"),test("Contructor",function(){var e={},t=function(){return e},a=[{}];a.parent=t;var o=new r.FileInput(a,!0);equal(o.multiple,!1,"Multiple set correctly?"),a=[{files:{}}];var l,n;a.attr=function(e,t){l=e,n=t},a.parent=t,o=new r.FileInput(a),equal(l,void 0,"Attribute not set?"),equal(n,void 0,"Value not set?"),equal(o.multiple,!1,"Multiple set correctly?"),equal(o.$container,e,"Parent set correctly?"),o=new r.FileInput(a,!0),equal(l,"multiple","Attribute set?"),equal(n,"multiple","Value set?"),equal(o.multiple,!0,"Multiple set correctly?"),equal(o.$container,e,"Parent set correctly?")}),test("onChange",function(){var e={};e.parent=function(){return e};var t,a=new r.FileInput(e);a.$element.change=function(e){t=e},a.getFileName=function(){return"FileName"};var o,l,n=a.onChange(function(e){o=this,l=e});equal(n,a,"Returned self?"),t.call({}),equal(o,a,"Correct callback scope?"),equal(l,"FileName","Correct argument?"),t.call({files:"Files"}),equal(o,a,"Correct callback scope?"),equal(l,"FileName","Correct argument?"),a.multiple=!0,t.call({files:"Files"}),equal(o,a,"Correct callback scope?"),equal(l,"Files","Correct argument?")}),test("cloneInput",function(){var e=0,t=function t(){this.count=e++,this.bound=!0,this.clone=function(){return new t},this.replaceWith=function(e){this.replace=e},this.parent=function(){return this},this.unbind=function(){return this.bound=!1,this}},a=new t,o=new r.FileInput(a),l=o.cloneInput();equal(a,l,"Should have returned the old element."),equal(o.$element.count,a.count+1,"Created a new element"),equal(l.replace,o.$element,"Replaced correct element?"),ok(!l.bound,"Should have been unbound.")}),test("getFileName",function(){var e,t=!1,a={val:function(){return e},parent:h()},o=new r.FileInput(a);o._isIE=function(){return t},e="abc",equal(o.getFileName(),e,"abc not changed?"),e="c:\\fakepATH\\abc",equal(o.getFileName(),"abc","c:\\fakepATH\\abc changed?"),e="c:\\fakepath\\",equal(o.getFileName(),"c:\\fakepath\\","c:\\fakepath\\ not changed when last?"),e="c:\\fakepath\\c\\drive.txt",equal(o.getFileName(),"c\\drive.txt","\\ not cut when when not IE"),t=!0,equal(o.getFileName(),"drive.txt","\\ cut when when IE")}),module("Test AjaxPresenter",{setup:function(){this.form=r.Form,this.fileInput=r.FileInput,this.text=r.Text,this.t=r.Timer,this.ajax=r.AjaxUpload,this.max=r.MAX_UPLOADS,r.Text=u,r.MAX_UPLOADS=2,r.FileInput=c,r.Form=d},teardown:function(){r.Form=this.form,r.FileInput=this.fileInput,r.Text=this.text,r.Timer=this.t,r.AjaxUpload=this.ajax,r.MAX_UPLOADS=this.max}}),test("isSupported",function(){r.AjaxUpload.isSupported=p("isSupported"),ok(!r.AjaxPresenter.isSupported(),"No argument is not supported?"),ok(!r.AjaxPresenter.isSupported(null),"Null argument is not supported?"),ok(!r.AjaxPresenter.isSupported([]),"Empty not supported."),ok(!r.AjaxPresenter.isSupported([{}]),"No files not supported.");var e=!1;r.AjaxUpload.isSupported=function(){return e},ok(!r.AjaxPresenter.isSupported([{files:"files"}]),"Not supported when AJAX upload is not supported."),e=!0,ok(r.AjaxPresenter.isSupported([{files:"files"}]),"Supported?")}),test("Constructor",function(){var e={},t=new r.AjaxPresenter(e);equal(t.form.fileSelector.element,e,"File input correctly wrapped!"),ok(t.form.fileSelector.multiple,"Multiple files added?")}),test("Cancel",function(){var e={},t=new r.AjaxPresenter(e);t.form.disable(),t._cancel(),ok(!t.form.disabled,"Form should not be disabled.")}),test("_attach",function(){var e={},t=new r.AjaxPresenter(e),a=t.form,o=a.fileSelector,n=0,u=function(){equal(a.clearErrors.count,++n,"Called clear errors?"),equal(o.clear.count,n,"Called clear?"),equal(o.focus.count,n,"Called focus?")},s=t._uploadFiles=p("_uploadFiles"),i=t._checkAndFilterFiles=p("_checkAndFilterFiles");t._attach(),u(),ok(!a.disabled,"Form still enabled?"),t._attach([]),u();var c=[new l("name",3637)];i=t._checkAndFilterFiles=h(null),t._attach(c),u(),equal(i.count,1,"_checkAndFilterFiles called?"),deepEqual(i.lastArgs,[c],"_checkAndFilterFiles called with correct arguments?"),c=[new l("name",3637),new l("name2",38383829)];var d=c.slice(0,1);s=t._uploadFiles=h(null),i=t._checkAndFilterFiles=h(d),t._attach(c),u(),equal(i.count,1,"_checkAndFilterFiles called?"),equal(s.count,1,"_uploadFiles called?"),deepEqual(i.lastArgs,[c],"_checkAndFilterFiles called with correct arguments?"),deepEqual(s.lastArgs,[d],"_uploadFiles called with correct arguments?")}),test("_checkAndFilterFiles",function(){var e={},t=new r.AjaxPresenter(e),a=t.form,o=a.maxSize+1,n=new l("zero",0),s=new l("big",o),i=[n,s],c=t._checkAndFilterFiles(i);deepEqual(a.errors,["upload.empty.file,zero","upload.too.big,big,"+o.toFixed(4)+","+a.maxSize.toFixed(4)],"Errors correctly added?"),equal(c,null,"Null returned for no good files?"),a.errors=[];var d=new l("size",a.maxSize),p=new l("size",1),h=new l("size",a.maxSize/2);i=[p,n,h,s,d],c=t._checkAndFilterFiles(i),deepEqual(a.errors,["upload.empty.file,zero","upload.too.big,big,"+o.toFixed(4)+","+a.maxSize.toFixed(4)],"Errors correctly added?"),deepEqual(c,[p.toSimple(),h.toSimple(),d.toSimple()],"Good files returned?"),i=[];for(var f=[],m=0;m<r.AjaxPresenter.MAX_SELECTED_FILES;m++){var q=new l("File"+m,56);i.push(q),f.push(q.toSimple())}a.errors=[],c=t._checkAndFilterFiles(i),deepEqual(a.errors,[],"No errors added?"),deepEqual(c,f,"Good files returned?"),i.push(new l("FileThatBrokeTheCamelsBack",a.maxSize+1e3)),c=t._checkAndFilterFiles(i),deepEqual(a.errors,[u.tr("upload.error.too.many.files",i.length,i.length-1)],"Too many error added?"),equal(c,null,"No files returned?")}),test("_createSubmitData",function(){var e={},t=new r.AjaxPresenter(e),a=t.form;a.projectId=38383838302020;var o={projectId:a.projectId,atl_token:a.nextToken,formToken:a.formToken};deepEqual(t._createSubmitData(),o,"Generated correct data?"),a.issueId=5858658,o={issueId:a.issueId,atl_token:a.nextToken,formToken:a.formToken},deepEqual(t._createSubmitData(),o,"Generated correct data?"),delete a.projectId,o={issueId:a.issueId,atl_token:a.nextToken,formToken:a.formToken},deepEqual(t._createSubmitData(),o,"Generated correct data?"),delete a.issueId;try{t._createSubmitData(),ok(!1,"Did not get exception on bad state!")}catch(e){}}),test("_checkStatus",function(){var e={},t=new r.AjaxPresenter(e),a={name:"name"};equal(t._getErrorFromStatus(400,a),u.tr("upload.error.badrequest",a.name),"Error for bad request?"),equal(t._getErrorFromStatus(401,a),u.tr("upload.error.auth",a.name),"Error for bad auth?"),equal(t._getErrorFromStatus(0,a),u.tr("upload.error.server.no.reply",a.name),"Error for bad auth?");var o=40383;equal(t._getErrorFromStatus(o,a),u.tr("upload.error.unknown.status",a.name,o),"Error for unexpected status?"),o=475858,equal(t._getErrorFromStatus(o,a),u.tr("upload.error.unknown.status",a.name,o),"Error for unexpected status?")}),test("_uploadFiles",function(){var t={},a=new r.AjaxPresenter(t),o=a.form,n={data:!0},s=new l("one",1),i=s.toSimple(),c=new l("two",2).toSimple(),d=new l("three",3).toSimple();a._createSubmitData=h(n),a._getErrorFromStatus=p("_checkStatus");var f=!0,m=[];a._addUpload=function(e){return m.push(e),f};var q=!1,g=[];a._finishUpload=function(e){return g.push(e),q};var b=[];r.AjaxUpload=function(t){this.running=!1,b.push(this);var r=t.scope;equal(r,a,"Correct scope for AJAXUpload?");for(var o in t)if("scope"!==o){var l=t[o];l.apply&&l.call?this[o]=e.proxy(l,r):this[o]=l}this.upload=function(){this.running=!0},this.abort=function(){this.aborted=!0}};var x=[];r.Timer=function(e){this.fn=e,this.cancel=h(this),this.schedule=h(this),this.trigger=function(){this.fn.call(this)},x.push(this)};var y=function(){var e=x.length,t=[];equal(b.length,e,"Created Uploads?"),equal(o.progress.length,e,"Created progress bars?");for(var r=0;r<e;r++)t.push({timer:x[r],upload:b[r],progress:o.progress[r]});return x=[],b=[],o.progress=[],t},v=function(t,a,o){for(var l=0;l<t.length;l++){var u=t[l],s=a[l];equal(u.progress.hidden,!0,"Is Progress Hidden?"),equal(u.progress.started,!1,"Progress not started!"),equal(u.progress.value,1/0,"No value?"),equal(u.upload.file,s.file,"Correct File?"),deepEqual(u.upload.params,e.extend({filename:s.name,size:s.size},n),"Same params?"),equal(u.upload.url,r.AjaxPresenter.DEFAULT_URL,"Correct URL?"),(void 0===o||o)&&(equal(u.timer.schedule.count,1,"Timer called?"),ok(!u.timer.cancel.count,"Timer not cancelled called?"),deepEqual(u.timer.schedule.lastArgs,[r.DISPLAY_WAIT],"Timer started with correct timeout?"))}},k=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(m,t,"Added expected uploads?"),m=[]},T=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(g,t,"Expected uploads finished?"),g=[]},A=[i];a._uploadFiles(A);var w=y();equal(w.length,1,"Added the upload?");var E=w[0];v(w,A),k(w),T([]),ok(o.disabled,"Is form disabled?"),E.timer.trigger(),ok(!E.progress.hidden,"Progress bar shown after timeout."),E.upload.before(),ok(E.progress.started,"Progress should have started."),E.upload.progress(5),equal(E.progress.value,5,"Progress reported?"),E.upload.success({errorMessage:"Error"},304),deepEqual(o.errors,["Error|"+i.name],"Error correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),o.errors=[],E.upload.success({errorMessage:"Token Error",token:"someKindOfToken"},304),deepEqual(o.errors,["Token Error|"+i.name],"Error correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),equal(o.lastToken,"someKindOfToken","Was the token replaced?");var S=a._getErrorFromStatus=h("Status Error");o.errors=[],E.upload.success({error:"Error"},405),deepEqual(o.errors,["Status Error"],"Error correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),deepEqual(S.lastArgs,[405,i],"Error from status?"),equal(S.count,1,"Error from status?"),o.errors=[],E.upload.success({id:1,name:"name"},201),deepEqual(o.errors,[],"No errors to report?"),deepEqual(o.addTemporaryFileCheckbox.lastArgs,[1,"name",E.progress,s],"Added temporary checkbox?"),o.errors=[],E.upload.success({id:1234},201),deepEqual(o.errors,[u.tr("upload.error.bad.response",i.name)],"Error correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),o.errors=[],E.upload.success({name:"name"},201),deepEqual(o.errors,[u.tr("upload.error.bad.response",i.name)],"Error correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),S=a._getErrorFromStatus=h("Bad Status Found"),o.errors=[],E.upload.error("Bad Ajax Request",204),deepEqual(o.errors,["Bad Status Found"],"Error correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),deepEqual(S.lastArgs,[204,i],"Error from status?"),equal(S.count,1,"Error from status?"),S=a._getErrorFromStatus=p("_getErrorFromStatus"),o.errors=[],E.upload.error("Client Error",-1),deepEqual(o.errors,["Client Error"],"Error from client correctly reported?"),equal(o.lastReplace,E.progress,"Progress bar replaced with error?"),E.progress.triggerCancel(),ok(E.upload.aborted,"Was aborted?"),q=!0,E.upload.after(),equal(E.timer.cancel.count,1,"Timer cancelled?"),ok(E.progress.finished,"Progress finished?"),ok(E.progress.removed,"Progress removed?"),T(w),ok(o.disabled,"Form not enabled becasue there are still running builds."),q=!1,E.upload.after(),equal(E.timer.cancel.count,2,"Timer cancelled?"),ok(E.progress.finished,"Progress finished?"),ok(E.progress.removed,"Progress removed?"),T(w),ok(!o.disabled,"Form enabled after completion."),f=!1,o.disabled=!1,A=[i,c,d],a._uploadFiles(A),w=y(),equal(w.length,3,"Added the upload?"),v(w,A,!1),k(w),T([]),ok(!o.disabled,"Is form enabled?"),f=!0,q=!1,o.errors=[],o.addTemporaryFileCheckbox.count=0,A=[i],a._uploadFiles(A),w=y(),equal(w.length,1,"Added the upload?"),v(w,A),k(w),T([]),E=w[0],ok(o.disabled,"Is form disabled?"),a.cancelled=!0,E.timer.trigger(),ok(E.progress.hidden,"Don't display progress bar when hidden?"),E.upload.before(),ok(!E.progress.started,"Progress should not have started."),E.upload.progress(5),equal(E.progress.value,1/0,"Progress ignored reported?"),E.upload.success({id:1,name:"name"}),equal(o.addTemporaryFileCheckbox.count,0,"Didn't add temporary checkbox?"),E.upload.error("Bad Ajax Request"),deepEqual(o.errors,[],"Didn't add error?"),E.upload.after(),equal(E.timer.cancel.count,1,"Timer cancelled?"),ok(E.progress.finished,"Progress finished?"),ok(E.progress.removed,"Progress removed?"),T([])}),module("Test FormPresenter",{setup:function(){this.form=r.Form,this.fileInput=r.FileInput,this.text=r.Text,this.t=r.Timer,this.upload=r.FormUpload,this.max=r.MAX_UPLOADS,r.Text=u,r.MAX_UPLOADS=2,r.FileInput=c,r.Form=d},teardown:function(){r.Form=this.form,r.FileInput=this.fileInput,r.Text=this.text,r.Timer=this.t,r.FormUpload=this.upload,r.MAX_UPLOADS=this.max}}),test("Constructor",function(){var e={},t=new r.FormPresenter(e);equal(t.form.fileSelector.element,e,"File input correctly wrapped!"),ok(!t.form.fileSelector.multiple,"Simple files only?")}),test("Cancel",function(){var e={},t=new r.AjaxPresenter(e);t.form.disable(),t._cancel(),ok(!t.form.disabled,"Form should not be disabled.")}),test("_createSubmitData",function(){var e={},t=new r.FormPresenter(e),a=t.form;a.projectId=38383838302020;var o={projectId:a.projectId,atl_token:a.nextToken,create:!0,formToken:a.formToken};deepEqual(t._createSubmitData(),o,"Generated correct data?"),a.issueId=5858658,o={id:a.issueId,atl_token:a.nextToken,formToken:a.formToken},deepEqual(t._createSubmitData(),o,"Generated correct data?"),delete a.projectId,o={id:a.issueId,atl_token:a.nextToken,formToken:a.formToken},deepEqual(t._createSubmitData(),o,"Generated correct data?"),delete a.issueId;try{t._createSubmitData(),ok(!1,"Did not get exception on bad state!")}catch(e){}}),test("_attach",function(){var t={$element:{}},a=new r.FormPresenter(t),o=a.form,l={data:!0};a._createSubmitData=h(l);var n=[];r.FormUpload=function(t){n.push(this);var r=t.scope;equal(r,a,"Correct scope for FormUpload?");for(var o in t)if("scope"!==o){var l=t[o];l&&l.apply&&l.call?this[o]=e.proxy(l,r):this[o]=l}this.abort=h("abort")};var u=[];a._addUpload=function(e){return u.push(e),arguments.callee.returnValue},a._addUpload.returnValue=!0;var s=[];a._finishUpload=function(e){return s.push(e),arguments.callee.returnValue},a._finishUpload.returnValue=!1;var i=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(u,t,"Added expected uploads?"),u=[]},c=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r].upload;t.push(a)}deepEqual(s,t,"Expected uploads finished?"),s=[]},d=[];r.Timer=function(e,t){equal(t,a,"Correct timer scope?"),this.fn=e,this.cancel=h(this),this.schedule=h(this),this.trigger=function(){this.fn.call(t,this)},d.push(this)};var p=function(){var e=d.length,t=[];equal(n.length,e,"Created Uploads?"),equal(o.progress.length,e,"Created progress bars?");for(var r=0;r<e;r++)t.push({timer:d[r],upload:n[r],progress:o.progress[r]});return d=[],n=[],o.progress=[],t},f=0,m=function(e,t){t=void 0===t||t,f++;var n=o.clearErrors.count+1||1;a._attach(e);var u=p();i(u),equal(u.length,1,"Created one upload?");var s=u[0];return equal(o.clearErrors.count,n,"Cleared the errors?"),equal(o.fileSelector.focus.count,f,"Focused the element?"),equal(s.progress.hidden,!0,"Is Progress Hidden?"),equal(s.progress.started,!1,"Is Progress started?"),deepEqual(s.upload.$input,{count:f,cloneInput:!0},"Correct input?"),deepEqual(s.upload.params,l,"Same params?"),equal(s.upload.url,r.FormPresenter.DEFAULT_URL,"Correct URL?"),t&&(equal(s.timer.schedule.count,1,"Timer called?"),ok(!s.timer.cancel.count,"Timer not cancelled called?"),deepEqual(s.timer.schedule.lastArgs,[r.DISPLAY_WAIT],"Timer started with correct timeout?")),equal(o.disabled,t,"Form in correct state?"),s},q="file",g=m(q);g.timer.trigger(),equal(g.progress.hidden,!1,"Progress shown?"),g.upload.before(),equal(g.progress.started,!0,"Progress started?"),g.upload.success({errorMsg:"Error"}),deepEqual(o.errors,["Error|"+q],"Error correctly reported?"),equal(o.lastReplace,g.progress,"Progress bar replaced with error?"),o.errors=[],g.upload.success({error:"Error"}),deepEqual(o.errors,[r.Text.tr("upload.error.bad.response",q)],"Error correctly reported?"),equal(o.lastReplace,g.progress,"Progress bar replaced with error?"),o.errors=[],g.upload.success({id:1,name:"name"}),deepEqual(o.errors,[],"No errors to report?"),deepEqual(o.addTemporaryFileCheckbox.lastArgs,[1,"name",g.progress],"Added temporary checkbox?"),o.errors=[],g.upload.error("Bad Ajax Request"),deepEqual(o.errors,[r.Text.tr("upload.error.unknown",q)],"Error correctly reported?"),equal(o.lastReplace,g.progress,"Progress bar replaced with error?"),o.errors=[],g.upload.error("ssssssSecurityTokenMissingssss"),deepEqual(o.errors,[r.Text.tr("upload.xsrf.timeout",q)],"Error correctly reported?"),equal(o.lastReplace,g.progress,"Progress bar replaced with error?"),g.upload.after(),c([g]),equal(g.timer.cancel.count,1,"Timer cancelled?"),ok(g.progress.removed,"Progress removed?"),ok(!o.disabled,"Form enabled after completion."),q="file2.txt",g=m(q),g.progress.triggerCancel(),equal(g.upload.abort.count,1,"Abort was called?"),a._addUpload.returnValue=!1,a.form.enable(),q="WontAttachMe",g=m(q,!1),g=m(q,!1),a._addUpload.returnValue=!0,g=m(q,!0),a._finishUpload.returnValue=!0,g.upload.after(),c([g]),ok(o.disabled,"Form not enabled because there are still running uploads."),a._finishUpload.returnValue=!1,o.addTemporaryFileCheckbox.count=0,o.errors=[],g=m("cancel"),a.cancelled=!0,g.timer.trigger(),ok(g.progress.hidden,"Don't display progress bar when cancelled?"),g.upload.before(),ok(!g.progress.started,"Don't start progress bar when cancelled?"),g.upload.success({id:1,name:"name"}),equal(o.addTemporaryFileCheckbox.count,0,"Didn't add temporary checkbox?"),g.upload.error("Bad Ajax Request"),deepEqual(o.errors,[],"Didn't add error?"),g.upload.after(),equal(g.timer.cancel.count,1,"Timer cancelled?"),ok(g.progress.removed,"Progress removed?")}),module("Presenter",{setup:function(){this.max=r.MAX_UPLOADS,r.MAX_UPLOADS=2},teardown:function(){r.MAX_UPLOADS=this.max}}),test("removeFromArray",function(){var e=r.Presenter.removeFromArray,t=[1,2,3,4];equal(e(t,0),null,"Remove nothing?"),deepEqual(t,[1,2,3,4],"Remove nothing?"),equal(e(t,1),1,"Remove 1?"),deepEqual(t,[2,3,4],"Array correctly altered?"),equal(e(t,3),3,"Remove 3?"),deepEqual(t,[2,4],"Array correctly altered?"),equal(e(t,4),4,"Remove 4?"),deepEqual(t,[2],"Array correctly altered?"),equal(e(t,2),2,"Remove 2?"),deepEqual(t,[],"Array correctly altered?"),equal(e(t,2),null,"Remove from empty does nothing?"),deepEqual(t,[],"Array not changed?")}),test("_addUpload & _finishUpload",function(){var e=function(){return{upload:h("upload"),abort:p("abort")}},t=new r.Presenter,a=new e,o=new e,l=new e,n=new e;equal(t._addUpload(a),!0,"Correct return?"),deepEqual(t.waiting,[],"No Waiting uploads."),deepEqual(t.running,[a],"Running uploads?"),equal(a.upload.count,1,"Upload called?"),equal(t._addUpload(o),!0,"Correct return?"),deepEqual(t.waiting,[],"No Waiting uploads."),deepEqual(t.running,[a,o],"Running uploads?"),equal(a.upload.count,1,"Upload called?"),equal(o.upload.count,1,"Upload called?"),equal(t._addUpload(l),!0,"Correct return?"),deepEqual(t.waiting,[l],"Waiting uploads?"),deepEqual(t.running,[a,o],"Running uploads?"),equal(a.upload.count,1,"Upload called?"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,0,"Upload not called?"),equal(t._finishUpload(a),!0,"Correct return?"),deepEqual(t.waiting,[],"No Waiting uploads?"),deepEqual(t.running,[o,l],"Running uploads?"),equal(a.upload.count,1,"Upload called?"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,1,"Upload called?"),equal(t._addUpload(n),!0,"Correct return?"),deepEqual(t.waiting,[n],"Waiting uploads?"),deepEqual(t.running,[o,l],"Running uploads?"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,1,"Upload called?"),equal(n.upload.count,0,"Upload not called?"),equal(t._finishUpload(new e),!0,"Correct return?"),deepEqual(t.waiting,[n],"Waiting uploads not touched?"),deepEqual(t.running,[o,l],"Running uploads not touched?"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,1,"Upload called?"),equal(n.upload.count,0,"Upload not called?"),equal(t._finishUpload(n),!0,"Correct return?"),deepEqual(t.waiting,[],"No waiting uploads"),deepEqual(t.running,[o,l],"Running uploads?"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,1,"Upload called?"),equal(t._finishUpload(o),!0,"Correct return?"),deepEqual(t.waiting,[],"No waiting uploads"),deepEqual(t.running,[l],"Running uploads?"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,1,"Upload called?"),equal(t._finishUpload(l),!1,"Correct return?"),deepEqual(t.waiting,[],"Not waiting uploads"),deepEqual(t.running,[],"No running uploads"),equal(o.upload.count,1,"Upload called?"),equal(l.upload.count,1,"Upload called?")}),test("_cancel",function(){var e=function(){return{upload:p("upload"),abort:h("abort")}},t=new r.Presenter,a=new e,o=new e,l=new e,n=new e;t.running=[a,l],t.waiting=[n,o],equal(t.cancelled,!1,"Not cancelled?"),t._cancel(),equal(t.cancelled,!0,"Cancelled now?"),deepEqual(t.running,[],"Nothing running?"),deepEqual(t.waiting,[],"Nothing waiting?"),equal(a.abort.count,1,"Abort called?"),equal(o.abort.count,1,"Abort called?"),equal(l.abort.count,1,"Abort called?"),equal(n.abort.count,1,"Abort called?")}),module("InlineAttach",{setup:function(){this.ajax=r.AjaxPresenter,this.form=r.FormPresenter,this.text=r.Text,r.Text=u},teardown:function(){r.AjaxPresenter=this.ajax,r.FormPresenter=this.form,r.Text=this.text}}),test("rescope",function(){var t=r.rescope;equal(t(),e.noop,"No arg returns noop function."),equal(t(null),e.noop,"Null arg return noop function.");var a={},o={},l=h(a),n=t(l);equal(n.call(o),a,"Correct result?"),equal(l.count,1,"Called once?"),equal(l.lastScope,o,"Correct scope?"),n=t(l,o),equal(n.call({"never the same":"ssj"}),a,"Correct result?"),equal(l.count,2,"Called again?"),equal(l.lastScope,o,"Correct scope?")}),test("copyArrayLike",function(){var e=r.copyArrayLike,t=function(){for(var e=0;e<arguments.length;e++)this[e]=arguments[e];this.length=arguments.length};deepEqual(e(new t),[],"Empty works?"),deepEqual(e(new t(1)),[1],"One element works?"),deepEqual(e(new t(1,!0,"hello")),[1,!0,"hello"],"Multiple elements works?")}),test("Constructor",function(){r.AjaxPresenter=h("ajax"),r.FormPresenter=h("form"),r.AjaxPresenter.isSupported=h(!0),new r("<div/>"),equal(r.AjaxPresenter.count,1,"Ajax presenter created?"),equal(r.FormPresenter.count,0,"Form presenter not created?"),r.AjaxPresenter.isSupported=h(!1),new r("<div/>"),equal(r.AjaxPresenter.count,1,"Ajax presenter not created?"),equal(r.FormPresenter.count,1,"Form presenter created?")})});