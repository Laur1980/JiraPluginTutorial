define("jira/setup/setup-license",["wrm/context-path","aui/message","jira/flag","jira/util/formatter","jira/util/data/meta","jira/jquery/deferred","jquery","underscore"],function(e,t,n,r,i,s,a,o){"use strict";function u(e,n){t.error("#formError",{title:e,body:n,closeable:!1}),a("#formError").scrollIntoView()}function c(){u(r.I18n.getText("setupLicense.error.unknown.title"),r.I18n.getText("setupLicense.error.unknown.desc","<a href='https://support.atlassian.com' target='_blank'>","</a>"))}function l(){d.children().detach(),d.append(f).removeClass("hidden")}var f,d,m,p=e();return{startPage:function(){function e(e){return e.target||e.srcElement}function u(e){return a.ajax({url:p+"/secure/SetupLicense!validateLicense.jspa",data:{licenseToValidate:e},type:"POST"})}function v(e,t){if(403===e.status){var n=JSON.parse(e.responseText);b(r.I18n.getText("setup.importlicense.validation.failure.header"),n.errors)}else c(e,t)}function h(){a("#setupLicenseKey").val(E),a("#setupLicenseForm").submit()}function g(t){L();var n=new s,r=k(a(e(t))),i=u(r.licenseKey);return i.fail(v),i.fail(function(){n.reject()}),i.done(function(){E=r.licenseKey,n.resolve()}),n}function b(e,n){var r="";o.map(n,function(e){r+=e+"<br />"}),t.error("#formError",{title:e,body:r,closeable:!1}),a("#formError").scrollIntoView()}function x(e){return e.preventDefault(),e}function L(e){return a(".error").remove(),T(),e}function T(){a(".warn").remove()}function y(t){return a(e(t)).find(":submit").attr("disabled","disabled"),t}function I(t){var n=j();return a(e(t)).find(".throbbers-placeholder").append(JIRA.Templates.LicenseSetup.renderSpinner({msg:n})),t}function j(){return r.I18n.getText("setupLicense.existing.license.spinner")}function w(e){e.fail(function(){d.find(":submit").removeAttr("disabled"),m.off("click"),d.find(".throbber-message").remove()}).done(function(){h()})}function S(e){return m.click(function(e){e.preventDefault()}),e}var E,k=function(e){var t={},n=e.serializeArray();return a.each(n,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t};f=a(JIRA.Templates.LicenseSetup.renderExistingLicenseForm({serverId:i.get("server-id")})),f.submit(o.compose(w,g,I,y,L,x,S)),m=f.find("#generate-mac-license"),m.attr("href",a("#mac-redirect").data("mac-redirect-url")),function(){var e=a("#setupLicenseKey").val();e.trim()&&(setTimeout(function(){n.showSuccessMsg(r.I18n.getText("setupLicense.flag.title"),r.I18n.getText("setupLicense.flag.text"),{close:"auto"})},1e3),f.find("#licenseKey").text(e))}(),d=a("#license-input-container"),l()}}});