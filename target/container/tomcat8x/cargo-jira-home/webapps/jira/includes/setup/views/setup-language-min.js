define("jira/setup/setup-language-view",["jira/util/formatter","jira/ajs/select/single-select","jira/util/data/meta","wrm/context-path","jquery","marionette","underscore"],function(e,t,n,a,s,i,l){"use strict";return i.ItemView.extend({defaultTexts:{button:e.I18n.getText("common.words.save"),cancel:e.I18n.getText("common.forms.cancel"),connectionWarningContent:e.I18n.getText("setup.language.dialog.connection.warning.content"),connectionWarningTitle:e.I18n.getText("setup.language.dialog.connection.warning.title"),langLabel:e.I18n.getText("setup.choose.language"),langDesc:e.I18n.getText("setupdb.server.language.description"),header:e.I18n.getText("setup.language.dialog.header")},ui:{button:".jira-setup-language-save-button",cancel:".jira-setup-language-cancel-button",footerSpinner:".jira-setup-language-footer-spinner",select:"#jira-setup-language",spinner:".jira-setup-language-spinner",warning:".jira-setup-language-connection-warning"},events:{"click @ui.button":"onButtonClick","click @ui.cancel":"onCancelClick","change @ui.select":"onSelectChange"},template:JIRA.Templates.Setup.languageDialogContent,templateHelpers:{locales:[],showConnectionWarning:!1,showSpinner:!0,texts:{}},initialize:function(){var e=n.get("setup-language-dialog-default-texts");e&&(this.defaultTexts=JSON.parse(e))},showInitial:function(){this._formDisabled=!1,this._defaultLocale=void 0,this._selectedLocale=void 0,this.templateHelpers.showSpinner=!0,this.templateHelpers.showConnectionWarning=!1,this.updateTexts(),this.render(),this.enableButton(!1)},start:function(){this.pullInstalledLocales()},updateSelected:function(e){l.each(this.templateHelpers.locales,l.bind(function(t){t.selected=this._selectedLocale?t.value===this._selectedLocale:t.value===e},this))},updateTexts:function(e){var e=e||{};this.templateHelpers.texts=l.extend({},this.defaultTexts,e)},onButtonClick:function(){this.disableForm(),s.ajax({data:{jiraLanguage:this._selectedLocale},dataType:"json",timeout:6e4,type:"POST",url:a()+"/secure/"+this.getCorrectActionName()+"!changeLanguage.jspa",complete:l.bind(this._languageChangeComplete,this)})},_languageChangeComplete:function(){window.location.reload()},onCancelClick:function(e){e.preventDefault(),this._formDisabled||this.trigger("cancel-requested")},onSelectChange:function(){this._selectedLocale=this.ui.select.val()[0],this.disableForm(),this.ui.cancel.focus(),this.pullLanguageTexts()},disableForm:function(){this._formDisabled=!0,this.enableButton(!1),this.ui.select.prop("disabled",!0),this.langSingleSelect.disable(),this.ui.footerSpinner.removeClass("hidden")},pullInstalledLocales:function(){this.templateHelpers.showConnectionWarning=!1,s.ajax({dataType:"json",timeout:6e4,type:"GET",url:a()+"/secure/"+this.getCorrectActionName()+"!getInstalledLocales.jspa",success:l.bind(this._pullInstalledLocalesSuccess,this),error:l.bind(this._pullInstalledLocalesError,this)})},_pullInstalledLocalesSuccess:function(e){var t=[];l.each(e.locales,l.bind(function(e,n){t.push({text:e,value:n})},this)),this.templateHelpers.locales=l.sortBy(t,"text"),this.updateSelected(e.currentLocale),this.templateHelpers.showSpinner=!1,this.render(),this._defaultLocale=this.ui.select.val()[0],this.enableButton(!1)},_pullInstalledLocalesError:function(){this.templateHelpers.showSpinner=!1,this.templateHelpers.showConnectionWarning=!0,this.render()},pullLanguageTexts:function(){this.templateHelpers.showConnectionWarning=!1,s.ajax({data:{localeForTexts:this._selectedLocale},dataType:"json",timeout:6e4,type:"GET",url:a()+"/secure/"+this.getCorrectActionName()+"!getLanguageTexts.jspa",success:l.bind(this._pullLanguageTextsSuccess,this),error:l.bind(this._pullLanguageTextsError,this)})},_pullLanguageTextsSuccess:function(e){this.updateSelected(),this.updateTexts(e),this.render(),this._selectedLocale===this._defaultLocale&&this.enableButton(!1)},_pullLanguageTextsError:function(){this.templateHelpers.showConnectionWarning=!0,this.render()},onRender:function(){this._formDisabled=!1,this.langSingleSelect=new t({element:this.ui.select}),this.ui.cancel.focus()},enableButton:function(e){var e=void 0===e||e;this.ui.button.prop("disabled",!e),this.ui.button.attr("aria-disabled",""+!e)},getCorrectActionName:function(){var e=window.location.pathname.replace(a()+"/secure/","").match(/^([a-zA-Z]+)/);return e?e[0]:"SetupMode"}})});