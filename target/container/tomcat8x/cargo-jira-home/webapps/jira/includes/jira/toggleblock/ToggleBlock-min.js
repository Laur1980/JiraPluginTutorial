define("jira/toggleblock/toggle-block",["jira/util/logger","jira/lib/class","jira/util/events","jira/util/events/types","jira/data/local-storage","jquery","jira/libs/parse-uri"],function(t,e,i,o,s,n,r){function a(t){var e=t.data.instance;n(this).hasClass(e.options.collapsedClass)&&e.expand(this)}function l(t){var e=t.data.instance;e.options.originalTargetIgnoreSelector&&n(t.originalTarget).is(e.options.originalTargetIgnoreSelector)||(e.toggle(t.target),t.preventDefault())}function c(t){t.data.instance._collapseTwiciBlocksFromStorage()}return e.extend({getDefautOptions:function(){return{blockSelector:".twixi-block",triggerSelector:".twixi",eventType:"click",collapsedClass:"collapsed",expandedClass:"expanded",storageCollectionName:"twixi-blocks",autoFocusTrigger:!0}},_collapseTwiciBlocksFromStorage:function(){var t,e=s.getItem(this.options.storageCollectionName)||"";return e=e.replace(/\./g,"\\."),/#\w+/.test(e)&&(t=n(e),t.is(this.options.blockSelector)&&(this.isPermlink()||t.removeClass(this.options.expandedClass).addClass(this.options.collapsedClass))),this},_updateTwixiBlockIdInStorage:function(t){if(!this.isPermlink()){if(!/#\w+/.test(t))return this;var e=s.getItem(this.options.storageCollectionName)||"";e=(","+e+",").indexOf(","+t+",")+1?e.indexOf(","+t)+1?e.replace(","+t,""):e.replace(t,""):e.length?e+","+t:t,s.setItem(this.options.storageCollectionName,e)}return this},contract:function(t){return t=n(t),t.is(this.options.blockSelector)&&(t.removeClass(this.options.expandedClass).addClass(this.options.collapsedClass),!1!==this.options.persist&&this._updateTwixiBlockIdInStorage("#"+t.attr("id"))),n(t).trigger("contractBlock"),this},expand:function(t){return t=n(t),t.is(this.options.blockSelector)&&(t.removeClass(this.options.collapsedClass).addClass(this.options.expandedClass),!1!==this.options.persist&&this._updateTwixiBlockIdInStorage("#"+t.attr("id"))),n(t).trigger("expandBlock"),this},toggle:function(t){var e=n(t).closest(this.options.blockSelector);return e.hasClass(this.options.collapsedClass)?this.expand(e):this.contract(e),this.options.autoFocusTrigger&&e.find(this.options.triggerSelector+":visible").focus(),this},isPermlink:function(){return this.checkIsPermlink(location.href)},checkIsPermlink:function(t){var e=r(t).queryKey;return e.hasOwnProperty("focusedCommentId")||e.hasOwnProperty("focusedWorklogId")},addTrigger:function(t,e){var i=this,o=0;return t&&(e=e||"click","dblclick"===e&&(document.selection?n(document).delegate(t,"dblclick",function(){document.selection.empty()}):n(document).delegate(t,"mousedown",function(){var t=(new Date).getTime(),e=t-o>750;return o=t,e})),n(document).delegate(t,e,function(){i.toggle(this)})),this},addCallback:function(t,e){return n.aop.after({target:this,method:t},e),this},isUnique:function(t){var e=n(document).data("toggleBlockUids")||[];return-1===n.inArray(t,e)},setUid:function(t){var e=n(document).data("toggleBlockUids")||[];e.push(t),n(document).data("toggleBlockUids",e)},init:function(e){var s=this;e=e||{},this.options=n.extend(this.getDefautOptions(),e);var r=this.options.triggerSelector;if(!this.isUnique(r))return void("undefined"!=typeof console&&t.warn&&t.warn("Your are trying to create a ToggleBlock with selector '"+this.options.triggerSelector+"'.One already exists with this trigger so has been ignored."));this.setUid(r),n(document).delegate(this.options.blockSelector,"reveal",{instance:this},a),n(document).delegate(this.options.triggerSelector,this.options.eventType,{instance:this},l),i.bind(o.REFRESH_TOGGLE_BLOCKS,{instance:this},c),!1!==this.options.persist&&n(function(){s._collapseTwiciBlocksFromStorage()})}})}),AJS.namespace("JIRA.ToggleBlock",null,require("jira/toggleblock/toggle-block"));