define("jira/viewissue/comment/comment-form",["jira/util/formatter","jira/util/events","jira/util/events/types","jira/ajs/ajax/smart-ajax","jira/issue","jira/dialog/form-dialog","wrm/context-path","jira/jquery/deferred","jquery"],function(e,t,i,n,o,r,s,a,m){var u=s(),c={setCaretAtEndOfCommentField:function(){var e,t=this.getField(),i=t[0];t.length&&(e=t.val().length,t.scrollTop(t.attr("scrollHeight")),i.setSelectionRange&&e>0&&i.setSelectionRange(e,e))},disable:function(){this.getForm().find("textarea").attr("readonly","readonly"),this.getForm().find("input[type=submit]").attr("disabled","disabled")},isDirty:function(){var e=this.getField();return!!e.length&&e[0].value!==e[0].defaultValue},handleBrowseAway:function(){if(c.isDirty()){var t=c.getForm();return t.length&&t.is(":visible")?e.I18n.getText("common.forms.dirty.comment"):void 0}},isVisibilityAvailble:function(){return"none"!=this.getForm().find("#commentLevel :selected").val()},setSubmitState:function(){m.trim(this.getField().val()).length>0&&this.isVisibilityAvailble()?this.getForm().find("#issue-comment-add-submit").removeAttr("disabled"):this.getForm().find("#issue-comment-add-submit").attr("disabled","disabled")},enable:function(){this.getForm().find("textarea").removeAttr("readonly"),this.getForm().find("input[type=submit]").removeAttr("disabled")},getCommentVisibility:function(){var e=this.getForm().find("#commentLevel :selected").val();if(e){return{type:e.split(":")[0],value:this.getForm().find("#commentLevel :selected").text()}}return null},ajaxSubmit:function(){var s=m('<span class="icon throbber loading"></span>'),d=o.getIssueId(),l=o.getIssueKey(),f=u+"/rest/api/2/issue/"+l+"/comment",g={body:this.getField()[0].value.replace(/\r?\n/g,"\r\n")},h=this.getCommentVisibility();h&&(g.visibility=h);var v=a(),p=m.ajax({url:f,type:"POST",contentType:"application/json",data:JSON.stringify(g),success:function(e){t.trigger(i.UNLOCK_PANEL_REFRESHING,["addcommentmodule"]),t.trigger(i.REFRESH_ISSUE_PAGE,[d,{complete:function(){var t="comment-"+e.id;m("#"+t).scrollIntoView({marginBottom:200,marginTop:200}),m("#issue_actions_container > .issue-data-block.focused").removeClass("focused"),m("#"+t).addClass("focused"),s.remove(),c.enable(),v.resolve()}}])},error:function(t){var i,o=m.parseJSON(t.responseText);i=o&&o.errors&&o.errors.comment?function(t){var i="<h2>"+e.I18n.getText("common.words.error")+'</h2><div class="ajaxerror"><div class="aui-message error"><span class="aui-icon icon-warning"/>'+t+"</div></div>";return m(i)}(o.errors.comment):n.buildDialogErrorContent(t),new r({content:i}).show(),s.remove(),c.enable(),v.reject()}}),b=this.getForm().find("input[type=submit]").parent();return b.is(".wiki-button-bar-content")?s.css("margin-right","10px").prependTo(b):s.appendTo(b),m.when(p,v)},getForm:function(){var e=m("form#issue-comment-add");return 1===e.length&&(this.$form=e),this.$form||m()},getField:function(){return this.getForm().find("#comment")},getSubmitButton:function(){return this.getForm().find("#issue-comment-add-submit")},hide:function(e){e&&this.cancel(),this.getForm().detach(),i.UNLOCK_PANEL_REFRESHING&&t.trigger(i.UNLOCK_PANEL_REFRESHING,["addcommentmodule"])},show:function(){this.focus(),i.LOCK_PANEL_REFRESHING&&t.trigger(i.LOCK_PANEL_REFRESHING,["addcommentmodule"])},focus:function(){this.focusField(),this.setCaretAtEndOfCommentField()},focusField:function(){this.getField().focus().trigger("keyup"),this.getSubmitButton().scrollIntoView({marginBottom:200})},showNoCommentMsg:function(e){if(""===this.getField().val())return m("#emptyCommentErrMsg").show(),!0},cancel:function(){var e=this;setTimeout(function(){e.getField().val("")},100),m("#comment-preview_link.selected").click()}};return c}),define("jira/viewissue/comment/footer-comment",["jira/viewissue/comment/comment-form","jquery"],function(e,t){var i=!1,n=!1,o={getModule:function(){return t("#addcomment")},isActive:function(){return this.getModule().hasClass("active")},hide:function(t){if(this.isActive()){var o=e.handleBrowseAway();(n||i||!o||confirm(o))&&(this.getModule().removeClass("active"),e.hide(t))}},ajaxSubmit:function(){i=!0,e.ajaxSubmit().then(function(){o.hide(!0)})},show:function(){this.isActive()?e.focusField():(i=!1,this.getModule().addClass("active"),this.appendForm(),e.show())},appendForm:function(){this.getModule().find(".mod-content").append(e.getForm())}};return o.setPreviewMode=function(e){n=Boolean(e)},o});