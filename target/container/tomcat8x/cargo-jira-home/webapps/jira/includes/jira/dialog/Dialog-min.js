var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};define("jira/dialog/dialog",["require"],function(t){"use strict";var e=t("jira/ajs/control"),i=t("jira/ajs/layer/inline-layer"),s=t("jira/util/data/meta"),o=t("jira/ajs/ajax/smart-ajax"),n=t("jira/loading/loading"),r=t("jira/xsrf"),a=t("jira/util/browser"),d=t("jira/util/events"),h=t("jira/util/navigator"),l=t("aui/dropdown"),p=t("jquery"),c=t("jira/jquery/deferred"),u=t("jira/jquery/plugins/isdirty"),g=t("underscore"),f=t("wrm/require"),_=t("jira/util/key-code"),m=AJS.bind,v=AJS.unbind,y=AJS.dim,b=AJS.layer,C=AJS.LayerManager.global,w=e.extend({_getDefaultOptions:function(){return{height:"auto",cached:!1,widthClass:"medium",modeless:!1,ajaxOptions:{data:{inline:!0,decorator:"dialog"}}}},init:function(t){if("string"==typeof t||t instanceof p?t={trigger:t}:t&&t.width&&(t.widthClass="custom"),this.classNames=w.ClassNames,this.OPEN_DIALOG_SELECTOR="."+this.classNames.DIALOG+"."+this.classNames.DIALOG_OPEN,this.options=p.extend(!0,this._getDefaultOptions(),t),this.options.width=w.WIDTH_PRESETS[this.options.widthClass]||t.width,"function"==typeof this.options.content?this.options.type="builder":this.options.content instanceof p||"object"===_typeof(this.options.content)&&this.options.nodeName?this.options.type="element":(!this.options.type&&!this.options.content||"object"===_typeof(this.options.content)&&this.options.content.url)&&(this.options.type="ajax"),this.options.trigger){var e=p.makeArray(this.options.trigger),i=this;p.each(e,function(t,e){i._assignEvents("trigger",e)})}this.onContentReadyCallbacks=[],this._assignEvents("container",document),this.initModeless(),this.defineResources(),this.options.prefetchResources&&this.downloadResources()},initModeless:function(){this.options.modeless=!!this.options.modeless,this.options.modeless&&(!1===this.options.windowTitle&&(this.options.windowTitle=document.title),this._temporarilyHidden=!1,this._auiDialogShowHandler=this._auiDialogHandlers.hideTemporarily.bind(this),this._auiDialogHideHandler=this._auiDialogHandlers.restoreVisibility.bind(this),this._auiDialogRemoveHandler=this._auiDialogHandlers.restoreVisibilityRebindable.bind(this),m("show.dialog",this._auiDialogShowHandler),m("hide.dialog",this._auiDialogHideHandler),m("remove.dialog",this._auiDialogRemoveHandler),AJS.dialog2&&(this._auiDialog2ShowHandler=this._auiDialog2Handlers.hideTemporarily.bind(this),this._auiDialog2HideHandler=this._auiDialog2Handlers.restoreVisibility.bind(this),AJS.dialog2.on("show",this._auiDialog2ShowHandler),AJS.dialog2.on("hide",this._auiDialog2HideHandler)))},_runContentReadyCallbacks:function(){var t=this;p.each(this.onContentReadyCallbacks,function(){this.call(t)})},_setContent:function(t,e){var i;if(!this.resourcesReady().isResolved())return this._showloadingIndicator(),void this.resourcesReady().done(this._setContent.bind(this,t,e));t?w.current===this?(this.get$popup().show().css("visibility","hidden").addClass("popup-width-"+this.options.widthClass),this.$content=t,this.get$popupContent().html(t),!1!==e&&this.decorateContent&&this.decorateContent(),(i=this.get$popupContent().find("."+this.classNames.HEADING_AREA)).size()>0&&this.get$popupHeading().replaceWith(i),(i=this.get$popupContent().find("."+this.classNames.CONTENT_AREA)).size()>0&&(i.contents().insertAfter(i),i.remove()),this._positionInCenter(),!1!==e&&(p(document).trigger("dialogContentReady",[this]),this._runContentReadyCallbacks()),this.get$popup().css("visibility",""),!1!==e&&p.isFunction(this.options.onContentRefresh)&&this.options.onContentRefresh.call(this),this._onShowContent()):!1===this.options.cached&&delete this.$content:this._contentRetrievers[this.options.type].call(this,this._setContent)},_ellipsify:function(t){t instanceof p||(t=this.get$popup()),p(".overflow-ellipsis",t).textOverflow({className:"ellipsified"})},_handleInitialDoneResponse:function(t,e,i){},getRequestUrlFromTrigger:function(){if(this.$activeTrigger&&this.$activeTrigger.length)return this.$activeTrigger.attr("href")||this.$activeTrigger.data("url")},_getRequestOptions:function(){var t={};return!1!==this._getAjaxOptionsObject()&&(t=p.extend(!0,t,this._getAjaxOptionsObject()),t.url||(t.url=this.getRequestUrlFromTrigger()),t)},_getAjaxOptionsObject:function(){var t=this.options.ajaxOptions;return p.isFunction(t)?t.call(this):t},_contentRetrievers:{element:function(t){this.$content||(this.$content=p(this.options.content).clone(!0)),t.call(this,this.$content)},builder:function(t){var e=this;this.$content||(this._showloadingIndicator(),this.options.content.call(this,function(i){e.$content=p(i),t.call(e,e.$content)}))},ajax:function(t){var e,i=this;this.$content||(e=this._getRequestOptions(),this._showloadingIndicator(),this.serverIsDone=!1,e.complete=function(s,n,r){if(r.successful){var a=i._detectRedirectInstructions(s);i.serverIsDone=a.serverIsDone,a.redirectUrl?i._performRedirect(a.redirectUrl):(e.dataType&&"json"===e.dataType.toLowerCase()&&i._buildContentFromJSON?i.$content=i._buildContentFromJSON(r.data):i.$content=r.data,i.serverIsDone?i._handleInitialDoneResponse(r.data,s,r):t.call(i,i.$content))}else{var d=o.buildDialogErrorContent(r);t.call(i,d)}},o.makeRequest(e))}},_detectRedirectInstructions:function(t){var e={serverIsDone:!1,redirectUrl:""},i=t.getResponseHeader("X-Atlassian-Dialog-Control");if(i){e.serverIsDone=!0;0===i.indexOf("redirect:")?e.redirectUrl=i.substr("redirect:".length):"permissionviolation"===i&&(e.redirectUrl=window.location.href)}return e},_performRedirect:function(t){a.reloadViaWindowLocation(t)},_renders:{popupHeading:function(){return p("<div />").addClass(this.classNames.HEADING_AREA)},popupContent:function(){return p("<div />").addClass(this.classNames.CONTENT_AREA)},popup:function(){return p("<div />").attr("id",this.options.id||"").addClass(this.classNames.DIALOG).toggleClass(this.classNames.MODELESS_DIALOG,this.options.modeless).hide()}},_events:{trigger:{simpleClick:function(t,e){this.$activeTrigger=e,this.$activeTrigger.is("a")||(this.$activeTrigger=e.find("a")),this.show(),t.preventDefault()}},container:{keydown:function(t){if(t.which===_.ESCAPE){var e=this.handleCancel();h.isIE()&&h.majorVersion()<12&&!1===e&&t.preventDefault()}}}},handleCancel:function(){return this.hide(!0,{reason:w.HIDE_REASON.escape})},_showloadingIndicator:function(){n.showLoadingIndicator()},_hideloadingIndicator:function(){n.hideLoadingIndicator()},_positionInCenter:function(){var t=p(window),e=this.get$popup(),i=this.getContentContainer(),s=this.getContentArea(),o=t.height(),n=0;if("number"==typeof this.options.width&&e.width(this.options.width),this.options.modeless)n=Math.round(o/2);else{e.css({marginLeft:-e.outerWidth()/2,marginTop:Math.max(-e.outerHeight()/2,40-o/2)});for(var r=e[0];r;)n+=r.offsetTop,r=r.offsetParent}var a=Math.max(o-n-40,w.CONSTRAINTS.MODELESS_MIN_HEIGHT),d=parseInt(s.css("padding-top"),10)+parseInt(s.css("padding-bottom"),10);s.css("maxHeight","");var h=a-(e.outerHeight()-i.outerHeight())-d;s.css("maxHeight",h),p(this).trigger("contentMaxHeightChanged",[h])},getContentArea:function(){return this.$popup.find(".form-body")},getContentContainer:function(){var t=this.$popup.find(".content-area-container");return 1===t.length?t:this.$popup.find(".form-body")},get$popup:function(){return this.$popup||(this.$popup=this._render("popup").appendTo("body"),this.$popup.addClass("box-shadow")),this.$popup},bindAnchorsToDialog:function(t){var e=this;t.click(function(t){e.$activeTrigger=p(this),delete e.$content,e._setContent(),t.preventDefault()})},get$popupContent:function(){return this.$popupContent||(this.$popupContent=this._render("popupContent").appendTo(this.get$popup())),this.$popupContent},get$popupHeading:function(){return this.$popupHeading||(this.$popupHeading=this._render("popupHeading").prependTo(this.get$popup())),this.$popupHeading},getLoadingIndicator:function(){return this.get$popupContent().find(".throbber:last")},showFooterLoadingIndicator:function(){var t=this.getLoadingIndicator();t.length&&(t.data("spinner")?t.hasClass("loading")||t.addClass("loading"):t.addClass("loading").spin())},hideFooterLoadingIndicator:function(){var t=this.getLoadingIndicator();t.length&&(t.removeClass("loading"),g.defer(function(){t.hasClass("loading")||t.spinStop()}))},_watchTab:function(t){var e,i,s;p(t.target).parents(this.get$popupContent()).length>0&&(e=p("html").hasClass("safari")?p(":input:visible:enabled, :checkbox:visible:enabled, :radio:visible:enabled",this.OPEN_DIALOG_SELECTOR):p("a:visible, :input:visible:enabled, :checkbox:visible:enabled, :radio:visible:enabled",this.OPEN_DIALOG_SELECTOR),i=e.first(),s=e.last(),(t.target===i[0]&&t.shiftKey||t.target===s[0]&&!t.shiftKey)&&(t.shiftKey?s.focus():i.focus(),t.preventDefault()))},_show:function(t){if(i.current&&i.current.hide(),l.current&&l.current.hide(),w.current){var e;if(w.current.options.stacked)e=w.current,e.stacked=!0,e.hide(!1),this.prev=e;else{w.stackroot=this;var s=w.current;for(e=s._removeStackState(),s.hide(!1);e;)s=e,e=s._removeStackState(),s._destroyIfNecessary()}}else!0!==this.stacked&&(w.stackroot=this,w.originalWindowTitle=document.title);this.options.modeless||(this.prev&&this.prev.options.modeless?y(!1):!0!==this.stacked&&y(!1)),w.current=this;var o=this.get$popup().addClass(this.classNames.DIALOG_OPEN);t||"blank"!==this.options.type&&!this.$content&&!0!==this.stacked?(delete this.$content,this._setContent()):(o.show(),this._positionInCenter(),this._onShowContent()),this.tabWatcher=function(t){t.keyCode===_.TAB&&w.current._watchTab(t)},p(document).bind("keydown",this.tabWatcher),p(this).trigger("Dialog.show",[this.$popup,this,this.id]),d.trigger("Dialog.show",[this.$popup,this,this.id]),this.options.modeless||a.disableKeyboardScrolling(),this.stacked=!1},show:function(t){var e=this.options.delayShowUntil,i=this;if(w.current===this)return!1;var s=new p.Event("beforeShow"),o=new p.Event("beforeShow");if(p(this).trigger(s),d.trigger(o,[this.options.id]),s.isDefaultPrevented()||o.isDefaultPrevented())return!1;if(this.downloadResources(),e){var n=e();"resolved"===n.state()?i._show(t):(this.options.modeless||y(!1),this._showloadingIndicator(),n.done(function(){i._show(t)}))}else i._show(t)},_setWindowTitle:function(){var t,e,i=this.options.windowTitle,o=this.get$popup();if(!1!==i&&("string"==typeof i?t=i:"function"==typeof i?t=i.call(this):(e=o.find("."+this.classNames.HEADING_AREA),e.length&&(t=e.text())),t)){var n=s.get("app-title"),r=[t];n&&r.push(n),document.title=r.join(" - ")}},_onShowContent:function(){this._setWindowTitle(),this._hideloadingIndicator(),this._ellipsify(),this.get$popup().addClass(this.classNames.CONTENT_READY)},_resetWindowTitle:function(){!0!==this.stacked&&w.stackroot===this&&w.originalWindowTitle&&(document.title!==w.originalWindowTitle&&(document.title=w.originalWindowTitle),delete w.originalWindowTitle)},notifyOfNewContent:function(){this.$content&&(this.decorateContent(),this._positionInCenter(),this._onShowContent(),p(document).trigger("dialogContentReady",[this]))},destroy:function(){this.options.modeless&&(AJS.dialog2&&(AJS.dialog2.off("show",this._auiDialog2ShowHandler),AJS.dialog2.off("hide",this._auiDialog2HideHandler),delete this._auiDialog2ShowHandler,delete this._auiDialog2HideHandler),v("show.dialog",this._auiDialogShowHandler),v("hide.dialog",this._auiDialogHideHandler),v("remove.dialog",this._auiDialogRemoveHandler),delete this._auiDialogShowHandler,delete this._auiDialogHideHandler,delete this._auiDialogRemoveHandler),this.$popup&&this.$popup.remove(),delete this.$popup,delete this.$popupContent,delete this.$popupHeading,delete this.$content},_destroyIfNecessary:function(){!this.options.cached&&this.destroy()},_removeStackState:function(){var t=this.prev;return delete this.prev,delete this.stacked,t},isCurrent:function(){return w.current===this},hide:function(t,e){if(w.current===this){var i=new p.Event("Dialog.beforeHide"),s=new p.Event("Dialog.beforeHide");if(e=e||{},d.trigger(i,[this.$popup,e.reason,this.options.id]),p(this).trigger(s,[this.$popup,e.reason,this.options.id]),i.isDefaultPrevented()||s.isDefaultPrevented())return!1;var o=p("input[name=atl_token]",this.OPEN_DIALOG_SELECTOR).attr("value");void 0!==o&&r.updateTokenOnPage(o),(!1!==t&&!this.prev&&!this.options.modeless||this.prev&&this.prev.options.modeless)&&AJS.undim(),this.get$popup().removeClass(this.classNames.DIALOG_OPEN).removeClass(this.classNames.CONTENT_READY).hide(),this._hideloadingIndicator(),this._resetWindowTitle(),p(document).trigger("hideAllLayers",[this.$popup,e.reason,this.options.id]),p(this).trigger("Dialog.hide",[this.$popup,e.reason,this.options.id]),d.trigger("Dialog.hide",[this.$popup,e.reason,this.options.id]),w.current=null,!1===this.options.cached&&!0!==this.stacked&&this.destroy(),this.options.modeless||a.enableKeyboardScrolling(),this.tabWatcher&&p(document).unbind("keydown",this.tabWatcher),!0!==this.stacked&&(this.prev?(this.prev.show(!!this.prev.options.reloadOnPop),delete this.prev):w.stackroot===this&&delete w.stackroot)}},addHeading:function(t){var e=p("<div/>").html(t).contents(),i=p("<h2/>"),s=[];e.each(function(t){"div"===this.nodeName.toLowerCase()?s.push(this):i.append(this)}),this.get$popupHeading().html(s).append(i),i.attr("title",p.trim(i.text()))},onContentReady:function(t){p.isFunction(t)&&this.onContentReadyCallbacks.push(t)},_auiDialogHandlers:{hideTemporarily:function(t,e){this._temporarilyHidden||this._hideTemporarily()},restoreVisibility:function(t,e){if(this._temporarilyHidden){var i=C.getTopLayer(),s=!!i&&b(i);s&&s.isVisible()&&s.isBlanketed()||this._restoreVisibility()}},restoreVisibilityRebindable:function(t,e){this._restoreVisibility(t,e);var i=function(){m("remove.dialog",this._auiDialogRemoveHandler)};setTimeout(i.bind(this),0)}},_auiDialog2Handlers:{hideTemporarily:function(t,e){this._temporarilyHidden||this._hideTemporarily()},restoreVisibility:function(t,e){if(this._temporarilyHidden&&(!AJS.popup.current||!AJS.popup.current.element.is(":visible"))){for(;e;){var i=b(e);if(i.isVisible()&&i.isBlanketed())return;e=i.below()}this._restoreVisibility()}}},_hideTemporarily:function(){this.get$popup().addClass(this.classNames.DIALOG_NOT_VISIBLE),this._temporarilyHidden=!0},_restoreVisibility:function(){this.get$popup().removeClass(this.classNames.DIALOG_NOT_VISIBLE),this._temporarilyHidden=!1},defineResources:function(){g.isFunction(this.options.defineResources)&&this.options.defineResources.call(this)},requireContext:function(t){this.requireResource(t,"wrc!")},requireResource:function(t,e){this.wrmResources=this.wrmResources||[],this.wrmResources.push((e||"wr!")+t)},getRequiredResources:function(){return this.wrmResources||[]},downloadResources:function(){this.getRequiredResources().length>0&&!this.deferredResources&&(this.deferredResources=f(this.getRequiredResources()))},resourcesReady:function(){return this.deferredResources?this.deferredResources.promise():(new c).resolve().promise()}});return w.fn.dirtyFormWarning=function(){return this.bind("Dialog.beforeHide",function(t,e,i){if(!t.isDefaultPrevented()&&(i===w.HIDE_REASON.cancel||i===w.HIDE_REASON.escape)){var s=u.getDirtyWarning();s&&!confirm(s)&&t.preventDefault()}})},w.ClassNames={DIALOG:"jira-dialog",HEADING_AREA:"jira-dialog-heading",CONTENT_AREA:"jira-dialog-content",DIALOG_OPEN:"jira-dialog-open",CONTENT_READY:"jira-dialog-content-ready",MODELESS_DIALOG:"jira-dialog-modeless",DIALOG_NOT_VISIBLE:"jira-dialog-not-visible"},w.WIDTH_PRESETS={small:360,medium:540,large:810},w.CONSTRAINTS={MODELESS_MIN_HEIGHT:240},w.HIDE_REASON={cancel:"cancel",escape:"esc",submit:"submit"},w}),AJS.namespace("AJS.FlexiPopup",null,require("jira/dialog/dialog")),AJS.namespace("JIRA.Dialog",null,require("jira/dialog/dialog"));