AJS.test.require(["jira.webresources:application-selector"],function(){function e(e){return AJS.layer(e).isVisible()}var i,t=require("jira/admin/application-selector"),a=require("jira/admin/application-selector/application"),o=require("aui/inline-dialog2"),n=require("underscore"),l=require("jquery");module("Application selector",{setup:function(){this.sandbox=sinon.sandbox.create(),this.sandbox.stub(a.prototype,"showEffectiveWarning"),this.sandbox.stub(a.prototype,"hideEffectiveWarning"),i=[]},teardown:function(){this.sandbox.restore(),i.forEach(function(e){e.parent&&e.parent.removeChild(e)})},initializeApplicationSelector:function(e,i){this.selector=new t({el:l(e)}),i&&this.selector.selectApplicationsBasedOnURL(i)}});var d=function(){this.element=l("#qunit-fixture"),this.dialogFor=sinon.stub()};n.extend(d.prototype,{addCombo:function(e,t,a,d,c){d=void 0===d||d;var s=l("<div></div>"),r=l("<input>").attr({type:"checkbox",class:"application application-"+e,"data-defined":""+d,"data-key":e}).val(e).prop("checked",!!t).prop("disabled",!!a).appendTo(s);if(!d){var p=new o;l(p).attr({id:"dialog-for-"+e,class:"application-not-defined-dialog"}).appendTo(s),this.dialogFor.withArgs(e).returns(p),i.push(p)}return c&&n.pairs(c).forEach(function(e){r.data(e[0],e[1])}),s.appendTo(this.element),this},addWarning:function(e){var i=l("<div></div>");return l("<a></a>").attr({href:"#",class:"aui-icon aui-icon-warning application application-warning application-warning-"+e,"data-key":e}).appendTo(i),l("<label>").attr({class:"application-label","data-key":e}).appendTo(i),i.appendTo(this.element),this},addCriticalCore:function(){return this.addWarning("jira-core"),this},addCore:function(e,i){return this.addCombo("jira-core",e,i),this},getDisabled:function(){return this._getCheckboxes(".application:disabled, .application-label.disabled")},getWarnings:function(){return this._getCheckboxes(".application-warning")},getChecked:function(){return this._getCheckboxes("input::checked")},getIndeterminate:function(){return this._getCheckboxes("input:indeterminate, .application-warning.effective")},doClick:function(e){this.element.find("input[value="+e+"]").click()},setChecked:function(e,i){return this.element.find("input[value="+e+"]").prop("checked",i),this},_getCheckboxes:function(e){return this.element.find(e).map(function(){return l(this).attr("data-key")}).get()},clear:function(){this.element.empty()}}),test("Initial state of combobox doesnt change when no app selected",function(){var e=new d;e.addCombo("something").addCombo("else").addCore(),this.initializeApplicationSelector(e.element),deepEqual(e.getChecked(),[],"Doesn't select any combos when no apps selected.")}),test("Initial state of combobox selects + disables core when app selected",function(){var e=new d;e.addCombo("something").addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element),deepEqual(e.getChecked(),["else","jira-core"],"Core is checked when application is selected."),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled when application is selected.")}),test("Combobox change state aproptietly when there is no core.",function(){var e=new d;e.addCombo("something").addCombo("else",!0).addWarning("error-app"),this.initializeApplicationSelector(e.element),deepEqual(e.getChecked(),["else"]),deepEqual(e.getDisabled(),[]),e.doClick("something"),deepEqual(e.getChecked(),["something","else"]),deepEqual(e.getDisabled(),[])}),test("Combobox retains core checked when it was initially checked",function(){var e=new d;e.addCombo("something").addCombo("else",!0).addWarning("error-app").addCore(!0),this.initializeApplicationSelector(e.element),deepEqual(e.getChecked(),["else","jira-core"],"Core is checked when application is selected."),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled when application is selected."),e.doClick("else"),deepEqual(e.getChecked(),["jira-core"],"Core is selected and enabled"),deepEqual(e.getDisabled(),[],"Core is re-enabled when no other application is selected.")}),test("Core is not checked and enabled after one app was unchecked",function(){var e=new d;e.addCombo("something").addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element),e.doClick("else"),deepEqual(e.getChecked(),[],"Core is not checked"),deepEqual(e.getDisabled(),[],"Core is re-enabled when no other application is selected.")}),test("Core remains checked and disabled when two apps are selected",function(){var e=new d;e.addCombo("something").addCombo("else").addCore(),this.initializeApplicationSelector(e.element),e.doClick("else"),e.doClick("something"),deepEqual(e.getChecked(),["something","else","jira-core"],"Core is selected and enabled"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled when other application is selected.")}),test("Core is un-checked and enabled when two apps are selected, then de-selected",function(){var e=new d;e.addCombo("something").addCombo("else").addWarning("error-app").addCore(),this.initializeApplicationSelector(e.element),e.doClick("else"),e.doClick("something"),e.doClick("else"),e.doClick("something"),deepEqual(e.getChecked(),[],"Core is not selected"),deepEqual(e.getDisabled(),[],"Core is enabled when no other application are selected.")}),test("Core is checked and enabled when two apps are selected, then de-selected",function(){var e=new d;e.addCombo("something").addCombo("else").addWarning("error-app").addCore(!0),this.initializeApplicationSelector(e.element),e.doClick("else"),e.doClick("something"),e.doClick("else"),e.doClick("something"),deepEqual(e.getChecked(),["jira-core"],"Core is selected"),deepEqual(e.getDisabled(),[],"Core is enabled when no other application are selected."),e.doClick("else"),e.doClick("something"),e.doClick("else"),e.doClick("something"),e.doClick("jira-core"),deepEqual(e.getChecked(),[],"Core is not selected"),deepEqual(e.getDisabled(),[],"Core is enabled when no other application are selected.")}),test("Core is un-checked and disabled when other apps were selected and it was initially disabled",function(){var e=new d;e.addCombo("something").addCombo("else").addWarning("error-app").addCore(!1,!0);this.sandbox.spy();this.initializeApplicationSelector(e.element),deepEqual(e.getChecked(),[],"Core is not selected"),deepEqual(e.getDisabled(),["jira-core"],"Core remains disabled from initial state"),e.doClick("else"),e.doClick("something"),e.doClick("else"),e.doClick("something"),deepEqual(e.getChecked(),[],"Core is not selected"),deepEqual(e.getDisabled(),["jira-core"],"Core remains disabled from initial state")}),test("Only one application exists script doesn't break",function(){var e=new d,i=e.element.html();this.initializeApplicationSelector(e.element),deepEqual(e.element.html(),i,"shall be the same")}),test("Application is selected based on the url",function(){var e=new d;e.addCombo("something").addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element,"http://example.com/?application=something"),deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}),test("Multiple applications are selected based on the url",function(){var e=new d;e.addCombo("something",!0).addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element,"http://example.com/?application=something&application=else"),deepEqual(e.getChecked(),["something","else","jira-core"],"All applications are selected"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}),test("Application is selected also when it appears multiple times in the url",function(){var e=new d;e.addCombo("something",!0).addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element,"http://example.com/?application=something&application=something"),deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}),test("Nothing is selected when application key is provided in the url but the application is disabled",function(){var e=new d;e.addCombo("something",!1,!0).addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element,"?application=something"),deepEqual(e.getChecked(),[],"Nothing is selected"),deepEqual(e.getDisabled(),["something"],"Nothing is disabled.")}),test("Wrong application key provided in the url is not taken into account when selecting",function(){var e=new d;e.addCombo("something",!1,!0).addCombo("else").addCore(),this.initializeApplicationSelector(e.element,"?application=something&application=else"),deepEqual(e.getChecked(),["else","jira-core"],"Else and core are selected"),deepEqual(e.getDisabled(),["something","jira-core"],"Core and something are disabled.")}),test("Nothing is selected when wrong application key is provided in the url",function(){var e=new d;e.addCombo("something",!0).addCombo("else").addCore(),this.initializeApplicationSelector(e.element,"?application=no-such-app"),deepEqual(e.getChecked(),[],"Nothing is selected"),deepEqual(e.getDisabled(),[],"Nothing is disabled.")}),test("Wrong application key provided in the url is not taken into account when selecting",function(){var e=new d;e.addCombo("something",!0).addCombo("else").addCore(),this.initializeApplicationSelector(e.element,"?application=no-such-app&application=else"),deepEqual(e.getChecked(),["else","jira-core"],"Else and core are selected"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}),test("Defaults are selected when there is no application param in the url",function(){var e=new d;e.addCombo("something").addCombo("else",!0).addWarning("error-app").addCore(),this.initializeApplicationSelector(e.element,"http://example.com/?no-application=no-such-app"),deepEqual(e.getChecked(),["else","jira-core"],"Core and something are selected"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}),test("Doesn't break with empty url",function(){var e=new d;e.addCombo("something",!0).addCombo("else").addCore(),this.initializeApplicationSelector(e.element,""),deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected"),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled.")}),test("Effective applications checked after selectApplicationsBasedOnURL and unchecked after toggle",function(){var e=new d;e.addCombo("something",!1,!1,!0,{effective:["foo"]}).addCombo("foo").addCombo("else",!0).addCore(),this.initializeApplicationSelector(e.element,"http://example.com/?application=something"),deepEqual(e.getChecked(),["something","jira-core"],"Core and something are selected"),deepEqual(e.getIndeterminate(),["foo"],"Foo is indeterminate."),deepEqual(e.getDisabled(),["jira-core"],"Core is disabled."),ok("showEffectiveWarning called once",a.prototype.showEffectiveWarning.calledOnce),e.doClick("something"),deepEqual(e.getIndeterminate(),[],"Foo is not indeterminate."),ok("hideEffectiveWarning called once",a.prototype.hideEffectiveWarning.calledOnce)}),test("After disableAllApplications all applications should be disabled",function(){var e=new d;e.addCombo("jira-func").addCombo("jira-software").addWarning("error-app").addCore(),this.initializeApplicationSelector(e.element,""),this.selector.disableAllApplications(),deepEqual(e.getDisabled(),["jira-func","jira-software","error-app","jira-core"],"All applications should be disabled"),deepEqual(e.getChecked(),[],"None application should be selected")}),test("Undefined application's trigger showing a dialog when checked",function(){var i=new d;i.addCombo("jira-func",!1,!1,!1),this.initializeApplicationSelector(i.element,""),equal(e(i.dialogFor("jira-func")),!1),i.doClick("jira-func"),equal(e(i.dialogFor("jira-func")),!0,"inline dialog should have been shown")}),test("Undefined application's trigger hiding a dialog when unchecked",function(){var i=new d;i.addCombo("jira-func",!1,!1,!1),this.initializeApplicationSelector(i.element,""),equal(e(i.dialogFor("jira-func")),!1,"inline dialog should start hidden"),i.doClick("jira-func"),equal(e(i.dialogFor("jira-func")),!0,"inline dialog should appear"),i.doClick("jira-func"),equal(e(i.dialogFor("jira-func")),!1,"inline dialog should have been hidden")}),test("Defined application's trigger doesn't show a dialog",function(){var i=new d;i.addCombo("jira-func",!1,!1,!0),this.initializeApplicationSelector(i.element,""),i.doClick("jira-func"),equal(e(i.dialogFor("jira-func")),!1,"inline dialog should NOT appear"),i.doClick("jira-func"),equal(e(i.dialogFor("jira-func")),!1,"inline dialog should not suddenly appear on close")}),test("Effective warning should appear when critical application is indeterminate selected",function(){var e=new d;e.addCombo("clickable",!1,!1,!0,{effective:["critical"]}),e.addWarning("critical"),this.initializeApplicationSelector(e.element,""),e.doClick("clickable"),deepEqual(e.getIndeterminate(),["critical"],"Critical is indeterminate."),ok("showEffectiveWarning called once",a.prototype.showEffectiveWarning.calledOnce)}),test("Effective warning should appear when critical Core application is indeterminate selected",function(){var e=new d;e.addCombo("clickable",!1,!1,!0,{effective:["jira-core"]}),e.addCriticalCore(),this.initializeApplicationSelector(e.element,""),e.doClick("clickable"),deepEqual(e.getIndeterminate(),["jira-core"],"Core is indeterminate."),ok("showEffectiveWarning called once",a.prototype.showEffectiveWarning.calledOnce)})});