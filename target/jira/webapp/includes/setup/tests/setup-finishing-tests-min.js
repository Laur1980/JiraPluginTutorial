AJS.test.require("jira.webresources:jira-setup",function(){var s=require("jquery"),e=require("underscore"),t=require("jira/setup/setup-finishing-layout"),i=JIRA.Templates.Setup.layoutContent({content:JIRA.Templates.Setup.Finishing.pageContent({})});module("JIRA SetupFinishing page",{setup:function(){this.sandbox=sinon.sandbox.create({useFakeServer:!0,useFakeTimers:!0}),s("#qunit-fixture").append(s("<div></div>").addClass("jira-setup-finishing-page").html(i)),this.initializeView=function(){this.view=new t({el:".jira-setup-finishing-page"})}},currentView:function(){return this.view.contents.currentView},teardown:function(){window.onbeforeunload=null,this.sandbox.restore(),this.view.close(),this.view.remove()},assertSteps:function(s){var t=this.currentView();e.each(s,e.bind(function(s,e){var i=t.ui.notificationsItem.eq(e),n=this.getStatus(i);equal(i.data("step-key"),s.key,"expecting notification step ("+s.key+")"),equal(n,s.status,"expecting notification step ("+s.key+") to have given status ("+s.status+")")},this))},getStatus:function(s){var e="unknown";return 1===s.find(".aui-icon-wait").length?e="pending":1===s.find(".jira-setup-finishing-notifications-placeholder-icon").length?1===s.find(".jira-setup-finishing-notifications-inactive").length&&(e="awaiting"):1===s.find(".aui-iconfont-approve").length?e="success":1===s.find(".aui-iconfont-info").length&&(e="failure"),e},hasLagMessage:function(s){return 1===this.currentView().ui.notificationsItem.filter('[data-step-key="'+s+'"]').find(".jira-setup-finishing-notifications-lag").length},stepsForResponse:function(s){var t={};return e.each(s,function(s){t[s.key]=s.status}),t},steps:{databasePending:[{key:"database",status:"pending"},{key:"plugins",status:"awaiting"},{key:"environment",status:"awaiting"},{key:"finishing",status:"awaiting"}],databaseFailure:[{key:"database",status:"failure"},{key:"plugins",status:"awaiting"},{key:"environment",status:"awaiting"},{key:"finishing",status:"awaiting"}],pluginsPending:[{key:"database",status:"success"},{key:"plugins",status:"pending"},{key:"environment",status:"awaiting"},{key:"finishing",status:"awaiting"}],pluginsFailure:[{key:"database",status:"success"},{key:"plugins",status:"failure"},{key:"environment",status:"awaiting"},{key:"finishing",status:"awaiting"}],environmentPending:[{key:"database",status:"success"},{key:"plugins",status:"success"},{key:"environment",status:"pending"},{key:"finishing",status:"awaiting"}],environmentFailure:[{key:"database",status:"success"},{key:"plugins",status:"success"},{key:"environment",status:"failure"},{key:"finishing",status:"awaiting"}],finishingPending:[{key:"database",status:"success"},{key:"plugins",status:"success"},{key:"environment",status:"success"},{key:"finishing",status:"pending"}],finishingFailure:[{key:"database",status:"success"},{key:"plugins",status:"success"},{key:"environment",status:"success"},{key:"finishing",status:"failure"}],finishingSuccess:[{key:"database",status:"success"},{key:"plugins",status:"success"},{key:"environment",status:"success"},{key:"finishing",status:"success"}]}}),test("database task should be marked as pending by default and tasks should be in correct order",function(){this.initializeView(),this.assertSteps(this.steps.databasePending)}),test("lag message is visible if a single step takes longer than 15 seconds",function(){var s=this.steps.environmentPending,e={steps:this.stepsForResponse(s)};this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.clock.tick(15001),ok(this.hasLagMessage("database"),"database step has lag message"),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify(e)),this.assertSteps(s),ok(!this.hasLagMessage("database"),"database step has no lag message"),ok(!this.hasLagMessage("environment"),"environment step has no lag message"),this.sandbox.clock.tick(15001),ok(!this.hasLagMessage("database"),"database step has no lag message"),ok(this.hasLagMessage("environment"),"environment step has lag message")}),test("if setting up database fails, an error message is shown",function(){var s=this.steps.databaseFailure,e={steps:this.stepsForResponse(s),errorMessage:"The fancy error message."};this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify(e)),equal(this.sandbox.server.requests.length,2,"there are exxactly two requests to the server"),this.assertSteps(s),ok(-1!==this.currentView().ui.errorMessage.text().indexOf("The fancy error message."),"error message has correct content")}),test("if restarting plugin system fails, an error message is shown",function(){var s=this.steps.pluginsPending,e=this.steps.pluginsFailure,t={steps:this.stepsForResponse(s)},i={steps:this.stepsForResponse(e),errorMessage:"The fancy error message."};this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify(t)),this.assertSteps(s),this.sandbox.clock.tick(1),this.sandbox.server.requests[2].respond(200,{"Content-Type":"application/json"},JSON.stringify(i)),this.assertSteps(e),equal(this.sandbox.server.requests.length,3,"there are only three requests to the server"),ok(-1!==this.currentView().ui.errorMessage.text().indexOf("The fancy error message."),"error message has correct content")}),test("if setting up environment fails, an error message is shown",function(){var s=this.steps.pluginsPending,e=this.steps.environmentPending,t=this.steps.environmentFailure,i={steps:this.stepsForResponse(s)},n={steps:this.stepsForResponse(e)},a={steps:this.stepsForResponse(t),errorMessage:"The fancy error message."};this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify(i)),this.assertSteps(s),this.sandbox.clock.tick(1),this.sandbox.server.requests[2].respond(200,{"Content-Type":"application/json"},JSON.stringify(n)),this.assertSteps(e),this.sandbox.clock.tick(1),this.sandbox.server.requests[3].respond(200,{"Content-Type":"application/json"},JSON.stringify(a)),this.assertSteps(t),equal(this.sandbox.server.requests.length,4,"there are only four requests to the server"),ok(-1!==this.currentView().ui.errorMessage.text().indexOf("The fancy error message."),"error message has correct content")}),test("if the last phase of setup fails, an error message is shown",function(){var s=this.steps.pluginsPending,e=this.steps.environmentPending,t=this.steps.finishingPending,i=this.steps.finishingFailure,n={steps:this.stepsForResponse(s)},a={steps:this.stepsForResponse(e)},r={steps:this.stepsForResponse(t)},o={steps:this.stepsForResponse(i),errorMessage:"The fancy error message."};this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify(n)),this.assertSteps(s),this.sandbox.clock.tick(1),this.sandbox.server.requests[2].respond(200,{"Content-Type":"application/json"},JSON.stringify(a)),this.assertSteps(e),this.sandbox.clock.tick(1),this.sandbox.server.requests[3].respond(200,{"Content-Type":"application/json"},JSON.stringify(r)),this.assertSteps(t),this.sandbox.clock.tick(1),this.sandbox.server.requests[4].respond(200,{"Content-Type":"application/json"},JSON.stringify(o)),this.assertSteps(i),equal(this.sandbox.server.requests.length,5,"there are only five requests to the server"),ok(-1!==this.currentView().ui.errorMessage.text().indexOf("The fancy error message."),"error message has correct content")}),test("after setup completes successfully, notifications are replaced with summary view",function(){var s=this.steps.pluginsPending,e=this.steps.environmentPending,t=this.steps.finishingPending,i=this.steps.finishingSuccess,n="http://localhost:8090/jira/";this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify({steps:this.stepsForResponse(s)})),this.assertSteps(s),this.sandbox.clock.tick(1),this.sandbox.server.requests[2].respond(200,{"Content-Type":"application/json"},JSON.stringify({steps:this.stepsForResponse(e)})),this.assertSteps(e),this.sandbox.clock.tick(1),this.sandbox.server.requests[3].respond(200,{"Content-Type":"application/json"},JSON.stringify({steps:this.stepsForResponse(t)})),this.assertSteps(t),this.sandbox.clock.tick(1),this.sandbox.server.requests[4].respond(200,{"Content-Type":"application/json"},JSON.stringify({steps:this.stepsForResponse(i)})),this.assertSteps(i),this.sandbox.clock.tick(1),this.sandbox.server.requests[5].respond(200,{"Content-Type":"application/json"},JSON.stringify({redirectUrl:n})),equal(this.sandbox.server.requests.length,6,"there are only six requests to the server"),this.sandbox.clock.tick(3e3);var a=this.currentView();equal(a.ui.summary.text(),"setup.finishing.finished.description","summary view is rendered"),equal(a.ui.annotation.data("redirect-url"),n,"summary view has a link to dashboard / whatever")}),test("if request times out, a warning is shown to the user",function(){var s=e.bind(function(s,e){var t=this.currentView().ui.timeoutWarning;s?(notEqual(t.length,0,e),ok(!t.hasClass("aui-message-error"),"timeout message should never be of error type"),ok(t.hasClass("aui-message-warning"),"timeout message is of warning type")):equal(t.length,0,e)},this);this.initializeView(),this.sandbox.server.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({result:"OK"})),this.sandbox.server.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify({steps:this.stepsForResponse(this.steps.environmentPending)})),this.sandbox.clock.tick(299e3),this.assertSteps(this.steps.environmentPending),ok(this.hasLagMessage("environment"),"environment step has lag message"),s(!1,"has no warning before timeout"),this.sandbox.clock.tick(1001),this.assertSteps(this.steps.environmentPending),ok(!this.hasLagMessage("environment"),"environment step has no lag message after timeout"),s(!0,"warning present after timeout"),this.assertSteps(this.steps.environmentPending),ok(!this.hasLagMessage("environment"),"environment step has no lag message"),this.sandbox.clock.tick(300001),ok(!this.hasLagMessage("environment"),"environment step has no lag message after timeout"),s(!0,"has timeout message for the second time"),this.sandbox.server.requests[4].respond(200,{"Content-Type":"application/json"},JSON.stringify({steps:this.stepsForResponse(this.steps.finishingSuccess)})),this.assertSteps(this.steps.finishingSuccess),this.sandbox.clock.tick(1),this.sandbox.server.requests[5].respond(200,{"Content-Type":"application/json"},JSON.stringify({redirectUrl:"whatever"})),equal(this.sandbox.server.requests.length,6,"there were only six requests to the server"),this.sandbox.clock.tick(3e3),equal(this.currentView().ui.summary.text(),"setup.finishing.finished.description","summary view is rendered")}),test("onbeforeunload is a function",function(){this.initializeView(),this.sandbox.stub(this.currentView(),"bootstrapStatePulling"),equal(window.onbeforeunload(),"setup.finishing.navigation.warning"),this.sandbox.clock.tick(1),sinon.assert.calledOnce(this.currentView().bootstrapStatePulling)})});