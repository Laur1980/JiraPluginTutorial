AJS.test.require("jira.webresources:jira-setup",function(){var e=require("jquery"),t=JIRA.Templates.Setup.layoutContent({}),s=require("jira/setup/setup-language-view");module("JIRA setup language dialog",{setup:function(){this.sandbox=sinon.sandbox.create({useFakeServer:!0}),this.lastRequestIndexToRespond=0,e("#qunit-fixture").html(t),this.view=new s({el:"#jira-setup-language-dialog",reloadFunction:this.reloadFunctionSpy,reloadFunctionContext:this.reloadFunctionContext}),this.view.showInitial()},respondToLastRequest:function(e,t){var t=t||{},s=this.sandbox.server.requests.length-1;equal(s,this.lastRequestIndexToRespond,"expecting particular number of requests in the queue"),this.sandbox.server.requests[s].respond(e,{"Content-Type":"application/json"},JSON.stringify(t)),this.lastRequestIndexToRespond++},respondToGetInitialListOfInstalledLocales:function(){this.respondToLastRequest(200,{currentLocale:"en_UK",locales:{de_DE:"Deutsch (Deutschland)",en_UK:"English (UK)"}})},respondToGetInitialListOfInstalledLocalesWithError:function(){this.respondToLastRequest(500)},respondToLocaleChangeWithNewI18nTexts:function(){this.respondToLastRequest(200,{button:"button"})},respondToLocaleChangeWithError:function(){this.respondToLastRequest(500)},selectLocale:function(e){var t=this.view.ui.select.find("option[value='"+e+"']").data("descriptor");this.view.langSingleSelect.setSelection(t)},startView:function(){this.view.start(),this.respondToGetInitialListOfInstalledLocales()},teardown:function(){this.view.remove(),this.sandbox.restore()}}),test("after dialog is open should request installed locales and allow to select a new locale only after successful response",function(){this.view.start(),equal(this.view.ui.spinner.length,1,"spinner is visible"),equal(this.view.ui.select.length,0,"language select is not present"),this.respondToGetInitialListOfInstalledLocales(),equal(this.view.ui.spinner.length,0,"spinner is not present"),equal(this.view.ui.select.length,1,"language select is present"),equal(this.view.ui.select.val(),"en_UK","default locale is selected"),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled")}),test("should show a warning if cannot obtain list of installed locales from the server",function(){this.view.start(),this.respondToGetInitialListOfInstalledLocalesWithError(),equal(this.view.ui.spinner.length,0,"spinner is not present"),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled"),equal(this.view.ui.warning.length,1,"warning is present");var e=this.sandbox.spy();this.view.on("cancel-requested",e),this.view.ui.cancel.click(),sinon.assert.calledOnce(e,"cancel link works as expected")}),test("save button should be enabled only if locale different than current is chosen",function(){this.startView(),this.selectLocale("en_UK"),equal(this.sandbox.server.requests.length,1,"no request made if the same locale as current selected"),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled"),this.selectLocale("de_DE"),this.respondToLocaleChangeWithNewI18nTexts(),equal(this.view.ui.button.is(":disabled"),!1,"submit button is enabled"),this.selectLocale("en_UK"),this.respondToLocaleChangeWithNewI18nTexts(),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled")}),test("after new locale is selected, should get list of texts in new language and apply them",function(){this.startView(),equal(this.view.ui.button.text(),"common.words.save","button has default label"),this.selectLocale("de_DE"),this.respondToLocaleChangeWithNewI18nTexts(),equal(this.view.ui.button.text(),"button","button's label is changed")}),test("should show a warning if cannot obtain list of texts in new language from the server",function(){this.startView(),this.selectLocale("de_DE"),this.respondToLocaleChangeWithError(),equal(this.view.ui.footerSpinner.hasClass("hidden"),!0,"footer spinner is hidden"),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled"),equal(this.view.ui.warning.length,1,"warning is present");var e=this.sandbox.spy();this.view.on("cancel-requested",e),this.view.ui.cancel.click(),sinon.assert.calledOnce(e,"cancel link works as expected")}),test("while making request for texts language select and submit button should be disabled and spinner should be visible",function(){this.startView(),this.selectLocale("de_DE"),equal(this.view.langSingleSelect.$container.hasClass("aui-disabled"),!0,"language select is disabled"),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled"),equal(this.view.ui.footerSpinner.hasClass("hidden"),!1,"footer spinner is visible"),this.respondToLocaleChangeWithNewI18nTexts(),equal(this.view.langSingleSelect.$container.hasClass("aui-disabled"),!1,"language select is enabled"),equal(this.view.ui.button.is(":disabled"),!1,"submit button is enabled"),equal(this.view.ui.footerSpinner.hasClass("hidden"),!0,"footer spinner is hidden")}),test("clicking on cancel link raises an event",function(){this.startView();var e=this.sandbox.spy();this.view.on("cancel-requested",e),this.view.ui.cancel.click(),sinon.assert.calledOnce(e,"cancel link works as expected")}),test("saving new locale should disable form, request the server to change the language and finally reload the page",function(){var e=this.sandbox.stub(this.view,"_languageChangeComplete");this.startView(),this.selectLocale("de_DE"),this.respondToLocaleChangeWithNewI18nTexts(),this.view.ui.button.click(),equal(this.view.langSingleSelect.$container.hasClass("aui-disabled"),!0,"language select is disabled"),equal(this.view.ui.button.is(":disabled"),!0,"submit button is disabled"),equal(this.view.ui.footerSpinner.hasClass("hidden"),!1,"footer spinner is visible");var t=this.sandbox.server.requests[2];t.respond(200,{"Content-Type":"application/json"},JSON.stringify({})),notEqual(t.url.indexOf("!changeLanguage.jspa"),-1,"should call the correct action"),equal(t.requestBody,"jiraLanguage=de_DE","should send chosen locale"),sinon.assert.calledOnce(e,"should reload page")})});