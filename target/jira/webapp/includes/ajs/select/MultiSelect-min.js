define("jira/ajs/select/multi-select",["jira/util/formatter","jira/ajs/layer/layer-constants","jira/ajs/select/multi-select/lozenge","jira/ajs/select/multi-select/lozenge-group","jira/ajs/select/queryable-dropdown-select","jira/ajs/select/select-helper","jira/ajs/select/select-model","jira/ajs/select/suggestions/select-suggest-handler","jira/ajs/layer/inline-layer-factory","jira/ajs/list/list","jira/ajs/list/item-descriptor","jira/util/navigator","jira/util/objects","jira/util/assistive","jquery"],function(e,t,i,s,n,o,r,l,a,u,h,d,c,p,f){"use strict";return n.extend({init:function(e){return this._setOptions(e)===this.INVALID?this.INVALID:(f.extend(this,o),this.options.element=f(this.options.element),this.lozengeGroup=this.options.itemGroup,this._createSelectModel(),this.options.disabled?(this._createFurniture(!0),this):(this._createFurniture(),this._createSuggestionsController(),this._createListController(),this._createDropdownController(),this._assignEventsToFurniture(),this._setInitState(),this.options.width&&this.setFieldWidth(this.options.width),void this.model.$element.addClass("multi-select-select").trigger("initialized",[this])))},_createSelectModel:function(){this.model=new r({element:this.options.element,removeOnUnSelect:this.options.removeOnUnSelect})},_setInitState:function(){this._restoreSelectedOptions(),this.options.inputText&&(this.$field.val(this.options.inputText),this.updateFreeInputVal())},_createListController:function(){var e=this;this.listController=new u({containerSelector:f(".aui-list",this.$container),groupSelector:"ul.aui-list-section",matchingStrategy:this.options.matchingStrategy,maxInlineResultsDisplayed:this.options.maxInlineResultsDisplayed,expandAllResults:this.options.expandAllResults,selectionHandler:function(t){return e._selectionHandler(this.getFocused(),t),!1}})},_createDropdownController:function(){var e=this;this.dropdownController=a.createInlineLayers({alignment:t.LEFT,offsetTarget:this.$field,maxInlineResultsDisplayed:this.options.maxInlineResultsDisplayed,content:f(".aui-list",this.$container)}),this.options.layerId&&(this.dropdownController.options.id=this.options.layerId),this.dropdownController.onhide(function(){e.hideSuggestions()})},_createSuggestionsController:function(){var e=this.options.suggestionsHandler?this.options.suggestionsHandler:l;this.suggestionsHandler=new e(this.options,this.model)},_getDefaultOptions:function(){return f.extend(!0,this._super(),{minRoomForText:50,errorMessage:e.I18n.getText("jira.ajax.autocomplete.error"),showDropdownButton:!0,itemGroup:new s,suggestionsHandler:l,itemBuilder:function(e){return new i({label:e.label(),title:e.title(),container:this.$selectedItemsContainer})}})},_createFurniture:function(e){var t=this.model.$element.attr("id");if(this.model.$element.prev().hasClass("ajs-multi-select-placeholder")&&this.model.$element.prev().remove(),e)this.model.$element.replaceWith(this._render("disableSelectField",t));else{this.$container=this._render("container",t),this.$field=this._render("field",t).appendTo(this.$container),this.$label=f("label[for="+f.escapeSelector(t)+"]"),this.$label.length&&this.$label.attr("for",this.$field.attr("id"));var i=this._render("suggestionsContainer",t);this.$container.append(i),this.suggestionsContainerId=i.attr("id"),this.$container.insertBefore(this.model.$element),this.$dropDownIcon=this._render("dropdownAndLoadingIcon",this._hasDropdownButton()).appendTo(this.$container),this.$errorMessage=this._render("errorMessage",t),this.$selectedItemsWrapper=this._render("selectedItemsWrapper").appendTo(this.$container),this.$selectedItemsContainer=this._render("selectedItemsContainer").appendTo(this.$selectedItemsWrapper)}},_assignEventsToFurniture:function(){var e=this;this._super(),this._assignEvents("body",document),this._assignEvents("selectedItemsContainer",this.$selectedItemsContainer),this._assignEvents("lozengeGroup",this.lozengeGroup),this.model.$element.bind("updateOptions",function(){e.options=f.extend(!0,e.options,e.model.$element.getOptionsFromAttributes()),e._createSuggestionsController()}).bind("selectOption",function(t,i){e.addItem(i)}).bind("removeOption",function(t,i){e.removeItem(i)}).bind("clearSelection",function(){e.clearLozenges()}).bind("showSuggestions",function(t){e._handleDown(t)}).bind("hideSuggestions",function(){e.hideSuggestions()})},_getUserInputValue:function(){return this.options.uppercaseUserEnteredOnSelect?this.$field.val().toUpperCase():this.$field.val()},clear:function(){this.$field.val(""),this.hideSuggestions(),this.clearSelection()},clearSelection:function(){this.model.setAllUnSelected(),this.updateItemsIndent(),this.model.$element.trigger("unselect",[this])},clearLozenges:function(){this.lozengeGroup.removeAllItems(),this.clear()},removeItem:function(e){var t=this;this.model.setUnSelected(e),window.setTimeout(function(){t.updateItemsIndent()},0),this.model.$element.trigger("unselect",[e,this])},_restoreSelectedOptions:function(){var e=this;f.each(this.model.getDisplayableSelectedDescriptors(),function(){e.addItem(this,!0)}),this.updateItemsIndent()},_shouldEnableLozengeGroup:function(){return this.lozengeGroup.items.length>0&&this.lozengeGroup.index<0&&(0===this.$field.val().length||0===this.getCaret(this.$field[0]))},_handleBackSpace:function(){var e=this;this._shouldEnableLozengeGroup()&&setTimeout(function(){e.lozengeGroup.shiftFocus(-1)},0)},_handleLeft:function(){if(this._shouldEnableLozengeGroup()){var e=this;setTimeout(function(){e.lozengeGroup.shiftFocus(-1)},0)}},updateItemsIndent:function(){var e=this._getInputIndent(),t=e.top+20;this.$container&&this.$container.closest(".inline-edit-fields").size()?t+=0:t+=6,this.$field.css({paddingTop:e.top,paddingLeft:e.left}),this.$field.css({height:t}),this.currentTopOffset&&this.currentTopOffset!==e.top&&this.$container.trigger("multiSelectHeightUpdated",[this]),d.isIE()&&d.majorVersion()<11&&(this.$field.val(this.$field.val()+" "),this.$field.val(this.$field.val().replace(/\s$/,""))),this.currentTopOffset=e.top},_isItemPresent:function(e){var t=!1,i=e.value();return f.each(this.lozengeGroup.items,function(){if(this.value===i)return t=!0,!1}),t},addItem:function(e,t){if(e instanceof h&&(e=c.copyObject(e.allProperties(),!1)),e.value=f.trim(e.value),e.label=f.trim(e[this.options.itemAttrDisplayed])||e.value,e.title=f.trim(e.title)||e.label,e=new h(e),!this._isItemPresent(e)){var i=this.options.itemBuilder.call(this,e);this.lozengeGroup.addItem(i),this._assignEvents("lozenge",i),this.model.setSelected(e),this.updateItemsIndent(),this.dropdownController.setPosition(),i.value=e.value(),t||this.model.$element.trigger("selected",[e,this])}},_addMultipleItems:function(e,t){var i=this;f.each(e,function(e,s){t&&(s.removeOnUnSelect=!0),i.addItem(s)})},_getInputIndent:function(){var e,t,i,s,n=this.lozengeGroup.items.length-1;return i={top:4,left:5},n>=0&&(s=this.lozengeGroup.items[n].$lozenge,e=s.prop("offsetTop"),t=s.prop("offsetLeft")+s.outerWidth(),t>this.$container.width()-21-this.options.minRoomForText&&(e+=s.prop("offsetHeight"),t=0),i.top+=e,i.left+=t),i},_selectionHandler:function(e,t){var i=this;e.each(function(){i.addItem(f.data(this,"descriptor"))}),this.$field.val("").focus().scrollIntoView({margin:20}),this.hideSuggestions(),this.hideErrorMessage(),this.updateFreeInputVal(),this.model.$element.trigger("change"),t.preventDefault()},isValidItem:function(e){var t=this.listController.getFocused().data("descriptor");return!!t&&((e=e.toLowerCase())===f.trim(t.label.toLowerCase())||e===f.trim(t.value.toLowerCase()))},handleFreeInput:function(){var e,t=f.trim(this.$field.val());t&&(e=this.model.getDescriptor(t),e?(this.addItem(e),this.model.$element.trigger("change"),this.$field.val(""),this.hideErrorMessage(),this.updateFreeInputVal()):this.options.submitInputVal||this.showErrorMessage(t))},submitForm:function(){0!==this.$field.val().length||this.suggestionsVisible||f(this.$field[0].form).submit()},_handleCharacterInput:function(e,t){this._super(e,t),this.updateFreeInputVal()},_deactivate:function(){this.handleFreeInput(),this.lozengeGroup.trigger("blur"),this.hideSuggestions()},keys:{Left:function(){this._handleLeft()},Backspace:function(){this._handleBackSpace()},Return:function(e){this.submitForm(),e.preventDefault()},Tab:function(){this.acceptFocusedSuggestion()}},_events:{body:{tabSelect:function(){this.$field.is(":visible")&&this.updateItemsIndent()},multiSelectRevealed:function(){this.$field.is(":visible")&&this.updateItemsIndent()}},field:{blur:function(){this.ignoreBlurEvent?(this.ignoreBlurEvent=!1,this.$field.focus()):this._deactivate()},"aui:keydown aui:keypress":function(e){this.lozengeGroup.index>=0&&(e.key in this.lozengeGroup.keys?e.preventDefault():"Return"===e.key?(this.submitForm(),e.preventDefault()):(this.onEdit(e),this.lozengeGroup.trigger("blur")))},click:function(){this.lozengeGroup.trigger("blur"),this.$field.focus()}},lozengeGroup:{focus:function(){this.$field.focus(),this.hideSuggestions(),this._unassignEvents("keys",this.$field),this.$field.attr("aria-controls",this.suggestionsContainerId)},blur:function(){this._assignEvents("keys",this.$field),this.$field.removeAttr("aria-controls"),this.$field.val()&&this._handleCharacterInput()}},lozenge:{remove:function(e){this.removeItem(this.model.getDescriptor(e.target.value)),this.$field.focus()},focus:function(e){p.wait(function(){this.$field.attr("aria-activedescendant",e.currentTarget.$lozenge.attr("id"))}.bind(this))},blur:function(){this.$field.removeAttr("aria-activedescendant")}},selectedItemsContainer:{click:function(e){e.target===e.currentTarget&&(this.lozengeGroup.trigger("blur"),this.$field.focus())}}},_renders:{errorMessage:function(e){return f('<div class="error" />').attr("id",e+"-error")},selectedItemsWrapper:function(){return f('<div class="representation" />')},selectedItemsContainer:function(){return f('<ul class="items" role="listbox" />')},field:function(e){return this._render("baseField","textarea").attr({id:e+"-textarea",class:"text long-field",wrap:"off"})},disableSelectField:function(e){return f("<input type='text' class='long-field' />").attr({name:e,id:e})},container:function(e){return f('<div class="jira-multi-select long-field" />').attr("id",e+"-multi-select")},suggestionsContainer:function(e){return f('<div class="aui-list" tabindex="-1" />').attr("id",e+"-suggestions")}}})}),AJS.namespace("AJS.MultiSelect",null,require("jira/ajs/select/multi-select"));