AJS.test.require(["jira.webresources:select-pickers"],function(){"use strict";var e=require("underscore"),t=require("jquery"),r=require("jira/ajs/select/select-model"),s=require("jira/ajs/select/suggestions/assignee-suggest-handler"),o=require("jira/ajs/select/suggestions/checkbox-multi-select-suggest-handler"),n=require("jira/ajs/select/suggestions/only-new-items-suggest-handler");module("CheckboxMultiSelectSuggestHandler"),test("Does not show duplicate selected values for empty query",function(){var e=t("<select multiple='true'><optgroup label='stuff'><option value='xxx' selected='true'></option></optgroup><optgroup label='more'><option value='xxx' selected='true'></option></optgroup></select>"),s=new r({element:e}),n=new o({},s),l=n.formatSuggestions([],"");equal(l.length,1);var a=l[0];equal(a.items().length,1)}),test("Footer text only shows for empty query",function(){expect(2);var e=t("<select multiple='true'><optgroup label='stuff'><option value='xxx' selected='true'></option></optgroup></select>"),o=new r({element:e}),n=new s({ajaxOptions:{url:"",query:!0}},o);n.execute("").done(function(e){equal("user.picker.ajax.short.desc",e[0].footerText())}),n.execute("a").done(function(e){ok(!e[0].footerText())})}),test("Clear link shows when there are 2 or more suggestions",function(){expect(2);var e=t("<select multiple='true'><optgroup label='stuff'><option value='zzz' selected='true'></option><option value='xxx' selected='true'></option></optgroup></select>"),s=new r({element:e}),n=new o({},s);n.execute("").done(function(e){equal(t(e[0].actionBarHtml()).find(".clear-all").length,1,"expected clear all to be added because there are 2 selected")}),e=t("<select multiple='true'><optgroup label='stuff'><option value='xxx' selected='true'></option><option value='xxx2'></optgroup></select>"),s=new r({element:e}),n=new o({},s),n.execute("").done(function(e){equal(t(e[0].actionBarHtml()).find(".clear-all").length,0,"expected clear all not to be added because there is only 1 selected")})}),test("Queued requests are fired after keyInput period",function(){var e=new AJS.AjaxDescriptorFetcher({query:!0,formatResponse:function(e){return new AJS.ItemDescriptor({value:e.correctData,label:e.correctData})}}),t=sinon.spy(),r=sinon.spy(),s=sinon.useFakeTimers(),o=sinon.fakeServer.create();e.execute("a").done(t),e.execute("ab").done(r),s.tick(300),ok(o.requests[0].aborted,"first request should be aborted"),equal(t.callCount,0,"first request should never return."),o.requests[1].respond(200,{"Content-Type":"application/json"},JSON.stringify({correctData:"correctData"})),equal(r.args[0][0].value(),"correctData")}),test("Preserves search results items even if they already are in the suggestions",function(){var e=t("<select multiple='true'></select>"),s=new r({element:e}),n=sinon.fakeServer.create(),l=sinon.useFakeTimers(),a=new o({content:"mixed",ajaxOptions:{url:"fake",formatResponse:function(e){return new AJS.ItemDescriptor({value:e.value,label:e.label})}}},s);s.getAllDescriptors=function(){return[new AJS.ItemDescriptor({value:"val1",label:"Value 1"}),new AJS.ItemDescriptor({value:"val2",label:"Value 2"})]},a.execute("query").done(function(e){equal(e[0].items()[0].value(),"val1"),equal(e[0].items()[0].label(),"*Value 1*"),equal(e[0].items()[1].value(),"val2"),equal(e[0].items()[1].label(),"Value 2"),equal(e[0].items().length,2)}),n.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({value:"val1",label:"*Value 1*"})),l.tick(300)}),test("MixedDescriptorFetcher with suggestion at top",function(){var r=t("<select multiple='true'><optgroup label='stuff'><option value='xxx' selected='true'></option></optgroup></select>"),s=new AJS.SelectModel({element:r}),o=sinon.fakeServer.create();new AJS.MixedDescriptorFetcher({ajaxOptions:{url:"fake",minQueryLength:0,formatResponse:function(e){return e}},suggestionAtTop:!0},s).execute("").done(function(t){ok(e.isEqual(t[0],s.getAllDescriptors()[0]))}),o.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({value:"val1",label:"*Value 1*"}))}),test("MixedDescriptorFetcher with suggestion at bottom",function(){var r=t("<select multiple='true'><optgroup label='stuff'><option value='xxx' selected='true'></option></optgroup></select>"),s=new AJS.SelectModel({element:r}),o=sinon.fakeServer.create();new AJS.MixedDescriptorFetcher({ajaxOptions:{url:"fake",minQueryLength:0,formatResponse:function(e){return e}},suggestionAtTop:!1},s).execute("").done(function(t){ok(e.isEqual(t[1],s.getAllDescriptors()[0]))}),o.requests[0].respond(200,{"Content-Type":"application/json"},JSON.stringify({value:"val1",label:"*Value 1*"}))}),module("OnlyNewItemsSuggestHandler",{setup:function(){var e=t("<select multiple='true'><option value='stuff'>Stuff</option><option value='more'>A ? for you</option></select>"),s=new r({element:e});this.suggestHandler=new n({userEnteredOptionsMsg:"Create new"},s)}}),test("Query that doesn't match any existing items gets mirrored",function(){strictEqual(this.suggestHandler.validateMirroring("Other"),!0)}),test("Query that matches an existing item doesn't get mirrored",function(){strictEqual(this.suggestHandler.validateMirroring("Stuff"),!1)}),test("Query that only partially matches an existing item gets mirrored",function(){strictEqual(this.suggestHandler.validateMirroring("Stuf"),!0)}),test("Query with a matching item that differs only by case does not get mirrored",function(){strictEqual(this.suggestHandler.validateMirroring("sTuFf"),!1)}),test("Query with special symbols that differs only by case does not get mirrored",function(){strictEqual(this.suggestHandler.validateMirroring("a ? for YOU"),!1)})});