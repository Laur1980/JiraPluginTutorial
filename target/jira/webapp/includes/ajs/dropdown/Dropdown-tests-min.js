AJS.test.require(["jira.webresources:key-commands","jira.webresources:dropdown"],function(){function e(e){return e.click?e.click():o(e).click()}function t(e){return e.focus?e.focus():o(e).focus()}function i(e,t){t=t||document,o(t).trigger({type:"keydown",keyCode:e,which:e})}var s,n,o=require("jquery");module("Dropdown Menus",{setup:function(){this.clock=sinon.useFakeTimers(),n=o("<a id='trigger' href='#whoops'>Trigger</a>").appendTo("#qunit-fixture"),s=o("<div id='dropDown' class='aui-list'><ul id='list_id'><li><a id='test-link-1' href='/test/path/1'>Test 1</a></li><li><a id='test-link-2' href='/test/path/2'>Test 2</a></li><li><a id='test-link-3' href='/test/path/3'>Test 3</a></li></ul></div>")},teardown:function(){this.clock.restore(),o(".ajs-layer").remove(),s.remove(),n.remove()}}),test("Pressing enter on the trigger should open the dropdown and not follow the trigger's link",function(){n.appendTo(document.body),AJS.Dropdown.create({content:s,trigger:n}),equal(s.is(":visible"),!1,"should not be visible upon creation"),t(n),i(13,n),equal(s.is(":visible"),!0,"should be visible when the enter key is pressed on the trigger"),equal(window.location.hash,"","the URL hash should not have changed to '#whoops' as a result of activating the trigger"),equal(n.get(0)===document.activeElement,!0,"focus should stay on the trigger because this dropdown is not an auto-focus dropdown")}),test("Activating trigger multiple times should toggle the dropdown in a human-friendly way",function(){n.appendTo(document.body),AJS.Dropdown.create({content:s,trigger:n}),equal(s.is(":visible"),!1,"should not be visible upon creation"),i(13,n),i(13,n),equal(s.is(":visible"),!0,"should be visible despite interacting with the toggle twice"),this.clock.tick(4),i(13,n),equal(s.is(":visible"),!1,"should disappear after the second interaction"),this.clock.tick(4),e(n),i(13,n),e(n)}),test("Pressing enter on a trigger for an autofocus dropdown should focus the first dropdown item when opened",function(){n.appendTo(document.body),AJS.Dropdown.create({content:s,trigger:n,focusFirstItem:!0}),t(n),i(13,n),equal(n.get(0)===document.activeElement,!1,"focus should not be on the trigger because this dropdown is an auto-focus dropdown"),equal(o("#test-link-1").get(0)===document.activeElement,!0,"focus should be on the first menu item")}),test("Pressing escape while keyboard focus is inside the dropdown should return focus to the trigger",function(){n.appendTo(document.body),AJS.Dropdown.create({content:s,trigger:n}),t(n),i(13,n),i(40),equal(document.activeElement===document.getElementById("test-link-1"),!0,"the first dropdown item should be focussed"),this.clock.tick(4),i(27),equal(document.activeElement===n.get(0),!0,"the dropdown's trigger should be focussed")}),test("Clicking outside the dropdown should NOT return focus to the trigger",function(){var d=o("<textarea>Click me!</textarea>").appendTo("#qunit-fixture");n.appendTo(document.body),AJS.Dropdown.create({content:s,trigger:n}),t(n),i(13,n),i(40),equal(document.activeElement===document.getElementById("test-link-1"),!0,"the first dropdown item should be focussed"),this.clock.tick(4),e(d.get(0)),equal(document.activeElement===n.get(0),!1,"the dropdown's trigger should NOT be focussed")}),module("Dropdown Menu Items",{setup:function(){n=o("<button type='button' id='trigger'>Trigger</button>").appendTo("#qunit-fixture")},teardown:function(){o(".ajs-layer").remove(),s.remove(),n.remove()}}),test("An arrow keypress does not select hidden list entries",function(){s=o("<div id='dropDown' class='aui-list'><ul id='list_id'><li id='visible-list-entry'><a id='test-link-1' href='/test/path/1'>Test 1</a></li><li id='hidden-list-entry' class='hidden'><a id='test-link-2' href='/test/path/2'>Test 2</a></li></ul></div>"),AJS.Dropdown.create({content:s,trigger:n}),e(n),i(40),equal(o("#visible-list-entry").hasClass("active"),!0,"First LI has active class when down pressed once."),equal(o("#visible-list-entry").find("a").get(0)===document.activeElement,!0,"Menu item link should have document focus"),i(40),equal(o("#hidden-list-entry").hasClass("active"),!1,"Hidden LI doesn't have active class when down pressed twice."),equal(o("#hidden-list-entry").find("a").get(0)===document.activeElement,!1,"Hidden LI should not have document focus.")}),test("An arrow keypress does not select nested list entries",function(){s=o("<div id='dropDown'><ul id='nested_list_id'><li id='first-level-list-entry-1'><ul><li id='nested-list-entry'><a id='test-link-1' href='/test/path/1'>Test 1</a></li></ul></li><li id='first-level-list-entry-2'><a id='test-link-2' href='/test/path/2'>Test 2</a></li></ul></div>"),AJS.Dropdown.create({content:s,trigger:n}),e(n),i(40),equal(o("#nested-list-entry").hasClass("active"),!1,"Nested LI does not have active class when down pressed once."),equal(o("#first-level-list-entry-1").hasClass("active"),!0,"Top level LI has active class when down pressed once."),i(40),ok(o("#first-level-list-entry-2").hasClass("active"),"Second top level LI has active class when down pressed twice."),ok(o("#first-level-list-entry-2").find("a").get(0)===document.activeElement,!0,"Second menu item should have document focus when down pressed twice.")}),test("An arrow keypress does not select an list entry with no anchor",function(){s=o("<div id='dropDown'><ul id='nested_list_id'><li id='empty-first-level-list-entry'><ul></ul></li><li id='first-level-list-entry-1'><a id='test-link-1' href='/test/path/1'>Test 1</a></li></ul></div>"),AJS.Dropdown.create({content:s,trigger:n}),e(n),i(40),equal(o("#empty-first-level-list-entry").hasClass("active"),!1,"Empty LI does not have active class when down pressed."),equal(o("#first-level-list-entry-1").hasClass("active"),!0,"First level LI has active class when down pressed once."),equal(o("#first-level-list-entry-1").find("a").get(0)===document.activeElement,!0,"First level menu item should have document focus when down pressed once.")})});