AJS.test.require(["jira.webresources:list"],function(){require(["jira/ajs/list/list","jira/ajs/list/item-descriptor","jquery","underscore"],function(t,e,i,l){module("AJS.List",{buildList:function(){var s=i("#qunit-fixture"),n={containerSelector:s,delegateTarget:s,stallEventBind:!1,expandAllResults:!0},a={},u=[];return{withMaxResultsDisplayed:function(t){return a.maxInlineResultsDisplayed=t,this},withExpandAllResults:function(t){return a.expandAllResults=t,this},withTotalResults:function(t){return u.push(function(i){for(var l=[],s=0;s<t;s++)l.push(new e({highlighted:!0,label:"Label #"+s,title:"Title #"+s}));i.generateListFromJSON(l,"Label")}),this},withData:function(t){return u.push(function(e){e.generateListFromJSON(t,"Label")}),this},withEventsEnabled:function(){return u.push(function(t){t.enable()}),this},withScrollAtItem:function(t){return u.push(function(){var e=i.Event("keydown");e.which=i.ui.keyCode.DOWN;for(var l=0;l<t;l++)s.trigger(e)}),this},build:function(){var e=new t(l.defaults(a,n));return l.each(u,function(t){t(e)}),e}}},pressDownArrowOn:function(t){var e=i.Event("keydown");e.which=i.ui.keyCode.DOWN,t.trigger(e)}}),test("List should use title from AJS.ItemDescriptor",function(){var t=[new e({label:"Label with title",title:"some tile"}),new e({label:"Label without title"}),new e({label:"Label with empty tile",title:""})];this.buildList().withData(t).build();var l=i("#qunit-fixture").find(".aui-list-item-link");equal(l.length,3,"There should be three links rendered"),equal(i(l.get(0)).prop("title"),t[0].title(),"Link have valid title"),equal(i(l.get(0)).text(),t[0].label(),"Link have valid text"),equal(i(l.get(1)).text(),t[1].label(),"Link have valid text"),equal(i(l.get(2)).text(),t[2].label(),"Link have valid text")}),test("Protect against XSS vulnerability injected in descriptor icon",function(){var t={xssCall:function(){}};sinon.mock(t).expects("xssCall").never(),window.xssCall=t.xssCall;var e=[new AJS.ItemDescriptor({label:"Label with title",title:"some tile",icon:function(){return'genericissue.png"><script>window.xssCall()<\/script>'}})];this.buildList().withData(e).build(),window.xssCall=null,expect(0)}),test("It limits the number of results displayed",function(){this.buildList().withMaxResultsDisplayed(10).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find(".aui-list-item-link").length,10,"Only 10 links are rendered")}),test("It displays a 'View more' link when there is too many results if expandAllResults is true",function(){this.buildList().withMaxResultsDisplayed(10).withExpandAllResults(!0).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find("button.view-all").length,1,"There is one 'view-all' button")}),test("It does not display a 'View more' link when there is too many results if expandAllResults is false",function(){this.buildList().withMaxResultsDisplayed(10).withExpandAllResults(!1).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find("button.view-all").length,0,"There is not 'view-all' button")}),test("'View more' expand the list so it contains all the results",function(){this.buildList().withMaxResultsDisplayed(10).withTotalResults(20).build();var t=i("#qunit-fixture");t.find("button.view-all").click(),equal(t.find(".aui-list-item-link").length,20,"All the results are rendered")}),test("In a limited list, scrolling down using arrow keys expand all the list when reaching the last item if expandAllResults is true",function(){this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withEventsEnabled().withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t),equal(t.find(".aui-list-item-link").length,6,"All the results are rendered"),equal(t.find("button.view-all").length,0,"The 'view-all' link is removed")}),test("In a limited list, scrolling down using arrow keys does not expand the list when reaching the last item if expandAllResults is false",function(){this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withExpandAllResults(!1).withEventsEnabled().withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t),equal(t.find(".aui-list-item-link").length,3,"Three links are rendered")}),test("It triggers an event when item is active/focused.",function(){var t=this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withExpandAllResults(!1).withEventsEnabled().withScrollAtItem(2).build(),e=sinon.spy();t.bind("itemFocus",e);var l=i("#qunit-fixture");this.pressDownArrowOn(l),this.pressDownArrowOn(l),sinon.assert.calledTwice(e),equal(e.secondCall.args[1],t.getFocused()[0],"Correct item is passed as an argument.")})})});