define("jira/field/create-project-field",["jira/util/formatter","jira/lib/class","jira/ajs/dark-features","jira/project/project-key-generator","jira/project/project-sample","aui/inline-dialog","wrm/context-path","jquery"],function(e,t,i,n,a,r,s,o){"use strict";var l=s();return t.extend({TIMEOUT_MS:100,projectNames:[],maxNameLength:80,init:function(e){this.$element=e.element,this.$nameElement=this.$element.find("input.text[name='name']"),this.$keyElement=this.$element.find("input.text[name='key']"),this.$keyEditedElement=this.$element.find("input[name='keyEdited']"),this.$avatarElement=this.$element.find(".jira-inline-avatar-picker-trigger"),this.eventBus={src:o(this),trigger:function(e,t){this.src.trigger(e,t)},bind:function(e,t){this.src.bind(e,t)}};var t=+this.$keyElement.attr("maxlength");t||(t=10),this.keygen=new n({desiredKeyLength:4,maxKeyLength:t}),this.lastKeyValidated="",i.isEnabled("addproject.project.sample")&&(this.sample=new a({element:this.$element.find("#sample-project-container"),events:this.eventBus})),this.$keyElement.attr("style","text-transform: uppercase"),this.initialName=this.$nameElement.val(),this.initialKey=this.$keyElement.val(),this.$element.find(".error").addClass("description initial-error"),this.showInitialError(this.$nameElement),this.showInitialError(this.$keyElement),this.$nameElement.focus(o.proxy(this._bindNameHook,this)),this.$nameElement.blur(o.proxy(this._unbindHook,this)),this.$keyElement.focus(o.proxy(this._bindKeyHook,this)),this.$keyElement.blur(o.proxy(this._unbindHook,this)),this.$keyElement.blur(o.proxy(this.autofillKeyIfNeeded,this));var s=this.$keyElement.parent().find("#add-project-key-icon").removeAttr("target data-helplink");s.length&&new r(s,"project-key-help-popup",function(e,t,i){e.html(JIRA.Templates.CreateProject.keyHelp()),i()},{width:330,offsetX:-30}),this.$avatarElement.size()&&(this.eventBus.trigger("updated.Avatar",this.$avatarElement.attr("src")),this.$avatarElement.bind("AvatarSelected",o.proxy(function(){this.eventBus.trigger("updated.Avatar",this.$avatarElement.attr("src"))},this))),this._loadExistingProjects()},_loadExistingProjects:function(){var e=this;o.ajax({url:l+"/rest/api/latest/project",success:function(t){t=t||[];for(var i=0,n=t.length;i<n;i++)e.projectNames.push(t[i].name.toUpperCase())}})},_bindNameHook:function(e){this._bindHook(e,this.onNameTimeout)},_bindKeyHook:function(e){var t=o(e.target);t.data("lastValue",t.val()),this._bindHook(e,this.onKeyTimeout)},_bindHook:function(e,t){var i,n=this,a=o(e.target);i=function(){n._unbindHook(e),t.apply(n),a.is(":visible")&&a.data("checkHook",setTimeout(i,n.TIMEOUT_MS))},a.data("checkHook")||a.data("checkHook",setTimeout(i,0))},_unbindHook:function(e){var t=o(e.target);clearTimeout(t.data("checkHook")),t.removeData("checkHook")},shouldUpdateKey:function(){return"true"!==this.$keyEditedElement.val()},setKeyEdited:function(e){this.$keyElement.data("lastValue")!==e&&this.$keyEditedElement.val(e?"true":"false"),this.$keyElement.data("lastValue",e)},updateKey:function(e){this.$keyElement.val(e),this.validateKey(e),this.eventBus.trigger("updated.Key",e)},autofillKeyIfNeeded:function(){if(this.shouldUpdateKey()){var e=this.keygen.generateKey(this.$nameElement.val());e.length>1?this.updateKey(e):this.$keyElement.val("")}},onNameTimeout:function(){var e=this.$nameElement.val();this.validateName(e),this.eventBus.trigger("updated.Name",e),this.autofillKeyIfNeeded()},onKeyTimeout:function(){var e=this.$keyElement.val();this.setKeyEdited(e),this.validateKey(e),this.eventBus.trigger("updated.Key",e)},validateName:function(t){if(t!==this.initialName||!this.$nameElement.parent().find(".error").size()){if(t.length>this.maxNameLength)return void this.showInlineError(this.$nameElement,this.initialName,e.I18n.getText("admin.errors.project.name.too.long",this.maxNameLength));for(var i=0,n=this.projectNames.length;i<n;i++)if(t.toUpperCase()===this.projectNames[i])return void this.showInlineError(this.$nameElement,this.initialName,e.I18n.getText("admin.errors.project.with.that.name.already.exists"));this.hideInlineError(this.$nameElement)}},validateKey:function(e){var t=this,i=t.lastKeyValidated!==e;this.lastKeyValidated=e,i&&(e?o.ajax({url:l+"/rest/api/latest/projectvalidate/key?key="+e.toUpperCase(),success:function(e){e.errors&&e.errors.projectKey?t.showInlineError(t.$keyElement,t.initialKey,e.errors.projectKey):t.hideInlineError(t.$keyElement)}}):t.hideInlineError(t.$keyElement))},showInlineError:function(e,t,i){var n=e.parent().find(".initial-error");if(e.val()===t&&n.length)this.showInitialError(e);else{var a=e.parent().find(".error.description");a.length||(a=o("<div class='error description'></div>"),e.parent().append(a)),a.text(i),e.parent().find(".description").hide(),n.hide(),a.show()}},hideInlineError:function(e){e.parent().find(".description").show(),e.parent().find(".error.description").hide()},showInitialError:function(e){var t=e.parent().find(".initial-error");t.length&&(e.parent().find(".description").hide(),e.parent().find(".error.description").hide(),t.show())}})}),AJS.namespace("JIRA.CreateProjectField",null,require("jira/field/create-project-field"));