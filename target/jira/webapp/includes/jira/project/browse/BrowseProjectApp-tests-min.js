AJS.test.require("jira.webresources:browseprojects",function(){require(["underscore","backbone","jquery"],function(t,e,i){function n(t){for(var e=[],i=1;i<=t;i++)e.push({name:"Cat "+i,id:"cat"+i,description:""});return e}function a(t,e){for(var i,n=[],a=1;a<=t;a++)i=(a-1)%e.length,n.push({id:"p"+a,name:"Project "+a,projectCategoryId:e[i].id,key:"PRJ"+a,hasDefaultAvatar:!0,lead:"admin"});return n}module("BrowseProjectApp",{setup:function(){this.context=AJS.test.mockableModuleContext(),this.navigation=this.context.require("jira/util/navigation"),sinon.stub(this.navigation,"navigate"),this.navigation.pushStateSupported=!0,this.context.mock("jira/util/navigation",this.navigation),this.userUtils={username:sinon.stub().returns("admin")},this.context.mock("jira/util/users/logged-in-user",this.userUtils),this.$container=i('<div><div class="category-nav"></div><div class="aui-page-panel-content"><div class="module"><div class="mod-header" id="filter-projects"></div><div class="mod-content" id="projects"></div></div><div id="pagination"></div></div></div>').appendTo(i("#qunit-fixture")),this.BrowseProjectsApp=this.context.require("jira/project/browse/app"),this.categories=n(5),this.projects=a(100,this.categories),this.categories.push({name:"All Projects",id:"all"}),this.changeContainsFilter=function(t){var e=sinon.useFakeTimers();this.$container.find("#project-filter-text").val(t).trigger("change"),e.tick(310)},this.startApplication=function(t,e,i){e=e||this.projects,i=i||this.categories,this.BrowseProjectsApp.start({projects:e,categories:i,container:this.$container,selectedCategory:t})}}}),test("should select default category on start",function(){this.startApplication("cat1"),equal(this.$container.find(".projects-list tr:first td.cell-type-category a").text(),"Cat 1"),equal(this.$container.find(".projects-list tr").length,20)}),test("should update UI with selected category",function(){this.startApplication("all"),this.$container.find(".projects-list tr:nth-child(2) td.cell-type-category a").click(),equal(this.$container.find(".category-nav #cat2-panel-tab").hasClass("active"),!0),equal(this.$container.find("#filter-projects h2").text(),"Cat 2")}),test("should switch pages when clicking on pagination",function(){this.startApplication("all"),equal(this.$container.find(".aui-nav-pagination .aui-nav-selected").text(),"1","First page is selected"),equal(this.$container.find(".projects-list tr:first td.cell-type-name a").text(),"Project 1"),equal(this.$container.find(".projects-list tr:last td.cell-type-name a").text(),"Project 25"),this.$container.find(".aui-nav-pagination a:eq(2)").click(),equal(this.$container.find(".aui-nav-pagination .aui-nav-selected").text(),"3","Third page is selected"),equal(this.$container.find(".projects-list tr:first td.cell-type-name a").text(),"Project 51"),equal(this.$container.find(".projects-list tr:last td.cell-type-name a").text(),"Project 75")}),test("should filter projects when changing criteria",function(){this.startApplication("all"),this.changeContainsFilter("Project 100"),equal(this.$container.find(".projects-list tr:first td.cell-type-name a").text(),"Project 100"),equal(this.$container.find(".projects-list tr").length,1)}),test("should filter by category on click",function(){this.startApplication("all"),this.$container.find(".category-nav #cat3-panel-tab-lnk").click(),equal(this.$container.find(".projects-list tr:first td.cell-type-category a").text(),"Cat 3"),equal(this.$container.find(".projects-list tr").length,20)}),test("should update url with current state",function(){this.startApplication("all"),this.$container.find(".aui-nav-pagination a:eq(1)").click(),sinon.assert.calledOnce(this.navigation.navigate),sinon.assert.calledWith(this.navigation.navigate,{selectedCategory:"all",selectedProjectType:"",contains:!1,page:2}),this.changeContainsFilter("Project 100"),sinon.assert.calledTwice(this.navigation.navigate),sinon.assert.calledWith(this.navigation.navigate,{selectedCategory:"all",selectedProjectType:"",contains:"Project 100"}),this.$container.find(".category-nav #cat3-panel-tab-lnk").click(),sinon.assert.calledThrice(this.navigation.navigate),sinon.assert.calledWith(this.navigation.navigate,{selectedCategory:"cat3",selectedProjectType:"",contains:"Project 100"})}),test("should diplay message when there no projects match criteria",function(){this.startApplication("all"),this.changeContainsFilter("asdef"),equal(this.$container.find(".projects-list tr").length,1),equal(this.$container.find(".projects-list .no-results").length,1)}),test("should hide sidebar for logged out user when there is only one category",function(){this.userUtils.username.returns(""),this.startApplication("one",[{id:"first",projectCategoryId:"one",key:"frst"}],[{id:"one",name:"One"}]),equal(this.$container.find(".category-nav").hasClass("hidden"),!0),equal(this.$container.find(".category-nav").children().length,0)}),test("should still show sidebar for logged in user when there is only one category",function(){this.startApplication("one",[{id:"first",projectCategoryId:"one",key:"frst"}],[{id:"one",name:"One"}]),equal(this.$container.find(".category-nav").hasClass("hidden"),!1),equal(this.$container.find(".category-nav").children().length,1)})})});