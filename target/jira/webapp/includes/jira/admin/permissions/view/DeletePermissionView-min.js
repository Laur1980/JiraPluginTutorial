define("jira/project/permissions/deletepermissionview",["jira/util/formatter","backbone","jquery","underscore","jira/project/permissions/securitytypes","wrm/context-path"],function(e,t,i,n,s,a){"use strict";return t.View.extend({template:JIRA.Templates.ProjectPermissions.deleteDialog,events:{"change .js-delete-grant":"_handleGrantClick","click #dialog-save-button":"_handleSubmitEvent","click #dialog-close-button":"close"},initialize:function(e){this.grantsToRemove=[],this.permissionSchemeId=e.permissionSchemeId,this.model.on("change:submitDisabled",n.bind(this._handleSubmitState,this)),this.model.on("change:grants",n.bind(this.render,this)),this.dialog=AJS.dialog2(this.$el)},open:function(){this.dialog.show(),this.dialog.on("hide",n.bind(this.close,this)),this.render(),this.trigger("contentLoaded")},render:function(){var e=this.$(".grants"),t=this;n.each(this.model.get("grants"),function(i){e.append(t._renderDeleteGrantControl(i))}),this.model.set("submitDisabled",!0),this._checkFirstCheckboxIfOnlyOneExists()},canSubmit:function(){return!this.model.get("submitDisabled")},submit:function(){this.canSubmit()&&this._removeGrants()},close:function(){this.remove(),this.dialog.remove()},_checkFirstCheckboxIfOnlyOneExists:function(){var e=this.$(".js-delete-grant");1===e.length&&i(e[0]).prop("checked",!0).change()},_handleGrantClick:function(e){var t=parseInt(i(e.target).val());e.target.checked?this.grantsToRemove.push(t):this.grantsToRemove=n.without(this.grantsToRemove,t),this._determineSubmitState()},_determineSubmitState:function(){this.model.set("submitDisabled",0===this.grantsToRemove.length)},_removeGrants:function(){var e=this;e._disableAllFields(),i.ajax({url:a()+"/rest/internal/2/managedpermissionscheme/"+this.permissionSchemeId,type:"DELETE",data:JSON.stringify({grantsToDelete:this.grantsToRemove}),contentType:"application/json",success:function(t){e.trigger("deleteCompleted",t),e.close()},error:function(t){t=t.responseText?JSON.parse(t.responseText):{},e.trigger("deletePermissionError",t),e._enableAllFields()}})},_disableAllFields:function(){this.$el.find("input, button").attr("aria-disabled","true").attr("disabled","disabled")},_enableAllFields:function(){this.$el.find("input, button").attr("aria-disabled","false").removeAttr("disabled")},_handleSubmitEvent:function(e){e.preventDefault(),this.submit()},_renderDeleteGrantControl:function(t){var n=t;return t.securityType===s.GROUP?n=i.extend({emptyDisplayName:e.I18n.getText("admin.common.words.anyone")},t):t.securityType===s.APPLICATION_ROLE&&(n=i.extend({emptyDisplayName:e.I18n.getText("admin.permission.types.application.role.any")},t)),JIRA.Templates.ProjectPermissions.deleteGrant(n)},_handleSubmitState:function(){this.dialog.$el.find("#dialog-save-button").attr("aria-disabled",this.model.get("submitDisabled"))}})});