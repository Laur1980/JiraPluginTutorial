define("jira/project/permissions/addpermissionview",["jira/util/formatter","backbone","jquery","underscore","jira/project/permissions/addgrantcollectionview","wrm/context-path"],function(e,i,t,s,n,o){"use strict";return i.View.extend({events:{"submit #grant-permission-form":"_submitDialog","click #grant-permission-dialog-grant-button":"_submitDialog","click #grant-permission-dialog-close-button":"close","change #permission-target-select":"_handlePermissionTargetSelect","click #security-type-list-more-opts-btn":"_handleSecurityTypeToggleClick"},initialize:function(e){this.permissionSchemeId=this.model.get("permissionSchemeId"),this.schemeModel=e.schemeModel,this.listenToOnce(this.model,"change:grantCollection",this.render),this.listenTo(this.model,"change:showMore",this._toggleShowMore),this.listenTo(this.model,"change:submitDisabled",this._handleSubmitDisabled),this.addDialog=AJS.dialog2(this.$el)},open:function(){this.addDialog.show(),this.addDialog.on("hide",s.bind(this.close,this)),this.render()},render:function(){this.model.set("submitDisabled",!0);var e=this.model.get("grantCollection");e?(this.$("#grant-permission-dialog-content").empty(),e.on("change:selected change:securityTypeParamVal",s.bind(this._handleSecurityTypeSelected,this)),this._renderPermissionTargetSelect(),this._renderSecurityTypeList(),this.trigger("contentLoaded")):this._renderLoadingSpinner()},close:function(){this.remove(),this.addDialog.remove(),this._removeInfoInlineDialogs()},_renderLoadingSpinner:function(){this.$("#grant-permission-dialog-content").html(JIRA.Templates.AddProjectPermission.loadingSpinner())},_removeInfoInlineDialogs:function(){t(".grant-permission-inline-dialog").remove()},_handleSubmitState:function(){var e=this.model.get("grantCollection").getSelectedModel();this.permissionTargetSelect.val()&&null!=e&&e.isValid()&&this.grantsView.isSelectedVisible()?this.model.set("submitDisabled",!1):this.model.set("submitDisabled",!0)},_handlePermissionTargetSelect:function(){this._handleSubmitState()},_handleSecurityTypeSelected:function(){this._handleSubmitState()},_toggleShowMore:function(i,t){t?(this.showMoreBtn.text(e.I18n.getText("admin.permission.project.security.types.less")),this.$(".secondary").show()):(this.showMoreBtn.text(e.I18n.getText("admin.permission.project.security.types.more")),this.$(".secondary").hide()),this._handleSubmitState()},_handleSecurityTypeToggleClick:function(e){e.preventDefault(),this.model.toggleShowMore()},_submitDialog:function(e){if(e.preventDefault(),!this.model.get("submitDisabled")){this._disableAllFields();var i=this.model.get("grantCollection").getSelectedData();if(null!==i){var s=this.permissionTargetSelect.val();t.ajax({url:o()+"/rest/internal/2/managedpermissionscheme/"+this.permissionSchemeId,type:"POST",data:JSON.stringify({permissionKeys:s,grants:[i]}),contentType:"application/json",success:function(e){this.trigger("permissionGranted",e),this.addDialog.remove()}.bind(this),error:function(e){e=e.responseText?JSON.parse(e.responseText):{},this.trigger("grantPermissionError",e),this._enableAllFields()}.bind(this)})}}},_disableAllFields:function(){this.permissionTargetSelect.auiSelect2("container").css("opacity",.7),this.$el.find("input").not("select2-input").attr("aria-disabled","true").attr("disabled","disabled"),this.model.set("submitDisabled",!0)},_enableAllFields:function(){this.permissionTargetSelect.auiSelect2("container").css("opacity",1),this.$el.find("input").not("select2-input").attr("aria-disabled","false").removeAttr("disabled"),this.model.set("submitDisabled",!1)},_renderSecurityTypeList:function(){this.grantsView=new n({collection:this.model.get("grantCollection")}).render(),this.$("#grant-permission-form .field-group").after(this.grantsView.$el),this.showMoreBtn=this.$("#security-type-list-more-opts-btn")},_renderPermissionTargetSelect:function(){var e=this.schemeModel.get("permissions").toJSON();this.$("#grant-permission-dialog-content").html(JIRA.Templates.AddProjectPermission.renderPermissionTargetSelect({selectedPermission:this.model.get("permissionKey"),data:e})),this.permissionTargetSelect=this.$("#permission-target-select"),this.permissionTargetSelect.auiSelect2()},_handleSubmitDisabled:function(e,i){this.$("#grant-permission-dialog-grant-button").attr("aria-disabled",i)}})});