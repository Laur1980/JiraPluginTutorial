AJS.test.require(["jira.webresources:jira-global","jira.webresources:dialogs"],function(){var e=require("jquery"),t=require("underscore"),i=require("jira/dialog/dialog"),o=function(t,o){var r=e("<div>").css({height:"200px"}).append(e("<h2>").text(t)),s={content:function(e){return n.contentCall++,e(r)},height:"200px",windowTitle:t},n=new i(e.extend(s,o));return n.isVisible=function(){return r.is(":visible")},n.contentCall=0,n.title=t,n},r=function(e,t){return function(i){if(i){var o=i.title;ok(i.isVisible(),o+" visible?"),strictEqual(document.title,o,"Title correctly set to '"+o+"'."),n()}else strictEqual(document.title,t,"Title correctly reset.");for(var r=0;r<e.length;r++)e[r]!==i&&ok(!e[r].isVisible(),e[r].title+" not visible?")}},s=function(e){return function(){for(var t=0;t<arguments.length;t++){var i=e[t];strictEqual(i.contentCall,arguments[t],"Content refreshed on '"+i.title+"' "+arguments[t]+" times?")}}},n=function(){ok(0==e(".jira-page-loading-indicator").length,"Throbber is removed when dialog is displayed")};module("Dialog Tests",{teardown:function(){e("."+i.ClassNames.DIALOG).remove()}}),test("Stacked Dialogs Only",function(){var e=o("Dialog3",{stacked:!0}),t=o("Dialog2",{stacked:!0}),i=o("Dialog1",{stacked:!0}),n=[i,t,e],l=document.title,a=document.title="Stacked Dialogs Test",c=r(n,a),d=s(n);i.show(),c(i),d(1,0,0),t.show(),c(t),d(1,1,0),e.show(),c(e),d(1,1,1),e.hide(),c(t),d(1,1,1),e.show(),c(e),d(1,1,2),e.hide(),c(t),d(1,1,2),t.hide(),c(i),d(1,1,2),i.hide(),c(null),d(1,1,2),t.show(),c(t),d(1,2,2),t.hide(),c(null),d(1,2,2),e.show(),c(e),d(1,2,3),i.show(),c(i),d(2,2,3),t.show(),c(t),d(2,3,3),t.hide(),c(i),d(2,3,3),i.hide(),c(e),d(2,3,3),t.show(),c(t),d(2,4,3),t.hide(),c(e),d(2,4,3),e.hide(),c(null),d(2,4,3),document.title=l}),test("Stacked Dialogs Normal With Normal Dialogs",function(){var e=o("Dialog3",{stacked:!0}),t=o("Dialog2",{stacked:!0}),i=o("DialogNotStacked1"),n=o("DialogNotStacked4"),l=[i,t,e,n],a=document.title,c=document.title="Stacked Dialogs with Normal Dialog Test",d=r(l,c),h=s(l);e.show(),d(e),h(0,0,1,0),i.show(),d(i),h(1,0,1,0),n.show(),d(n),h(1,0,1,1),n.hide(),d(null),i.show(),d(i),h(2,0,1,1),i.hide(),t.show(),d(t),h(2,1,1,1),e.show(),d(e),h(2,1,2,1),n.show(),d(n),h(2,1,2,2),n.hide(),d(e),h(2,1,2,2),i.show(),d(i),h(3,1,2,2),n.show(),d(n),h(3,1,2,3),i.show(),d(i),h(4,1,2,3),i.hide(),d(null),document.title=a}),test("Test Simple Dialog Title Change",function(){var e=function(e){e?strictEqual(document.title,e.title,e.title+" title correct?"):strictEqual(document.title,s,"Original Title Restored?")},t=o("Dialog1"),i=o("Dialog2"),r=document.title,s=document.title="Test Dialog Title";t.show(),e(t),i.show(),e(i),i.hide(),e(null),t.show(),e(t),i.show(),e(i),t.show(),e(t),t.hide(),e(null),document.title=r}),test("Test redirect instructions",function(){var e=o("Dialog1"),t={},i={getResponseHeader:function(e){return t[e]}},r=e._detectRedirectInstructions(i);deepEqual(r,{serverIsDone:!1,redirectUrl:""},"No header"),t["X-Atlassian-Dialog-Control"]="DONE",r=e._detectRedirectInstructions(i),deepEqual(r,{serverIsDone:!0,redirectUrl:""},"DONE header"),t["X-Atlassian-Dialog-Control"]="redirect:http://localhost.com",r=e._detectRedirectInstructions(i),deepEqual(r,{serverIsDone:!0,redirectUrl:"http://localhost.com"},"Redirect Header"),t["X-Atlassian-Dialog-Control"]="permissionviolation",r=e._detectRedirectInstructions(i),deepEqual(r,{serverIsDone:!0,redirectUrl:window.location.href},"Permision Voilation")}),module("Dialog headers -- likely to change in JIRA 6.1",{setup:function(){this.$content=e("<p>Practically empty</p>"),this.dialog=new i({content:this.$content})},teardown:function(){this.dialog.hide(),this.$content.remove()}}),test("Can provide plain-text for the heading",function(){var e="This is my dialog heading. It is made from win and awesome.";this.dialog.addHeading(e),notEqual(this.dialog.$popup.text().indexOf(e),-1,"The title text should be present in the dialog")}),test("heading contents are placed inside known container",function(){this.dialog.addHeading("Quite full");var e=this.dialog.$popup.find("."+i.ClassNames.HEADING_AREA);equal(e.text(),"Quite full","The dialog's heading is inside an element with the HTML class from JIRA.Dialog.ClassNames.HEADING_AREA"),equal(e.find("h2").size(),1,"The dialog's heading is contained within an h2 element.")}),test("Can provide HTML for the heading",function(){var e="One flew <i>over</i> the <strong>cuckoo's</strong> nest";this.dialog.addHeading(e);var t=this.dialog.$popup.find("."+i.ClassNames.HEADING_AREA);equal(t.find("h2").html(),e,"HTML is preserved when added to the dialog heading")}),module("Dialog resources",{setup:function(){this.sandbox=sinon.sandbox.create();var t=e("<div>");this.dialogOptions={resources:["resource1","resource2"],contexts:["context1","context2"],content:function(e){return e(t)}},this.context=AJS.test.mockableModuleContext(),this.requireDeferred=new e.Deferred,this.wrmRequire=this.sandbox.stub(),this.context.mock("wrm/require",this.wrmRequire),this.Dialog=this.context.require("jira/dialog/dialog"),this.WRMDialog=this.Dialog.extend({defineResources:function(){this._super.apply(this,arguments),(this.options.resources||[]).forEach(function(e){this.requireResource(e)},this),(this.options.contexts||[]).forEach(function(e){this.requireContext(e)},this)}})},teardown:function(){this.sandbox.restore()}}),test("New dialog instance will not prefetch resources in constructor when prefetchResources field is not true",function(){new this.WRMDialog(this.dialogOptions);ok(this.wrmRequire.notCalled,"require not called")}),test("New dialog instance will prefetch resources in constructor when prefetchResources field is true",function(){new this.WRMDialog(t.extend(this.dialogOptions,{prefetchResources:!0}));ok(this.wrmRequire.calledOnce,"require called once"),deepEqual(this.wrmRequire.getCall(0).args[0],["wr!resource1","wr!resource2","wrc!context1","wrc!context2"],"WRM.require called with proper args")}),test("Show will not download resources if none specified",function(){var e=new this.WRMDialog;ok(this.wrmRequire.notCalled,"require not called after constructor"),e.show(),ok(this.wrmRequire.notCalled,"require not called after show"),e.hide()}),test("Show will download resources once if specified",function(){this.wrmRequire.returns(this.requireDeferred);var e=new this.WRMDialog(this.dialogOptions);ok(this.wrmRequire.notCalled,"require not called after constructor"),e.show(),ok(this.wrmRequire.calledOnce,"require called once"),deepEqual(this.wrmRequire.getCall(0).args[0],["wr!resource1","wr!resource2","wrc!context1","wrc!context2"],"WRM.require called with proper args"),e.hide(),e.show(),ok(this.wrmRequire.calledOnce,"require called once"),e.hide()}),test("Does not show dialog until resources resolved",function(){this.wrmRequire.returns(this.requireDeferred);var e=new this.WRMDialog(this.dialogOptions),t=this.sandbox.spy(e,"_onShowContent");ok(this.wrmRequire.notCalled,"require not called after constructor"),e.show(),ok(this.wrmRequire.calledOnce,"require called once"),ok(t.notCalled),this.requireDeferred.resolve(),ok(t.calledOnce,"showContent called after resources resolve"),e.hide()}),test("Dialog constructor should call options defineResources with itself in scope",function(){var e=this.sandbox.stub(),t=new this.Dialog({defineResources:e});ok(e.calledOnce,"defineResources was called once"),deepEqual(e.getCall(0).thisValue,t,"defineResources called with dialog as this.")})});