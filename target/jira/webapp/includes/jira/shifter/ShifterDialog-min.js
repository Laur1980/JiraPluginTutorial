define("jira/shifter/shifter-dialog",["jira/util/key-code","jira/jquery/deferred","jira/lib/class","jira/data/session-storage","jira/shifter/shifter-select","jira/ajs/list/group-descriptor","jira/ajs/list/item-descriptor-factory","jira/shifter/shifter-analytics","jquery","underscore"],function(t,e,i,n,s,o,r,a,d,u){return i.extend({BLUR_DELAY:50,init:function(t,e,i){this.id=t,this.groups=e,this.options=i,this._render(),this._destroyOnBlur(),this._preventFocusOnNonInputElements(),d(document).on("mousedown.shifterdialog."+t,u.bind(this._destroyOnMousedownOutside,this))},focus:function(){this.$dialog&&this.$dialog.find("input").focus()},destroy:function(){var t=this.$dialog;t&&(t.stop().animate({top:-1*t.height()},100,function(){t.remove()}),this.$dialog=null,d(document).off("mousedown.shifterdialog."+this.id))},destroyed:function(){return!this.$dialog},saveLastQuery:function(t){n.setItem("JIRA.Shifter.lastQuery",t)},getLastQuery:function(){return n.getItem("JIRA.Shifter.lastQuery")},enterLoadingState:function(){var t=this.$dialog;t.addClass("loading-action"),t.find(".aui-list").slideUp(200)},_render:function(){var e=JIRA.Templates.Shifter.dialog({id:this.id}),i=this.$dialog=d(e).appendTo("body"),n=this.shifterSelect=new s({id:this.id,element:i.find(".aui-list"),groups:this.groups,suggestionsHandler:this._makeSuggestionsHandler(),onSelection:u.bind(this._onSelection,this),maxResultsDisplayedPerGroup:this.options.maxResultsDisplayedPerGroup});this.getLastQuery()&&(n.$field.val(this.getLastQuery()).select(),n.onEdit()),n.$field.on("keyup",u.bind(function(e){e.which===t.ESCAPE&&(e.stopPropagation(),this.destroy())},this)),AJS.currentLayerItem&&AJS.currentLayerItem.hide&&AJS.currentLayerItem.hide(),this._closeDropdownsIfNeeded(),i.css("top",-1*i.height()).animate({top:0},100)},_closeDropdownsIfNeeded:function(){d(".aui-dropdown2-trigger.active").trigger("aui-button-invoke")},_destroyOnBlur:function(){this.$dialog.find("input").blur(u.bind(function(){setTimeout(u.bind(function(){this.$dialog&&!d.contains(this.$dialog[0],document.activeElement)&&this.destroy()},this),this.BLUR_DELAY)},this))},_destroyOnMousedownOutside:function(t){0===this.$dialog.find(t.target).length&&t.target!==this.$dialog&&this.destroy()},_preventFocusOnNonInputElements:function(){var t=this.$dialog.find("input");this.$dialog.mousedown(function(e){-1===d.inArray(e.target,t)&&e.preventDefault()})},_makeSuggestionsHandler:function(){var t=this.groups;return i.extend({execute:function(i){var n=[],s=e(),a=t.length;return u.map(t,function(t,e){return t.getSuggestions(i).done(function(i){u.isArray(i)&&(n.push(new o({label:t.name,description:t.context,weight:t.weight,items:u.map(i,function(t){return r.createItemDescriptor(t,e)})})),n.sort(function(t,e){return t.weight()-e.weight()}))}).always(function(){0===--a&&s.resolve(n,i)})}),s}})},_onSelection:function(t,e,i){a.selection(i,e,t.id),this.saveLastQuery(i);var n=t.onSelection(e,i);n&&u.isFunction(n.always)?(this.enterLoadingState(),n.always(u.bind(this.destroy,this))):this.destroy()}})}),AJS.namespace("JIRA.ShifterComponent.ShifterDialog",null,require("jira/shifter/shifter-dialog"));