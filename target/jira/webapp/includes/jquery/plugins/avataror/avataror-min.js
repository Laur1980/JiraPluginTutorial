jQuery.fn.avataror=function(i){var e=jQuery,t=e(document);this.each(function(){var r=e(this),a=r.find("img").attr("src");r.css({"-moz-border-radius":"10px","-webkit-border-radius":"10px"}),r.html("<p>Loading?</p>");var g={previewSize:48};g.preview=e("<div/>").addClass("avataror-preview").css({border:"solid 1px #000",float:"left",height:g.previewSize+"px",overflow:"hidden",width:g.previewSize+"px",position:"relative",top:"-9999em",left:"-9999em"}),g.preview.prependTo(i.previewElement),g.img=e('<img alt="Avatar Source"/>'),g.img.load(function(){g.image=e("<div/>").css({background:"url('"+a+"') no-repeat",clear:"left",position:"relative"}),g.marker=e("<div/>").css({cursor:"move",position:"relative"}),g.dash=e("<div/>"),g.shadow=e("<div/>"),g.dash.add(g.shadow).css({cursor:"move",opacity:.5,left:0,top:0,position:"absolute"}),g.image.append(g.shadow).append(g.dash).append(g.marker),r.append(g.image),g.marker.html("<div></div><div></div><div></div><div></div>"),e("div",g.marker).each(function(i){var t=e(this);t.css({background:"#000",border:"solid 1px #fff",width:"10px",height:"10px",position:"absolute","font-size":"1px"}),t.css(["left","right","right","left"][i],"-6px"),t.css(["top","top","bottom","bottom"][i],"-6px"),t.css("cursor",["nw-resize","ne-resize","se-resize","sw-resize"][i]),t.mousedown(function(e){e.preventDefault(),e.stopPropagation(),g.dragging={x:e.pageX,y:e.pageY,ax:g.x,ay:g.y,w:g.width,h:g.height,i:i+1},g.shadow.hide()})}),g.marker.add(g.image).mousedown(function(i){i.preventDefault(),g.dragging={x:i.pageX,y:i.pageY,ax:g.x,ay:g.y,w:g.width,h:g.height},g.shadow.hide()}),t.mouseup(function(i){g.handleMouseUp(i)}),t.mousemove(function(i){g.dragging&&(g.handleMouseMove(i.pageX,i.pageY),i.preventDefault())}),g.imgwidth=g.img[0].naturalWidth,g.imgheight=g.img[0].naturalHeight,g.x=parseInt(e("#avatar-offsetX").val()),g.y=parseInt(e("#avatar-offsetY").val()),g.width=parseInt(e("#avatar-width").val()),g.height=g.width,g.image.css({width:g.imgwidth+"px",height:g.imgheight+"px"}),g.setMarker(),r.css({width:g.imgwidth+"px"}),g.preview.css({position:"static"}),e("p",r).remove(),r.trigger("AvatarImageLoaded"),g.adjustPreview()}),g.img.attr("src",a),g.preview.append(g.img),g.setMarker=function(){g.marker.css("border","dashed 1px #fff"),g.dash.css("border","solid 1px #000"),g.shadow.css("border","solid 1px #000"),g.marker.add(this.dash).css("left",this.x-1+"px"),g.marker.add(g.dash).css("top",g.y-1+"px"),g.shadow.css("border-left-width",g.x+"px"),g.shadow.css("border-right-width",g.imgwidth-g.x-g.width+"px"),g.shadow.css("border-top-width",g.y+"px"),g.shadow.css("border-bottom-width",g.imgheight-g.y-g.height+"px"),g.shadow.css("width",g.width+"px"),g.shadow.css("height",g.height+"px"),g.marker.add(g.dash).css("width",g.width+"px"),g.marker.add(g.dash).css("height",g.height+"px")},g.adjustPreview=function(){g.img.attr("width",g.imgwidth*g.previewSize/g.width),g.img.attr("height",g.imgheight*g.previewSize/g.height),g.img.css("margin-left","-"+g.x*g.previewSize/g.width+"px"),g.img.css("margin-top","-"+g.y*g.previewSize/g.height+"px"),g.preview.select()},g.handleMouseMove=function(i,e){if(g.dragging.nextExec=g.dragging.nextExec||0,0!=g.dragging.nextExec)return void g.dragging.nextExec--;g.dragging.nextExec=3;var t=i-g.dragging.x,r=e-g.dragging.y;if(this.dragging.i){(0,g.resizeHandlers[this.dragging.i-1])(t,r)}else g.x=g.dragging.ax+t,g.y=g.dragging.ay+r,g.x+g.width>g.imgwidth&&(g.x=g.imgwidth-g.width),g.y+g.height>g.imgheight&&(g.y=g.imgheight-g.height),g.x<0&&(g.x=0),g.y<0&&(g.y=0);g.setMarker(),g.adjustPreview()},g.handleMouseUp=function(i){e("#avatar-offsetX").val(g.x),e("#avatar-offsetY").val(g.y),e("#avatar-width").val(g.width),g.dragging=null,g.shadow.show()},g.originX=function(){return g.dragging.ax},g.originY=function(){return g.dragging.ay},g.originBottomX=function(){return g.dragging.ax+g.dragging.w},g.originBottomY=function(){return g.dragging.ay+g.dragging.h},g.originNw=function(){return{x:g.originX(),y:g.originY()}},g.originNe=function(){return{x:g.originBottomX(),y:g.originY()}},g.originSe=function(){return{x:g.originBottomX(),y:g.originBottomY()}},g.originSw=function(){return{x:g.originX(),y:g.originBottomY()}},g.nwHandler=function(i,e){var t=g.originSe(),r={x:g.originX()+i,y:g.originY()+e},a=Math.abs(r.x-t.x),o=Math.abs(r.y-t.y),n=Math.min(a,o);n<20&&(n=20),t.x-n<0&&(n=t.x),t.y-n<0&&(n=t.y),g.x=t.x-n,g.y=t.y-n,g.width=g.height=n},g.neHandler=function(i,e){var t=g.originSw(),r={x:g.originBottomX()+i,y:g.originY()+e},a=Math.abs(r.x-t.x),o=Math.abs(r.y-t.y),n=Math.min(a,o);n<20&&(n=20),t.x+n>g.imgwidth&&(n=g.imgwidth-t.x),t.y-n<0&&(n=t.y),g.y=t.y-n,g.width=g.height=n},g.seHandler=function(i,e){var t=g.originNw(),r={x:g.originBottomX()+i,y:g.originBottomY()+e},a=Math.abs(r.x-t.x),o=Math.abs(r.y-t.y),n=Math.min(a,o);n<20&&(n=20),t.x+n>g.imgwidth&&(n=g.imgwidth-t.x),t.y+n>g.imgheight&&(n=g.imgheight-t.y),g.width=g.height=n},g.swHandler=function(i,e){var t=g.originNe(),r={x:g.originX()+i,y:g.originBottomY()+e},a=Math.abs(r.x-t.x),o=Math.abs(r.y-t.y),n=Math.min(a,o);n<20&&(n=20),t.x-n<0&&(n=t.x),t.y+n>g.imgheight&&(n=g.imgheight-t.y),g.x=t.x-n,g.width=g.height=n},g.resizeHandlers=[g.nwHandler,g.neHandler,g.seHandler,g.swHandler]})};